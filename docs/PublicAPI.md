# pzpr.js API

pzpr.js can be used under either browser environment or node.js.

## usage

on browser

```html
<!DOCTYPE html>
<html>
<head>
  <script src='path/to/pzpr.js'></script>
  <script>
  var puzzle;
  pzpr.on('load', function(){
    puzzle = new pzpr.Puzzle(document.getElementById('puzzlecanvas'), {type:'player'});
    puzzle.open('nurikabe/5/5/g5k2o1k3g');
  });
  </script>
</head>
<body>
  <div id="puzzlecanvas" style="width:200px;height:200px;"></div>
  <input type="button" value="Check" onclick="alert(puzzle.check(true).text);"></input>
  <input type="button" value="Clear" onclick="puzzle.ansclear();"></input>
</body>
</html>
```

on node.js

```js
var pzpr = require('pzpr');
var puzzle = new pzpr.Puzzle({type:'player'}).open('nurikabe/5/5/g5k2o1k3g');

puzzle.mouse.inputPath(3,3, 3,9, 1,9, 5,9);
puzzle.mouse.inputPath(5,1, 9,1, 9,5, 5,5, 7,7);
console.log(puzzle.check().text);
// -> 'Complete!'
```

## pzpr object

#### Methods

* `pzpr.on(eventtype, listener)` Register event listener to pzpr object.
    * `eventtype:string` Event type. Currently it only accepts `'load'`.
    * `listener:function` Function to be called.
* `pzpr.connectKeyEvents(puzzle)` Pass document keydown and keyup event to the given puzzle.

#### Events

* `'load'` Fire if pzpr object become ready. If this event is registered after pzpr is loaded, the listener will be executed immediately.

#### Properties

* `lang:string` Specific the language of pzpr.js. This value will be used for answer check. Possible value: `'en'` or `'ja'`.  Default value depends on browser or node.js env language.
* `version:string` Indicate pzpr.js version.

## class pzpr.Puzzle

#### Constructor

* `pzpr.Puzzle([canvas][,option])` Create puzzle object.
    * `canvas:Node` The canvas of the puzzle.
    * `option:object` See below.
    * `option.type:string`     Select puzzle object type.
        * `option.type==='editor'` **Default value.** The puzzle can be inputted question data and answer data.
        * `option.type==='player'` The puzzle can be only taken answer data.
        * `option.type==='viewer'` The puzzle can display the puzzle but reject any input.
    * `option.config:object`   Input initial config data as a object. See pzpr.Puzzle.Config section.
    * `option.graphic:string`  Specify graphic type. It can be `'svg'` or `'canvas'`.
    * `option.width:number` and `option.height:number` Specify the size of the canvas.
    * `option.cellsize:number` Specify the size of the canvas by the cellsize of the board.

If neither width, height nor cellsize is given, the size of given canvas element is used for the size of puzzle.

#### Methods for open/save puzzles

* `puzzle.open(data[, variety][, callback])` Open the specific URL/file data.
    * This API can be also used for opening new empty board as `'(pid)/cols/rows'` format, like `puzzle.open('nurikabe/5/5')`.
    * Return value: `puzzle object itself`
    * `data:string` Data to be opened.
    * `data:URLData or FileData` Data can be a `URLData` or `FileData` object generated by `pzpr.parser.parse` function.
    * `pid:string` Predefined puzzle veriety name.
    * `callback:function` It will be called after opening operation finishs and `ready` event fired.
* `puzzle.getURL([urltype])` Return URL of the board.
    * Return value: Generated URL string.
    * `urltype:URLType` Specify URL type.
* `puzzle.getFileData([filetype[, option]])` Return File Data of the board.
    * Return value: Generated File data.
    * `filetype:FileType` Specify URL type.
    * `option.history:boolean` If filetype is FILE_PZPR and it is true, operation history will be outputted.
* `puzzle.clone([option])` Return cloned puzzle object from the puzzle.
    * Return value: cloned puzzle object.
    * `option.type:string` It means the same as option.type in constructor. If not specified, the type of the puzzle will be used.
    * `option.width:number` and `option.height:number` Set the size of the canvas of cloned puzzle object. If not specified, the size of current canvas will be used.

#### Methods for events

* `puzzle.on(eventtype, listener)` Register event listener to pzpr object.
* `puzzle.once(eventtype, listener)` Register once event listener to pzpr object.
    * `eventtype:string` Event type. See event section below.
    * `listener:function` Function to be called.

#### Methods for configuration

* `puzzle.modechange([type])` It changes the puzzle into playmode or editmode when the puzzle type is 'editor'.
    * `type` If `puzzle.MODE_PLAYER` or `'play'`, it will change the puzzle mode to `playmode`. <br> Otherwise `puzzle.MODE_EDITOR` or `'edit'`, puzzle mode will change into `editmode`. <br> If no argument is given, it will toggle the mode.
* `puzzle.getConfig(configname)` Get the value of the config data. See below to get the list of the config.
    * Return value: the value of the specified config.
    * `configname:string` the id name of the config. See `pzpr.Puzzle.Config class` secrion.
* `puzzle.setConfig(configname, value)` Set the config data to the given value.
    * `configname:string` the id name of the config. See `pzpr.Puzzle.Config class` secrion.
    * `value` value to be set. Type is either `string`, `number` or `boolean`.
* `puzzle.getCurrentConfig()` Return the list of the config values for current puzzle variety.
    * Return value: `object`.
* `puzzle.saveConfig()` Return current changed config list from default value as object.
    * Return value: `object`.
* `puzzle.restoreConfig([object])` Set config list by given object. 
    * `object:object` the list of the config to be restored. Usually this is the object which `puzzle.saveConfig()` returned.

#### Methods for canvas

* `puzzle.setCanvas(canvas[, graphictype])` Set the canvas element after the puzzle object created.
    * `canvas:Node` The canvas of the puzzle.
    * `graphictype:string` Graphic type used for the canvas. `'svg'` or `'canvas'`.
* `puzzle.setCanvasSize(width, height)` Set the canvas of the canvas.
* `puzzle.setCanvasSizeByCellSize(cellsize)` Set the canvas of the canvas by the cellsize of the board.
* `puzzle.redraw([flush])` Redraw the whole canvas.
    * `flush:boolean` If `true`, it will destroy all cached data and redraw, otherwise cached data will be kept.
* `puzzle.irowake()` Regenerate the color of the line if config.irowake (set individual color to line) is set.
* `puzzle.toDataURL([cellsize][, graphictype])` Return the canvas graphic data as Data URL.
    * Return value: Generated Data URL.
* `puzzle.toBlob([cellsize][, graphictype])` Return the canvas graphic data as Blob.
    * Return value: Blob data. This API can be used undef browser environment.
* `puzzle.toSVG([cellsize][, graphictype])` Return raw SVG data of the canvas as string.
    * Return value: Generated text which means SVG.

#### Methods for the board model

* `puzzle.check([activemode])` Check if the board is modified or not.
    * Return value: `CheckInfo` which contains if the check succeed or not and failure information.
        * `info.complete` `true` if the answer is correct.
        * `info.text` contains error description unless `activemode===false`.
        * `info.gettext(['en' or 'ja'])` method gets error description in English or Japanese.
    * `activemode:boolean`
        * If `true`, checking answer routine will set error information and display what has error.
        * If `false`, it will only check errors, ignore `'multierr'` config and `info.text` remains empty.
        * Otherwise, it will only check errors but respect `'multierr'` config and set `info.text`.
* `puzzle.ansclear()` Clear answer data on the board but it preserves operation history data.
* `puzzle.subclear()` Clear auxiliary marks on the board.
* `puzzle.errclear()` Wipe out the error information given after check() is called.
* `puzzle.clear()` For `'editor'` type puzzle, clean all board data. As for `'player'` type puzzle, it clears answer data. In addition, it clears operation history data for both `'editor'` and `'player'`.
* `puzzle.undo()` Undo an operation.
    * Return value: `true` if it is the first operation.
* `puzzle.redo()` Redo an operation.
    * Return value: `true` if it is the last operation.
* `puzzle.undoall()` Undo all recorded operations. No return value.
* `puzzle.redoall()` Redo all recorded operations. No return value.
* `puzzle.ismodified()` Check if the board is modified or not.
    * Return value: `true` when the puzzle is modified and the puzzle type is 'editor'.

#### Methods for general purpose

* `puzzle.getTime()` Return consumed time from the puzzle data is created or URL/filedata is opened.
    * Return value: consumed time millisecond.

#### Events

* `'ready'` Emitted after `puzzle.open` finished successfully.
    * Callback: `function(puzzle)`
* `'fail-open'` Emitted if `puzzle.open` failed.
    * Callback: `function(puzzle)`
* `'canvasReady'` Emitted after `puzzle.setCanvas()` or `new pzpr.Puzzle(canvas)` finished.
    * Callback: `function(puzzle)`
* `'resize'` Emitted if the size of the canvas is changed.
    * Callback: `function(puzzle)`
* `'adjust'` Emitted after the size of the board is expanded, reduced or the board is flipped or turned.
    * Callback: `function(puzzle)`
* `'config'` Emitted after a config has changed.
    * Callback: `function(puzzle, configname, value)`
* `'key'` Emitted if keyboard event routine of the puzzle is called, before common routine is called.
    * Callback: `function(puzzle, keycode)`
* `'mouse'` Emitted if mouse/touch event routine of the puzzle is called, before common routine is called.
    * Callback: `function(puzzle)`
* `'history'` Emitted after operation history is added or execute undo/redo.
    * Callback: `function(puzzle)`

#### Properties

* `puzzle.ready:boolean` `true` after the URL/FileData is opened and board, painter and other related objects are set.
* `puzzle.pid:string` specifies the variety/genre of the current puzzle.
* `puzzle.canvas:Node` The node currently the puzzle has been using.
* `puzzle.editmode:boolean` `true` if the puzzle is inputting question data at the moment.
* `puzzle.playmode:boolean` `true` if the puzzle is inputting answer data at the moment.

For `editmode` or `playmode` property, one is `true` and the other is `false`.

#### Sub-Objects

* `puzzle.board:Board` Contains board data.
    * `puzzle.board.operate([operation])` Execute the size of the board expanding, reducing or flipping or turning the board.
        * `operation==='flipy'` Flip the board up-size down.
        * `operation==='flipx'` Flip the board left-size right.
        * `operation==='turnr'` Turn right the board by 90 degree.
        * `operation==='turnl'` Turn left the board by 90 degree.
        * `operation==='expand(up|dn|lt|rt)'` Expand the board by a row.
        * `operation==='reduce(up|dn|lt|rt)'` Reduce the board by a row.
    * `puzzle.board.getc(bx,by)` Returns the `Cell` object at the coordinate `(bx,by)`.
    * `puzzle.board.getb(bx,by)` Returns the `Border` object at the coordinate `(bx,by)`.
    * `puzzle.board.getx(bx,by)` Returns the `Cross` object at the coordinate `(bx,by)`.
    * `puzzle.board.getex(bx,by)` Returns the `Excell` object at the coordinate `(bx,by)`.
* `puzzle.opemgr:OperationManager` Contains operation history data.
* `puzzle.checker:Answer` Check if the board is correct.
* `puzzle.key:KeyInput` Used if keyboard event occured.
    * `puzzle.key.cancelEvent:boolean` Cancel mouse event from `key` listener.
    * `puzzle.key.keydown:boolean` `true` if kwydown event is detected.
    * `puzzle.key.keyup:boolean` `true` if keyup event is detected.
    * `puzzle.key.isCTRL:boolean` `true` if `Ctrl` key is being pressing.
    * `puzzle.key.isMETA:boolean` `true` if `Meta/Command` key is being pressing.
    * `puzzle.key.isALT:boolean` `true` if `Alt` key is being pressing.
    * `puzzle.key.isSHIFT:boolean` `true` if `Shift` key is being pressing.
    * `puzzle.key.isZ:boolean` `true` if `Z` key is being pressing.
    * `puzzle.key.isX:boolean` `true` if `X` key is being pressing.
    * `puzzle.key.isY:boolean` `true` if `Y` key is being pressing.
* `puzzle.mouse:MouseInput` Used when mouse or touch event happened.
    * `puzzle.mouse.inputPath([button,]bx,by,...)` Input consequent mouse input path.
    * `puzzle.mouse.moveTo(bx,by)` Set the mouse position and emulate mousedown/touchstart event.
    * `puzzle.mouse.lineTo(bx,by)` Move the mouse position incrementally and emulate mousemove/touchmove event.
    * `puzzle.mouse.inputEnd()` Emulate mouseup/touchend event.
    * `puzzle.mouse.btn:string` Detected mouse button.
    * `puzzle.mouse.mousestart:boolean` `true` if mousedown/touchstart event is detected.
    * `puzzle.mouse.mousemove:boolean` `true` if mousemove/touchmove event is detected.
    * `puzzle.mouse.mouseend:boolean` `true` if mouseup/touchend event is detected.
    * `puzzle.mouse.cancelEvent:boolean` Cancel mouse event from `mouse` listener.
* `puzzle.cursor:TargetCursor` Contains current cursor position.

## class pzpr.Metadata

#### Properties

* `puzzle.metadata.author`
* `puzzle.metadata.source`
* `puzzle.metadata.hard`
* `puzzle.metadata.comment`

#### Methods

* `puzzle.metadata.update(metadata)` Update metadata of the puzzles.
* `puzzle.metadata.getvaliddata()` Get metadata without empty properties.
* `puzzle.metadata.reset()` Clear all metadata.
* `puzzle.metadata.update()` Return `true` if each metadata is empty.

## class pzpr.Puzzle.Config

#### The list of config for Graphic/Canvas

|Name|Type|Default value|Description|
|---|---|---|---|
|`font`|`number`|`1`|The font of the canvas.  <br> Possible value: `1: Serif, 2: Sans-serif`|
|`cursor`|`boolean`|`true`|Display the cursor on the canvas|
|`irowake`|`boolean`|`false`|Set individual color to lines|
|`irowakeblk`|`boolean`|`false`|Set individual color to mass of shaded cells (TBD)|
|`dispmove`|`boolean`|`true`|Display objects as if it is really moving for moving puzzles|
|`disptype_pipelinkr`|`number`|`1`|Ice/circle display type for `'Pipelink Returns'` <br> Possible value: `1 or 2`|
|`disptype_bosanowa`|`number`|`1`|Display type for `'Bosanova'` <br> Possible value: `1,2 or 3`|
|`snakebd`|`boolean`|`false`|Display the border between inside and outside the snake for `'Hebi-Ichigo'`|
|`squarecell`|`boolean`|`true`|Set cell on the board always square|
|`color_qanscolor`|`string`|''|Set the color of the shaded cells|

#### The list of config for input method

|Name|Type|Default value|Description|
|---|---|---|---|
|`use`|`number`|`1`|Input method for shaded cells from mouse <br> Possible value: `1 or 2`|
|`use_tri`|`number`|`1`|Input method for triangles from mouse for `'Shakashaka'` <br> Possible value: `1, 2 or 3`|
|`lecheck`|`boolean`|`false`|Invert mouse button's left and right|
|`bgcolor`|`boolean`|`false`|Enable to input background color|
|`dirauxmark`|`boolean`|`true`|Enable to input direction auxiliary marks for `'Nagareru-loop'`|
|`enline`|`boolean`|`true`|Limit to input segments only between points for `'Kouchoku'`|
|`lattice`|`boolean`|`true`|Restrict not to input segments if other points are on the lattice for `'Kouchoku'`|
|`redline`|`boolean`|`false`|Display continuous lines if the player clicks|
|`redblk`|`boolean`|`false`|Display continuous shaded cells if the player clicks|
|`redroad`|`boolean`|`false`|Display continuous road if the player clicks for `'Roma'`|

#### The list of config for answer check

|Name|Type|Default value|Description|
|---|---|---|---|
|`autocmp`|`boolean`|`false`|Show complete blocks/numbers apart from incompleted one automatically.|
|`autoerr`|`boolean`|`false`|Show incomplete/wrong numbers automatically.|
|`multierr`|`boolean`|`false`|Check prural errors in `puzzle.check()` API.|
|`allowempty`|`boolean`|`false`|Ignore 'No lines/blocks on the board' error.|

#### The list of miscellaneous config

|Name|Type|Default value|Description|
|---|---|---|---|
|`bdpadding`|`boolean`|`true`|Output URL with one row padding for `'Goishi'`.|
|`discolor`|`boolean`|`false`|Disable setting color for `'Tentai-show'`.|
|`mode`|`number`||Indicate editmode(1) or playmode(3).|
|`uramashu`|`boolean`|`false`|Ura-masyu mode.|

## pzpr.parser object

#### Methods

* `pzpr.parser.parse(data[, pid])` Parse given data then return parsed `URLData` or `FileData`.
    * Return value: `URLData or FileData`
    * `data:string` Data to be parsed.
    * `pid:string` Predefined puzzle veriety name.

### pzpr.parser.URLData class

#### Properties

* `pid:string`  Parsed puzzle variety/genre.
* `type:URLType`  Parsed URL type. See below
* `rows:number`  The number of rows of the board.
* `cols:number`  The number of cols of the board.
* `pflag:string`  Extra flag in given URL.
* `body:string`  Data in the URL other than type, rows, cols and pflag.
* `isurl:boolean` `true`

### pzpr.parser.FileData class

#### Propertes

* `pid:string` Parsed puzzle variety/genre.
* `type:FileType` Parsed File data type. See below.
* `rows:number` The number of rows of the board.
* `cols:number` The number of cols of the board.
* `metadata:pzpr.Metadata` Author, source, difficulty and comment properies.
* `history:HistoryData` History data in the file data, available if exists.
* `body:string` Data in the URL other than type, rows, cols and pflag.
* `isfile:boolean` `true`

### pzpr.parser URLType definition

These values are defined under pzpr.parser.

#### Const values

* `URL_AUTO` Undefined URL type.
* `URL_PZPRV3` PUZ-PRE v3 URL type.
* `URL_PZPRV3E` PUZ-PRE v3 URL with opening editmode type.
* `URL_PZPRAPP` PUZ-PRE Applet URL type.
* `URL_KANPEN` Kanpen URL type.
* `URL_KANPENP` Kanpen with PUZ-PRE data URL type.
* `URL_HEYAAPP` Heyawaek Applet URL type.

### pzpr.parser FileType definition

These values are defined under pzpr.parser.

#### Const values

* `FILE_AUTO` Undefined file type.
* `FILE_PZPR` pzpr.js file type.
* `FILE_PBOX` pencilbox (text) file type.
* `FILE_PBOX_XML` pencilbox (XML) file type.

## pzpr.variety object

This object contains each puzzle variety/genre information.

#### Methods

* `pzpr.variety.exists(pid)` Return if puzzle variety is supported.
    * Return value: `boolean`
    * `pid:string` Puzzle variety type.
