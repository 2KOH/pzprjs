/* 
 * pzprBase.js
 * 
 * pzprBase.js is a base script for playing nikoli puzzles on Web
 * written in JavaScript.
 * 
 * @author  dk22
 * @version v3.3.4
 * @date    2011-06-11
 * 
 * This script is licensed under the MIT license. See below,
 * http://www.opensource.org/licenses/mit-license.php
 * 
 */
var pzprversion="v3.3.4";(function(){if(!!window.Camp){return}var r=this,aA=document,ap=Math.sin,az=Math.cos,W=2*Math.PI,ay=!!(window.attachEvent&&!window.opera),V=10,t=V/2,d=[],A={debugmode:false},ae=["svg","canvas","sl","flash","vml"],a=0,M=0,f=1,ag=2,s=3,aG=4,v="BeforeEnd";var y=(function(){var Z=[];for(var i=256;i<512;i++){Z[i-256]=i.toString(16).substr(1)}return Z})();function aB(i){return{width:(i.offsetWidth||i.clientWidth),height:(i.offsetHeight||i.clientHeight)}}function I(Z){if(!d[Z]){if(Z.substr(0,4)==="rgb("){var i=Z.match(/\d+/g);d[Z]=["#",y[i[0]],y[i[1]],y[i[2]]].join("")}else{d[Z]=Z}}return d[Z]}function J(aP){if(aP.match(/\#([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])([0-9a-f][0-9a-f])/)){var aO=parseInt(RegExp.$1,16).toString();var Z=parseInt(RegExp.$2,16).toString();var i=parseInt(RegExp.$3,16).toString();return["rgb(",aO,",",Z,",",i,")"].join("")}return aP}function an(aO,Z){for(var i in Z){aO[i]=Z[i]}}var S=function(){this.canvas=false;this.vml=false;this.svg=false;this.sl=false;this.flash=false};var aD="<v:shape",h="<v:group",H="<v:image",au="<v:textpath",aI="<v:polyline",aC='<v:path textpathok="t" />',aJ="",am=">",ao=" />",al="</v:shape>",aH="</v:group>",x="</v:image>",n="</v:textpath>",z="</v:polyline>",Y=' id="',ah=' path="',j=' points="',ax=' style="',b=' string="',aa=' coordsize="100,100"',U=' fillcolor="',B=' strokecolor="',o=' strokeweight="',aj='"',ar=' style="white-space:nowrap;cursor:default;font:10px sans-serif;"',aw=' stroked="f" filled="t"',ai=' on="t" xscale="t"',C="left:",aF="top:",T="font:",ak="v-text-align:",ab=";",ac=" m",e=" l",p=" x",c=" ns",G=" nf",aL={top:-0.7,hanging:-0.66,middle:-0.3,alphabetic:0,bottom:0.1};var D="http://www.w3.org/2000/svg",aN="http://www.w3.org/1999/xlink",Q=" M",aK=" L",l=" A",K=" z",q="id",aq="fill",af="stroke",E="stroke-width",m="shape-rendering",X="none",R={left:"start",center:"middle",right:"end"},ad={top:-0.7,hanging:-0.66,middle:-0.3,alphabetic:0,bottom:0.1},F={left:0,center:0.5,right:1},w={top:0.2,hanging:0.2,middle:0.5,alphabetic:0.7,bottom:0.8},aM="canvas_o_",u=null,L="";function aE(){u=aA.createElement("div");u.style.display="inline";u.style.position="absolute";u.style.left="-9000px";u.innerHTML="";aA.body.appendChild(u);N.ME=u}var at=function(Z,i){this.fillStyle="black";this.strokeStyle="black";this.lineWidth=1;this.font="14px system";this.textAlign="center";this.textBaseline="middle";this.canvas=null;this.x0=0;this.y0=0;this.vid="";this.elements=[];this.lastElement=null;this.type=Z;this.target=null;this.child=null;this.idname=i;this.canvasid=aM+i;this.cpath=[];this.lastpath="";this.currentLayerId="_empty";this.isedgearray={_empty:false};this.isedge=false;this.content=null;this.use=new S();if(this.type===f||this.type===s){this.PATH_MOVE=Q;this.PATH_LINE=aK;this.PATH_CLOSE=K;if(this.type===f){this.use.svg=true}if(this.type===s){this.use.sl=true}}else{if(this.type===M){this.PATH_MOVE=ac;this.PATH_LINE=e;this.PATH_CLOSE=p;this.use.vml=true}}this.initElement()};at.prototype={initElement:function(){var i=null;if(this.type!==s){i=aA.getElementById(this.canvasid)}else{if(!!this.content){i=this.content.findName(this.canvasid)}}if(!i){this.canvas=aA.getElementById(this.idname);if(this.type===f){this.appendSVG()}else{if(this.type===s){this.appendSL()}else{if(this.type===M){this.appendVML()}}}if(this.type!==s){this.afterInit()}}else{this.target=i}},afterInit:function(){var Z=this.canvas;var aP=this.child;var aO=aB(Z);var i=this;Z.style.display="block";Z.style.position="relative";Z.style.overflow="hidden";if(A.debugmode){Z.style.backgroundColor="#efefef";Z.style.border="solid 1px silver"}Z.getContext=function(aQ){return i};Z.toDataURL=function(aQ){return null};this.target=this.child;this.rect(0,0,aO.width,aO.height);this.addVectorElement(false,false);a--},appendSVG:function(){var i=aB(this.canvas);var Z=aA.createElementNS(D,"svg");Z.setAttribute("id",this.canvasid);Z.setAttribute("font-size","10px");Z.setAttribute("font-family","sans-serif");Z.setAttribute("width",i.width);Z.setAttribute("height",i.height);Z.setAttribute("viewBox",[0,0,i.width,i.height].join(" "));this.canvas.appendChild(Z);this.child=Z},appendVML:function(){var i=aB(this.canvas);var Z=aA.createElement("div");Z.id=this.canvasid;Z.style.position="absolute";Z.style.left="-2px";Z.style.top="-2px";Z.style.width=i.width+"px";Z.style.height=i.height+"px";this.canvas.appendChild(Z);this.child=Z},appendSL:function(){var Z=this,i="_function_"+this.canvasid+"_onload";r[i]=function(aP,aO,aQ){Z.content=document.getElementById([Z.canvasid,"object"].join("_")).content;Z.child=Z.content.findName(Z.canvasid);Z.afterInit.call(Z)};this.canvas.innerHTML=['<object type="application/x-silverlight" width="100%" height="100%" id="',this.canvasid,'_object" />','<param name="windowless" value="true" />','<param name="background" value="#00000000" />','<param name="source" value="#',this.canvasid,'_script" />','<param name="onLoad" value="',i,'" />',"</object>",'<script type="text/xaml" id="',this.canvasid,'_script">','<Canvas xmlns="http://schemas.microsoft.com/client/2007" Name="',this.canvasid,'" />',"<\/script>"].join("")},setLayer:function(aO){this.initElement();if(!!aO){var Z=[this.canvasid,"layer",aO].join("_");var i=(this.type!==s?aA.getElementById(Z):this.content.findName(Z));if(!i){if(this.type===f){i=aA.createElementNS(D,"g");i.setAttribute("id",Z);this.target.appendChild(i)}else{if(this.type===s){i=this.content.createFromXaml(['<Canvas Name="',Z,'"/>'].join(""));this.target.children.add(i)}else{i=aA.createElement("div");i.id=Z;i.unselectable=(!!aJ?"on":"");i.style.position="absolute";i.style.left="0px";i.style.top="0px";this.target.appendChild(i)}}}this.target=i}this.currentLayerId=(!!aO?aO:"_empty");if(this.type!==f){if(this.isedgearray[this.currentLayerId]===void 0){this.isedgearray[this.currentLayerId]=false}this.isedge=this.isedgearray[this.currentLayerId]}},setRendering:function(i){if(this.type===f){this.target.setAttribute(m,i)}else{this.isedgearray[this.currentLayerId]=(i==="crispEdges");this.isedge=this.isedgearray[this.currentLayerId]}},setUnselectable:function(i){if(i===(void 0)){i=true}else{i=!!i}if(this.type===M){aJ=(i?' unselectable="on"':"");this.canvas.unselectable=(i?"on":"");this.child.unselectable=(i?"on":"")}else{if(this.type===s){this.canvas.unselectable=(i?"on":"")}else{if(this.type===f){this.canvas.style.MozUserSelect=(i?"none":"text");this.canvas.style.WebkitUserSelect=(i?"none":"text");this.canvas.style.userSelect=(i?"none":"text")}}}},getContextElement:function(){return this.child},getLayerElement:function(){return this.target},changeSize:function(aO,Z){this.canvas.style.width=aO+"px";this.canvas.style.height=Z+"px";var aP=this.canvas.firstChild;if(this.type===f){aP.setAttribute("width",aO);aP.setAttribute("height",Z);var i=aP.getAttribute("viewBox").split(/ /);aP.setAttribute("viewBox",[i[0],i[1],aO,Z].join(" "))}else{if(this.type==s){aP.height=(Z+1)+"px";aP.width=aO+"px";aP.height=Z+"px"}else{if(this.type==M){aP.style.width=aO+"px";aP.style.height=Z+"px"}}}},clear:function(){if(this.type===f||this.type===M){var Z=this.canvas.firstChild,i=Z.firstChild;while(!!i){Z.removeChild(i);i=Z.firstChild}}else{if(this.type===s){this.content.findName(this.canvasid).children.clear()}}this.vid="";this.elements=[];this.lastElement=null;this.initElement()},beginPath:function(){this.cpath=[];this.lastpath=""},closePath:function(){this.cpath.push(this.PATH_CLOSE);this.lastpath=this.PATH_CLOSE},moveTo:function(i,Z){if(this.type===M){i=(i*V-t)|0;Z=(Z*V-t)|0}else{if(this.type===s){i=(this.isedge?(i+this.x0+0.5)|0:i+this.x0);Z=(this.isedge?(Z+this.y0+0.5)|0:Z+this.y0)}}this.cpath.push(this.PATH_MOVE,i,Z);this.lastpath=this.PATH_MOVE},lineTo:function(i,Z){if(this.lastpath!==this.PATH_LINE){this.cpath.push(this.PATH_LINE)}if(this.type===M){i=(i*V-t)|0;Z=(Z*V-t)|0}else{if(this.type===s){i=(this.isedge?(i+this.x0+0.5)|0:i+this.x0);Z=(this.isedge?(Z+this.y0+0.5)|0:Z+this.y0)}}this.cpath.push(i,Z);this.lastpath=this.PATH_LINE},rect:function(i,aP,Z,aO){if(this.type===M){i=(i*V-t)|0;aP=(aP*V-t)|0,Z=(Z*V)|0,aO=(aO*V)|0}else{if(this.type===s){i=(this.isedge?(i+this.x0+0.5)|0:i+this.x0);aP=(this.isedge?(aP+this.y0+0.5)|0:aP+this.y0);Z=(this.isedge?(Z+0.5)|0:Z);aO=(this.isedge?(aO+0.5)|0:aO)}}this.cpath.push(this.PATH_MOVE,i,aP,this.PATH_LINE,(i+Z),aP,(i+Z),(aP+aO),i,(aP+aO),this.PATH_CLOSE)},arc:function(aQ,aP,i,aS,Z,aX){if(this.type===s){aQ=(this.isedge?(aQ+this.x0+0.5)|0:aQ+this.x0);aP=(this.isedge?(aP+this.y0+0.5)|0:aP+this.y0)}var aW,aV,aU,aT;if(Z-aS>=W){aW=aQ+i,aV=aP,aU=aQ+i,aT=aP}else{aW=aQ+i*az(aS),aV=aP+i*ap(aS),aU=aQ+i*az(Z),aT=aP+i*ap(Z)}if(this.type===M){aQ=(aQ*V-t)|0,aP=(aP*V-t)|0,i=(i*V)|0;aW=(aW*V-t)|0,aV=(aV*V-t)|0,aU=(aU*V-t)|0,aT=(aT*V-t)|0;var aO=(aX?"at":"wa");if(Z-aS>=W){aW+=1}this.cpath.push(aO,(aQ-i),(aP-i),(aQ+i),(aP+i),aW,aV,aU,aT);this.lastpath=aO}else{if(Z-aS>=W){aV+=0.125}var aY=(aS>Z)^(Math.abs(Z-aS)>Math.PI);var aR=((aX^aY)?1:0),aZ=((aR==0^aY)?1:0);this.cpath.push(this.PATH_MOVE,aW,aV,l,i,i,0,aR,aZ,aU,aT);this.lastpath=l}},fill:function(){this.addVectorElement(true,false)},stroke:function(){this.addVectorElement(false,true)},fillRect:function(Z,aQ,aO,aP){var i=this.cpath;this.cpath=[];this.rect(Z,aQ,aO,aP);this.addVectorElement(true,false);this.cpath=i},strokeRect:function(Z,aQ,aO,aP){var i=this.cpath;this.cpath=[];this.rect(Z,aQ,aO,aP);this.addVectorElement(false,true);this.cpath=i},shapeRect:function(Z,aQ,aO,aP){var i=this.cpath;this.cpath=[];this.rect(Z,aQ,aO,aP);this.addVectorElement(true,true);this.cpath=i},fillText:function(Z,i,aO){if(this.type===f){this.fillText=this.fillText_SVG}else{if(this.type===s){this.fillText=this.fillText_SL}else{if(this.type===M){this.fillText=this.fillText_VML}}}this.fillText(Z,i,aO)},fillText_SVG:function(aQ,i,aR){var aP=(!!this.vid&&!!this.elements[this.vid]);u.style.font=this.font;u.innerHTML=aQ;var aO=aR-(u.offsetHeight*ad[this.textBaseline.toLowerCase()]);var Z=(aP?this.elements[this.vid]:aA.createElementNS(D,"text"));Z.setAttribute("x",i);Z.setAttribute("y",aO);Z.setAttribute(aq,I(this.fillStyle));Z.setAttribute("text-anchor",R[this.textAlign.toLowerCase()]);Z.style.font=this.font;if(!aP){Z.appendChild(aA.createTextNode(aQ));this.target.appendChild(Z);this.lastElement=Z}else{Z.replaceChild(aA.createTextNode(aQ),Z.firstChild)}if(!aP&&!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},fillText_SL:function(aT,aS,aR){var aQ=(!!this.vid&&!!this.elements[this.vid]);u.style.font=this.font;var i;if(!aQ){var aU=parseInt(this.canvas.offsetWidth);var Z=aS+this.x0-aU*F[this.textAlign.toLowerCase()];var aO=['<TextBlock Canvas.Left="',Z,'" Canvas.Top="',(aR+this.y0),'" Width="',aU,'" TextAlignment="',this.textAlign,'" Foreground="black" />'];i=this.content.createFromXaml(aO.join(""))}else{i=this.elements[this.vid]}i.Foreground=I(this.fillStyle);i.FontFamily=u.style.fontFamily.replace(/\"/g,"'");i.FontSize=parseInt(u.style.fontSize);i.Text=aT;var aP=i.ActualHeight*w[this.textBaseline.toLowerCase()];i["Canvas.Top"]=aR+this.y0-(!isNaN(aP)?aP:0);if(!aQ){this.target.children.add(i);this.lastElement=i}if(!aQ&&!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},fillText_VML:function(aT,aS,aQ){var aP=(!!this.vid&&!!this.elements[this.vid]);aS=(aS*V-t)|0,aQ=(aQ*V-t)|0;u.style.font=this.font;u.innerHTML=aT;var aR=aQ-((u.offsetHeight*aL[this.textBaseline.toLowerCase()])*V-t)|0;var aU=(u.offsetWidth*V-t)|0;var Z=aS-(aU*F[this.textAlign.toLowerCase()])|0;if(!aP){var aO=[h,aa,am,aI,j,[Z,aR,Z+aU,aR].join(","),aj,aw,U,I(this.fillStyle),aj,am,aC,au,ai,b,aT,aj,ax,T,this.font,ab,ak,this.textAlign,ab,aj,ao,z,aH];this.target.insertAdjacentHTML(v,aO.join(""));this.lastElement=this.target.lastChild.lastChild}else{var i=this.elements[this.vid];i.fillcolor=I(this.fillStyle);i.lastChild.style.font=this.font;i.lastChild.string=aT}if(!aP&&!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},drawImage:function(Z,aR,aQ,aS,aO,aU,aT,i,aP){if(this.type===f){this.drawImage=this.drawImage_SVG}else{if(this.type===s){this.drawImage=this.drawImage_SL}else{if(this.type===M){this.drawImage=this.drawImage_VML}}}this.drawImage(Z,aR,aQ,aS,aO,aU,aT,i,aP)},drawImage_SVG:function(aO,aU,aT,aV,aQ,aX,aW,i,aS){if(aV===(void 0)){aV=aO.width;aQ=aO.height}if(aX===(void 0)){aX=aU;aU=0;aW=aT;aT=0;i=aV;aS=aQ}var aR=(!!this.vid&&!!this.elements[this.vid]);var Z=(aR?this.elements[this.vid]:aA.createElementNS(D,"svg"));Z.setAttribute("viewBox",[aU,aT,aV,aQ].join(" "));Z.setAttribute("x",aX);Z.setAttribute("y",aW);Z.setAttribute("width",i);Z.setAttribute("height",aS);var aP=(aR?Z.firstChild:aA.createElementNS(D,"image"));aP.setAttributeNS(null,"width",aO.width);aP.setAttributeNS(null,"height",aO.height);aP.setAttributeNS(aN,"xlink:href",aO.src);if(!aR){Z.appendChild(aP);this.target.appendChild(Z);this.lastElement=Z}if(!aR&&!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},drawImage_SL:function(aP,aU,aT,aV,aQ,aX,aW,i,aS){if(aV===(void 0)){aV=aP.width;aQ=aP.height}if(aX===(void 0)){aX=aU;aU=0;aW=aT;aT=0;i=aV;aS=aQ}var aR=(!!this.vid&&!!this.elements[this.vid]);var Z;if(!aR){var aO=['<Image Source="',aP.src,'" />'];Z=this.content.createFromXaml(aO.join(""))}else{Z=this.elements[this.vid];Z.Source=aP.src}Z["Canvas.Left"]=aX-aU*(i/aV)+this.x0;Z["Canvas.Top"]=aW-aT*(aS/aQ)+this.y0;Z.Width=aP.width*(i/aV);Z.Height=aP.height*(aS/aQ);Z.Clip=this.content.createFromXaml(['<RectangleGeometry Rect="',aU*(i/aV),",",aT*(aS/aQ),",",i,",",aS,'" />'].join(""));if(!aR){this.target.children.add(Z);this.lastElement=Z}if(!aR&&!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},drawImage_VML:function(aP,aU,aT,aV,aQ,aX,aW,i,aS){if(aV===(void 0)){aV=aP.width;aQ=aP.height}if(aX===(void 0)){aX=aU;aU=0;aW=aT;aT=0;i=aV;aS=aQ}var aR=(!!this.vid&&!!this.elements[this.vid]);var Z;if(!aR){var aO=[H,' src="',aP.src,aj,aa,ao];this.target.insertAdjacentHTML(v,aO.join(""));this.lastElement=this.target.lastChild;Z=this.lastElement}else{Z=this.elements[this.vid];Z.src=aP.src}Z.style.left=aX;Z.style.top=aW;Z.style.width=i;Z.style.height=aS;Z.cropleft=aU/aP.width;Z.croptop=aT/aP.height;Z.cropright=(1-(aU+aV)/aP.width);Z.cropbottom=(1-(aT+aQ)/aP.height);if(!aR&&!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},translate:function(aO,Z){var aP=this.canvas.firstChild;if(this.type===f){var i=aP.getAttribute("viewBox").split(/ /);i[0]=-aO,i[1]=-Z;aP.setAttribute("viewBox",i.join(" "))}else{if(this.type===M){aP.style.position="absolute";aP.style.left=aO+"px";aP.style.top=Z+"px"}else{if(this.type===s){this.x0=aO;this.y0=Z}}}},shape:function(){this.addVectorElement(true,true)},setLinePath:function(){var aR=arguments,aQ=aR.length,aS=(this.type!==M);this.cpath=[];for(var aT=0,aO=aQ-((aQ|1)?1:2);aT<aO;aT+=2){if(aT==0){this.cpath.push(this.PATH_MOVE)}else{if(aT==2){this.cpath.push(this.PATH_LINE)}}var aP=aR[aT],Z=aR[aT+1];if(this.type===M){aP=(aP*V-t)|0,Z=(Z*V-t)|0}else{if(this.type===s){aP=(this.isedge?(aP+this.x0+0.5)|0:aP+this.x0);Z=(this.isedge?(Z+this.y0+0.5)|0:Z+this.y0)}}this.cpath.push(aP,Z)}if(aR[aQ-1]){this.cpath.push(this.PATH_CLOSE)}},setOffsetLinePath:function(){var aQ=arguments,aP=aQ.length,aR=(this.type!==M),aO=[aQ[0],aQ[1]];this.cpath=[];for(var aS=2,Z=aP-((aP|1)?1:2);aS<Z;aS+=2){aO[aS]=aQ[aS]+aO[0];aO[aS+1]=aQ[aS+1]+aO[1];if(this.type===M){aO[aS]=(aO[aS]*V-t)|0,aO[aS+1]=(aO[aS+1]*V-t)|0}else{if(this.type===s){aO[aS]=(this.isedge?(aO[aS]+this.x0+0.5)|0:aO[aS]+this.x0);aO[aS+1]=(this.isedge?(aO[aS+1]+this.y0+0.5)|0:aO[aS+1]+this.y0)}}}for(var aS=2,Z=aP-((aP|1)?1:2);aS<Z;aS+=2){if(aS==2){this.cpath.push(this.PATH_MOVE)}else{if(aS==4){this.cpath.push(this.PATH_LINE)}}this.cpath.push(aO[aS],aO[aS+1])}if(aQ[aP-1]){this.cpath.push(this.PATH_CLOSE)}},setDashSize:function(i){if(!this.lastElement){return}if(this.type===f){this.lastElement.setAttribute("stroke-dasharray",i)}else{if(this.type===s){this.lastElement.StrokeDashArray=""+i}else{if(this.type===M){var Z=aA.createElement("v:stroke");if(i<=2){Z.dashstyle="ShortDash"}else{if(i<=5){Z.dashstyle="Dash"}else{Z.dashstyle="LongDash"}}this.lastElement.appendChild(Z)}}}},strokeLine:function(aO,aQ,Z,aP){if(this.type===M){aO=(aO*V)|0,aQ=(aQ*V)|0,Z=(Z*V)|0,aP=(aP*V)|0}else{if(this.type===s){aO=(this.isedge?(aO+this.x0+0.5)|0:aO+this.x0);aQ=(this.isedge?(aQ+this.y0+0.5)|0:aQ+this.y0);Z=(this.isedge?(Z+this.x0+0.5)|0:Z+this.x0);aP=(this.isedge?(aP+this.y0+0.5)|0:aP+this.y0)}}var i=this.cpath;this.cpath=[this.PATH_MOVE,aO,aQ,this.PATH_LINE,Z,aP];this.addVectorElement(false,true);this.cpath=i},strokeCross:function(Z,aP,aO){if(this.type===M){Z=(Z*V-t)|0,aP=(aP*V-t)|0,aO=(aO*V)|0}else{if(this.type===s){Z=(this.isedge?(Z+this.x0+0.5)|0:Z+this.x0);aP=(this.isedge?(aP+this.y0+0.5)|0:aP+this.y0);aO=(this.isedge?(aO+0.5)|0:aO)}}var i=this.cpath;this.cpath=[this.PATH_MOVE,(Z-aO),(aP-aO),this.PATH_LINE,(Z+aO),(aP+aO),this.PATH_MOVE,(Z-aO),(aP+aO),this.PATH_LINE,(Z+aO),(aP-aO)];this.addVectorElement(false,true);this.cpath=i},fillCircle:function(Z,aP,aO){var i=this.cpath;this.cpath=[];this.arc(Z,aP,aO,0,W,false);this.cpath.push(this.PATH_CLOSE);this.addVectorElement(true,false);this.cpath=i},strokeCircle:function(Z,aP,aO){var i=this.cpath;this.cpath=[];this.arc(Z,aP,aO,0,W,false);this.cpath.push(this.PATH_CLOSE);this.addVectorElement(false,true);this.cpath=i},shapeCircle:function(Z,aP,aO){var i=this.cpath;this.cpath=[];this.arc(Z,aP,aO,0,W,false);this.cpath.push(this.PATH_CLOSE);this.addVectorElement(true,true);this.cpath=i},addVectorElement:function(i,Z){if(this.type===f){this.addVectorElement=this.addVectorElement_SVG}else{if(this.type===s){this.addVectorElement=this.addVectorElement_SL}else{if(this.type===M){this.addVectorElement=this.addVectorElement_VML}}}this.addVectorElement(i,Z)},addVectorElement_SVG:function(i,aP){var aO=this.cpath.join(" ");var Z=aA.createElementNS(D,"path");Z.setAttribute("d",aO);Z.setAttribute(aq,(i?I(this.fillStyle):X));Z.setAttribute(af,(aP?I(this.strokeStyle):X));if(aP){Z.setAttribute(E,this.lineWidth,"px")}this.target.appendChild(Z);this.lastElement=Z;if(!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},addVectorElement_SL:function(i,aP){var aO=this.cpath.join(" ");var Z=['<Path Data="',aO,'"'];if(i){Z.push(' Fill="',I(this.fillStyle),'"')}if(aP){Z.push(' Stroke="',I(this.strokeStyle),'" StrokeThickness="',this.lineWidth,'"')}Z.push(" />");var aQ=this.content.createFromXaml(Z.join(""));this.lastElement=aQ;this.target.children.add(aQ);if(!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}},addVectorElement_VML:function(i,aP){var aO=this.cpath.join(" ");aO=[aO,(!i?G:L),(!aP?c:L)].join("");var Z=[aD,aJ,aa,ah,aO,aj];if(i){Z.push(U,I(this.fillStyle),aj)}if(aP){Z.push(B,I(this.strokeStyle),aj,o,this.lineWidth,"px",aj)}Z.push(ao);this.target.insertAdjacentHTML(v,Z.join(""));this.lastElement=this.target.lastChild;if(!!this.vid){this.elements[this.vid]=this.lastElement;this.vid=""}}};var P=function(Z,i){this.fillStyle="black";this.strokeStyle="black";this.lineWidth=1;this.font="14px system";this.textAlign="center";this.textBaseline="middle";this.canvas=null;this.idname=i;this.canvasid=aM+i;this.child=null;this.context=null;this.currentLayerId="_empty";this.isedgearray={_empty:false};this.isedge=false;this.use=new S();this.use.vml=(Z===M);this.use.svg=false;this.use.canvas=(Z===ag);this.use.sl=(Z===s);this.use.flash=(Z===aG);this.initElement()};P.prototype={initElement:function(){var aO=aA.getElementById(this.idname);var Z=aA.getElementById(this.canvasid);if(!Z){Z=aA.createElement("canvas");Z.id=this.canvasid;aO.appendChild(Z)}var aP=aB(aO);Z.width=aP.width;Z.height=aP.height;Z.style.position="relative";Z.style.width=aP.width+"px";Z.style.height=aP.height+"px";this.child=Z;var i=this;aO.style.display="block";aO.style.position="relative";aO.style.overflow="hidden";if(A.debugmode){aO.style.backgroundColor="#efefef";aO.style.border="solid 1px silver"}aO.getContext=function(aQ){i.context=Z.getContext(aQ);return i};aO.toDataURL=function(aQ){return(!!aQ?Z.toDataURL(aQ):Z.toDataURL())};this.canvas=aO;a--},setLayer:function(i){this.currentLayerId=(!!i?i:"_empty");if(this.isedgearray[this.currentLayerId]===void 0){this.isedgearray[this.currentLayerId]=false}this.isedge=this.isedgearray[this.currentLayerId]},setRendering:function(i){this.isedgearray[this.currentLayerId]=(i==="crispEdges");this.isedge=this.isedgearray[this.currentLayerId]},setUnselectable:function(i){if(i===(void 0)){i=true}else{i=!!i}this.canvas.style.MozUserSelect=(i?"none":"text");this.canvas.style.WebkitUserSelect=(i?"none":"text");this.canvas.style.userSelect=(i?"none":"text")},getContextElement:function(){return this.child},getLayerElement:function(){return this.child},changeSize:function(aO,i){this.canvas.style.width=aO+"px";this.canvas.style.height=i+"px";var Z=this.canvas.firstChild;var aQ=parseInt(Z.style.left),aP=parseInt(Z.style.top);aO+=(aQ<0?-aQ:0);i+=(aP<0?-aP:0);Z.style.width=aO+"px";Z.style.height=i+"px";Z.width=aO;Z.height=i},clear:function(){if(!!this.canvas.style.backgroundColor){this.setProperties();this.context.setTransform(1,0,0,1,0,0);this.context.fillStyle=J(this.canvas.style.backgroundColor);var i=aB(this.canvas);this.context.fillRect(0,0,i.width,i.height)}},setProperties:function(){this.context.fillStyle=this.fillStyle;this.context.strokeStyle=this.strokeStyle;this.context.lineWidth=this.lineWidth;this.context.font=this.font;this.context.textAlign=this.textAlign;this.context.textBaseline=this.textBaseline},beginPath:function(){this.context.beginPath()},closePath:function(){this.context.closePath()},moveTo:function(i,Z){i=(this.isedge?(i+0.5)|0:i);Z=(this.isedge?(Z+0.5)|0:Z);this.context.moveTo(i,Z)},lineTo:function(i,Z){i=(this.isedge?(i+0.5)|0:i);Z=(this.isedge?(Z+0.5)|0:Z);this.context.lineTo(i,Z)},rect:function(i,aP,Z,aO){i=(this.isedge?(i+0.5)|0:i);aP=(this.isedge?(aP+0.5)|0:aP);this.context.rect(i,aP,Z,aO)},arc:function(i,aR,aQ,aP,aO,Z){i=(this.isedge?(i+0.5)|0:i);aR=(this.isedge?(aR+0.5)|0:aR);this.context.arc(px,py,aQ,aP,aO,Z)},fill:function(){this.setProperties();this.context.fill()},stroke:function(){this.setProperties();this.context.stroke()},fillRect:function(i,aP,Z,aO){i=(this.isedge?(i+0.5)|0:i);aP=(this.isedge?(aP+0.5)|0:aP);this.setProperties();this.context.fillRect(i,aP,Z,aO)},strokeRect:function(i,aP,Z,aO){i=(this.isedge?(i+0.5)|0:i);aP=(this.isedge?(aP+0.5)|0:aP);this.setProperties();this.context.strokeRect(i,aP,Z,aO)},fillText:function(Z,i,aO){this.setProperties();this.context.fillText(Z,i,aO)},drawImage:function(Z,aR,aQ,aS,aO,aU,aT,i,aP){this.context.drawImage(Z,aR,aQ,aS,aO,aU,aT,i,aP)},translate:function(Z,i){this.context.translate(Z,i)},shape:function(){this.setProperties();this.context.fill();this.context.stroke()},shapeRect:function(i,aP,Z,aO){i=(this.isedge?(i+0.5)|0:i);aP=(this.isedge?(aP+0.5)|0:aP);Z=(this.isedge?(Z+0.5)|0:Z);aO=(this.isedge?(aO+0.5)|0:aO);this.setProperties();this.context.fillRect(i,aP,Z,aO);this.context.strokeRect(i,aP,Z,aO)},setLinePath:function(){var aQ=arguments,aP=aQ.length;this.context.beginPath();for(var aR=0,Z=aP-((aP|1)?1:2);aR<Z;aR+=2){var aO=(this.isedge?(aQ[aR]+0.5)|0:aQ[aR]);a2=(this.isedge?(aQ[aR+1]+0.5)|0:aQ[aR+1]);if(aR==0){this.context.moveTo(aO,a2)}else{this.context.lineTo(aO,a2)}}if(aQ[aP-1]){this.context.closePath()}},setOffsetLinePath:function(){var aR=arguments,aQ=aR.length,aO=[aR[0],aR[1]];this.context.beginPath();for(var aS=2,Z=aQ-((aQ|1)?1:2);aS<Z;aS+=2){aO[aS]=aR[aS]+aO[0];aO[aS+1]=aR[aS+1]+aO[1]}for(var aS=2,Z=aQ-((aQ|1)?1:2);aS<Z;aS+=2){var aP=(this.isedge?(aO[aS]+0.5)|0:aO[aS]);a2=(this.isedge?(aO[aS+1]+0.5)|0:aO[aS+1]);if(aS===2){this.context.moveTo(aP,a2)}else{this.context.lineTo(aP,a2)}}if(aR[aQ-1]){this.context.closePath()}},setDashSize:function(i){},strokeLine:function(Z,aP,i,aO){Z=(this.isedge?(Z+0.5)|0:Z);aP=(this.isedge?(aP+0.5)|0:aP);i=(this.isedge?(i+0.5)|0:i);aO=(this.isedge?(aO+0.5)|0:aO);this.setProperties();this.context.beginPath();this.context.moveTo(Z,aP);this.context.lineTo(i,aO);this.context.stroke()},strokeCross:function(i,aS,Z){var aP=(this.isedge?(i-Z+0.5)|0:i-Z),aR=(this.isedge?(aS-Z+0.5)|0:aS-Z),aO=(this.isedge?(i+Z+0.5)|0:i+Z),aQ=(this.isedge?(aS+Z+0.5)|0:aS+Z);this.setProperties();this.context.beginPath();this.context.moveTo(aP,aR);this.context.lineTo(aO,aQ);this.context.moveTo(aP,aQ);this.context.lineTo(aO,aR);this.context.stroke()},fillCircle:function(i,aO,Z){i=(this.isedge?(i+0.5)|0:i);aO=(this.isedge?(aO+0.5)|0:aO);this.setProperties();this.context.beginPath();this.context.arc(i,aO,Z,0,W,false);this.context.fill()},strokeCircle:function(i,aO,Z){i=(this.isedge?(i+0.5)|0:i);aO=(this.isedge?(aO+0.5)|0:aO);this.setProperties();this.context.beginPath();this.context.arc(i,aO,Z,0,W,false);this.context.stroke()},shapeCircle:function(i,aO,Z){i=(this.isedge?(i+0.5)|0:i);aO=(this.isedge?(aO+0.5)|0:aO);this.setProperties();this.context.beginPath();this.context.arc(i,aO,Z,0,W,false);this.context.fill();this.context.stroke()}};var N=function(Z,i){N.initElementById.apply(N,[Z,i])};an(N,{color:d,parse:I,ME:null,enable:new S(),current:new S(),initAllElements:function(){var aO=aA.getElementsByTagName("camp");for(var Z=0;Z<aO.length;Z++){this.initElementById(aO[Z].id,type)}},initElementsById:function(aP,aO){for(var Z=0;Z<aP.length;Z++){this.initElementById(aP[Z],aO)}},initElementById:function(aO,Z){if(!!aA.getElementById(aM+aO)){return}if(!u){aE()}var i=new S();if((Z===void 0)||(this.enable[Z]!==true)){i=this.current}else{i[Z]=true}a++;if(i.svg){new at(f,aO)}else{if(i.sl){new at(s,aO)}else{if(i.vml){new at(M,aO)}else{if(i.canvas){new P(ag,aO)}}}}},select:function(aO){if(this.enable[aO]!==true){return false}for(var Z=0;Z<ae.length;Z++){this.current[ae[Z]]=false}this.current[aO]=true;return true},setflags:function(i,Z){A[i]=Z},isready:function(){return(a===0)}});N.enable.canvas=(!!aA.createElement("canvas").getContext);N.enable.svg=(!!aA.createElementNS&&!!aA.createElementNS(D,"svg").suspendRedraw);N.enable.sl=(function(){try{return(new ActiveXObject("AgControl.AgControl")).IsVersionSupported("1.0")}catch(i){}return false})();N.enable.flash=false;N.enable.vml=ay;for(var O=0;O<ae.length;O++){N.current[ae[O]]=false}if(N.enable.svg){N.current.svg=true}else{if(N.enable.canvas){N.current.canvas=true}else{if(N.enable.sl){N.current.sl=true}else{if(N.enable.flash){N.current.flash=true}else{if(N.enable.vml){N.current.vml=true}}}}}if(N.enable.vml){aA.namespaces.add("v","urn:schemas-microsoft-com:vml");var av=[];av.push("v\\:shape, v\\:group, v\\:polyline, v\\:image { behavior: url(#default#VML); position:absolute; width:10px; height:10px; }");av.push("v\\:path, v\\:textpath, v\\:stroke { behavior: url(#default#VML); }");aA.write('<style type="text/css" rel="stylesheet">');aA.write(av.join(""));aA.write("</style>")}var av=[];av.push("camp { display: block; }\n");aA.write('<style type="text/css" rel="stylesheet">');aA.write(av.join(""));aA.write("</style>");if(ay){aA.createElement("camp")}r.Camp=N})();(function(){var a=document,l=this,i=function(p){if(typeof p==="string"){if(!f[p]){var o=a.getElementById(p);if(!o){return null}f[p]=new h(o)}return f[p]}var o=p;if(!!o.id){if(!f[o.id]){f[o.id]=new h(o)}return f[o.id]}return((!!o)?new h(o):null)},f=i._cache={},j=i._template=[],b=i._tempcnt=0,d=i._funcs=[],h=i.ElementExt=function(o){this.el=o;this.parent=o.parentNode;this.pdisp="none"},m=i.ElementTemplate=function(r,p,o,q,s){this.parent=r;this.tagName=p;this.attr=o;this.style=q;this.func=s},c=function(q,p){for(var o in p){q[o]=p[o]}},e=function(p){if(!p){return[]}var r=[];for(var q=0,o=p.length;q<o;q++){r[q]=p[q]}return r};i.br={IE:(!!(window.attachEvent&&!window.opera)),Opera:(!!window.opera),WebKit:(navigator.userAgent.indexOf("AppleWebKit/")>-1),Gecko:(navigator.userAgent.indexOf("Gecko")>-1&&navigator.userAgent.indexOf("KHTML")==-1),IE6:(navigator.userAgent.match(/MSIE (\d+)/)&&parseInt(RegExp.$1)==6),IE7:(navigator.userAgent.match(/MSIE (\d+)/)&&parseInt(RegExp.$1)==7),IE8:(navigator.userAgent.match(/MSIE (\d+)/)&&parseInt(RegExp.$1)==8),IE9:(navigator.userAgent.match(/MSIE (\d+)/)&&parseInt(RegExp.$1)==9)};i.os={iPhoneOS:(navigator.userAgent.indexOf("like Mac OS X")>-1)};i.mobile=(navigator.userAgent.indexOf("like Mac OS X")>-1||navigator.userAgent.indexOf("Android")>-1);l.ee=i;var n=ee.os.iPhoneOS;c(i,{clean:function(){f=null;f={};b=0;j=null;j=[]},addTemplate:function(v,w,s,u,r){if(!w){return}if(!v){v=null}else{if(typeof v=="string"){v=ee(v).el}}var t={};var p=(u||{});var q=(r||{});if(!!s){for(var o in s){if(o==="unselectable"&&s[o]==="on"){p.userSelect=p.MozUserSelect=p.KhtmlUserSelect="none";t.unselectable="on"}else{t[o]=s[o]}}}j[b++]=new m(v,w,t,p,r);return(b-1)},createEL:function(r,s){if(!j[r]){return null}var o=j[r];var q=a.createElement(o.tagName);if(!!s){q.id=s}for(var p in o.attr){q[p]=o.attr[p]}for(var p in o.style){q.style[p]=o.style[p]}for(var p in o.func){this.addEvent(q,p,o.func[p],true)}if(!!o.parent){o.parent.appendChild(q)}return q},getSrcElement:function(o){return o.target||o.srcElement},pageX:function(o){i.pageX=((!n)?function(p){return((p.pageX!==void 0)?p.pageX:p.clientX+this.scrollLeft())}:function(r){if(!!r.touches){var p=r.touches.length,s=0;if(p>0){for(var q=0;q<p;q++){s+=r.touches[q].pageX}return s/p}}else{if(!isNaN(r.pageX)){return r.pageX}else{if(!isNaN(r.clientX)){return r.clientX+this.scrollLeft()}}}return 0});return i.pageX(o)},pageY:function(o){i.pageY=((!n)?function(p){return((p.pageY!==void 0)?p.pageY:p.clientY+this.scrollTop())}:function(r){if(!!r.touches){var p=r.touches.length,s=0;if(p>0){for(var q=0;q<p;q++){s+=r.touches[q].pageY}return s/p}}else{if(!isNaN(r.pageY)){return r.pageY}else{if(!isNaN(r.clientY)){return r.clientY+this.scrollTop()}}}return 0});return i.pageY(o)},scrollLeft:function(){return(a.documentElement.scrollLeft||a.body.scrollLeft)},scrollTop:function(){return(a.documentElement.scrollTop||a.body.scrollTop)},windowWidth:function(){i.windowWidth=((!n)?function(){return((l.innerHeight!==void 0)?l.innerWidth:a.body.clientWidth)}:function(){return 980});return i.windowWidth()},windowHeight:function(){i.windowHeight=((!n)?function(){return((l.innerHeight!==void 0)?l.innerHeight:a.body.clientHeight)}:function(){return(980*(l.innerHeight/l.innerWidth))|0});return i.windowHeight()},binder:function(){var p=e(arguments);var q=p.shift(),o=p.shift();return function(){return o.apply(q,(p.length>0?p[0]:[]).concat(e(arguments)))}},ebinder:function(){var p=e(arguments);var r=p.shift(),o=p.shift(),q=(p.length>0?p[0]:[]);return function(s){return o.apply(r,[s||l.event].concat(p.length>0?p[0]:[]).concat(e(arguments)))}},addEvent:function(p,r,q,o){if(!!p.addEventListener){p.addEventListener(r,q,!!o)}else{p.attachEvent("on"+r,q)}d.push({el:p,event:r,func:q,capt:!!o})},removeAllEvents:function(){var q=!!a.removeEventListener;for(var p=0,o=d.length;p<o;p++){var r=d[p];if(q){r.el.removeEventListener(r.event,r.func,r.capt)}else{r.el.detachEvent("on"+r.event,r.func)}}d=[]},stopPropagation:function(o){if(!!o.stopPropagation){o.stopPropagation()}else{o.cancelBubble=true}},preventDefault:function(o){if(!!o.preventDefault){o.preventDefault()}else{o.returnValue=false}}});i.ElementExt.prototype={getRect:function(){this.getRect=((!!document.createElement("div").getBoundingClientRect)?function(){var v=this.el.getBoundingClientRect(),q,r,t,p;if(!l.scrollX==void 0){t=l.scrollX;p=l.scrollY}else{q=a.documentElement;r=a.body;t=(r.scrollLeft||q.scrollLeft)-q.clientLeft;p=(r.scrollTop||q.scrollTop)-q.clientTop}var s=v.left+t;var u=v.top+p;var w=v.right+t;var o=v.bottom+p;return{top:u,bottom:o,left:s,right:w}}:function(){var s=0,r=0,q=this.el;while(!!q){s+=+(!isNaN(q.offsetLeft)?q.offsetLeft:q.clientLeft);r+=+(!isNaN(q.offsetTop)?q.offsetTop:q.clientTop);q=q.offsetParent}var p=s+(this.el.offsetWidth||this.el.clientWidth);var o=r+(this.el.offsetHeight||this.el.clientHeight);return{top:r,bottom:o,left:s,right:p}});return this.getRect()},getWidth:function(){return this.el.offsetWidth||this.el.clientWidth},getHeight:function(){return this.el.offsetHeight||this.el.clientHeight},unselectable:function(){this.el.style.MozUserSelect="none";this.el.style.KhtmlUserSelect="none";this.el.style.userSelect="none";this.el.unselectable="on";return this},replaceChildrenClass:function(p,q){var o=this.el.firstChild;while(!!o){if(o.className===p){o.className=q}o=o.nextSibling}},remove:function(){this.parent.removeChild(this.el);return this},removeNextAll:function(o){var p=this.el.lastChild;while(!!p){if(p===o){break}if(!!p){this.el.removeChild(p)}else{break}p=this.el.lastChild}return this},appendHTML:function(o){var p=a.createElement("span");p.innerHTML=o;this.el.appendChild(p);return this},appendBR:function(){this.el.appendChild(a.createElement("br"));return this},appendEL:function(o){this.el.appendChild(o);return this},appendTo:function(o){o.el.appendChild(this.el);this.parent=o.el;return this},insertBefore:function(o){this.parent=o.parentNode;this.parent.insertBefore(this.el,o);return this},insertAfter:function(o){this.parent=o.parentNode;this.parent.insertBefore(this.el,o.nextSibling);return this}}})();Point=function(a,b){this.x=a;this.y=b};Point.prototype={set:function(a){this.x=a.x;this.y=a.y},reset:function(){this.x=null;this.y=null},valid:function(){return(this.x!==null&&this.y!==null)},equals:function(a){return(this.x===a.x&&this.y===a.y)}};Address=function(a,b){this.x=a;this.y=b};Address.prototype=Point.prototype;var k={initFlags:function(){this.qcols=0;this.qrows=0;this.irowake=0;this.iscross=0;this.isborder=0;this.isexcell=0;this.isLineCross=this.isCenterLine=this.isborderAsLine=this.hasroom=this.roomNumber=this.dispzero=this.isDispHatena=this.isInputHatena=this.isQnumDirect=this.isAnsNumber=this.NumberWithMB=this.linkNumber=this.BlackCell=this.NumberIsWhite=this.numberAsObject=this.RBBlackCell=this.checkBlackCell=this.checkWhiteCell=this.ispzprv3ONLY=this.isKanpenExist=false;this.bdmargin=0.7;this.bdmargin_image=0.15;if(this.mobile){this.bdmargin=this.bdmargin_image}},puzzleid:"",pzlnameid:"",EDITOR:true,PLAYER:false,editmode:true,playmode:false,cellsize:36,cwidth:36,cheight:36,bwidth:18,bheight:18,br:ee.br,os:ee.os,mobile:ee.mobile,BOARD:"board",CELL:"cell",CROSS:"cross",BORDER:"border",EXCELL:"excell",OTHER:"other",QUES:"ques",QNUM:"qnum",QDIR:"qdir",QANS:"qans",ANUM:"anum",LINE:"line",QSUB:"qsub",NONE:0,UP:1,DN:2,LT:3,RT:4,KEYUP:"up",KEYDN:"down",KEYLT:"left",KEYRT:"right",scriptcheck:false};k.initFlags();var g;var Puzzles=[];var _doc=document;if(typeof localStorage!="object"&&typeof globalStorage=="object"){localStorage=globalStorage[location.host]}function f_true(){return true}ExtData=function(){this.type;this.id;this.qdata;this.pflag;this.cols;this.rows;this.bstr;this.fstr;this.disable_accesslog=false;this.enableSaveImage=false;this.DBaccept=0;this.Session=16;this.LocalST=8;this.WebIDB=4;this.WebSQL=2;this.selectDBtype()};ExtData.prototype={reset:function(){this.type=null;this.id="";this.qdata="";this.pflag="";this.cols=0;this.rows=0;this.bstr="";this.fstr=""},selectDBtype:function(){try{if(!!window.sessionStorage){this.DBaccept|=this.Session}}catch(b){}try{if(!!window.localStorage){if(!k.br.Gecko||!!location.hostname){this.DBaccept|=this.LocalST}}}catch(b){}try{if(!!window.indexedDB){this.DBaccept|=this.WebIDB}}catch(b){}try{if(!!window.openDatabase){var a=openDatabase("pzprv3_manage","1.0","manager",1024*1024*5);if(!!a){this.DBaccept|=this.WebSQL}}}catch(b){}},enSessionStorage:function(){return !!(this.DBaccept&this.Session)},enLocalStorage:function(){return !!(this.DBaccept&this.LocalST)},enIndexedDatabase:function(){return !!(this.DBaccept&this.WebIDB)},enWebSQLDatabase:function(){return !!(this.DBaccept&this.WebSQL)},importURL:function(){if(!!window.localStorage&&!!localStorage.pzprv3_urldata){this.checkMode(localStorage.pzprv3_urldata);delete localStorage.pzprv3_urldata;this.disable_accesslog=true}else{this.checkMode(location.search)}},checkMode:function(a){if(a.length<=0){return}var b="";if(a=="?test"){b="TEST";a="?country"}else{if(a.match(/_test/)){b="TEST"}else{if(a.match(/^\?m\+/)){b="EDITOR"}else{if(a.match(/_edit/)){b="EDITOR"}else{if(a.match(/_play/)){b="PLAYER"}}}}}this.parseURI(a);if(!b){b=(!this.bstr?"EDITOR":"PLAYER")}switch(b){case"PLAYER":k.EDITOR=false;k.editmode=false;break;case"EDITOR":k.EDITOR=true;k.editmode=true;break;case"TEST":k.EDITOR=true;k.editmode=false;k.scriptcheck=true;this.parseURI(["?",this.id,"_test/",debug.urls[this.id]].join(""));break}k.PLAYER=!k.EDITOR;k.playmode=!k.editmode},parseURI:function(c){this.reset();c=c.replace(/(\r|\n)/g,"");var d=0,b=new Encode();if(c.match(/www\.kanpen\.net/)||c.match(/www\.geocities(\.co)?\.jp\/pencil_applet/)){c.match(/([0-9a-z]+)\.html/);this.id=RegExp.$1;if(c.indexOf("?heyawake=")>=0){this.qdata=c.substr(c.indexOf("?heyawake=")+10);this.type=b.HEYAAPP}else{if(c.indexOf("?pzpr=")>=0){this.qdata=c.substr(c.indexOf("?pzpr=")+6);this.type=b.PZPRV3}else{this.qdata=c.substr(c.indexOf("?problem=")+9);this.type=b.KANPEN}}}else{if(c.match(/www\.geocities(\.co)?\.jp\/heyawake/)){this.id="heyawake";this.qdata=c.substr(c.indexOf("?problem=")+9);this.type=b.HEYAAPP}else{if(c.match(/indi\.s58\.xrea\.com\/(.+)\/(sa|sc)\//)){this.id=RegExp.$1;this.qdata=c.substr(c.indexOf("?"));this.type=b.PZPRAPP}else{var a=c.indexOf("/",c.indexOf("?"));if(a>-1){this.id=c.substring(c.indexOf("?")+1,a);this.qdata=c.substr(a+1)}else{this.id=c.substr(1)}this.id=this.id.replace(/(m\+|_edit|_test|_play)/,"");this.type=b.PZPRV3}}}this.id=PZLNAME.toPID(this.id);switch(this.type){case b.KANPEN:this.parseURI_kanpen();break;case b.HEYAAPP:this.parseURI_heyaapp();break;default:this.parseURI_pzpr();break}},parseURI_pzpr:function(){var a=this.qdata.split("/");if(!isNaN(parseInt(a[0]))){a.unshift("")}this.pflag=a.shift();this.cols=parseInt(a.shift());this.rows=parseInt(a.shift());this.bstr=a.join("/")},parseURI_kanpen:function(){var a=this.qdata.split("/");if(this.id=="sudoku"){this.rows=this.cols=parseInt(a.shift())}else{this.rows=parseInt(a.shift());this.cols=parseInt(a.shift());if(this.id=="kakuro"){this.rows--;this.cols--}}this.bstr=a.join("/")},parseURI_heyaapp:function(){var b=this.qdata.split("/");var a=b.shift().split("x");this.cols=parseInt(a[0]);this.rows=parseInt(a[1]);this.bstr=b.join("/")},importFileData:function(){try{if(!window.sessionStorage){return}}catch(b){return}var c="";if(!!window.localStorage){c=localStorage.pzprv3_filedata;if(!!c){delete localStorage.pzprv3_filedata;sessionStorage.filedata=c}}c=sessionStorage.filedata;if(!!c){var a=c.split("/");this.reset();this.id=(a[0].match(/^pzprv3/)?a[1]:"");this.fstr=c;this.disable_accesslog=true}},exportFileData:function(){var c=fio.fileencode(fio.PZPH);var b="./p.html?"+k.puzzleid+(k.PLAYER?"_play":"");if(!k.br.Opera){var a=sessionStorage.filedata;sessionStorage.filedata=(c+fio.history);window.open(b,"");if(!!a){sessionStorage.filedata=a}else{delete sessionStorage.filedata}}else{localStorage.pzprv3_filedata=(c+fio.history);window.open(b,"")}},accesslog:function(){if(this.disable_accesslog){return}if(_doc.domain!=="indi.s58.xrea.com"&&_doc.domain!=="pzprv3.sakura.ne.jp"&&!_doc.domain.match(/pzv\.jp/)){return}var a=false;if(typeof ActiveXObject!="undefined"){try{a=new ActiveXObject("Microsoft.XMLHTTP")}catch(d){a=false}}if(!a&&typeof XMLHttpRequest!="undefined"){a=new XMLHttpRequest()}if(a){var b=_doc.referrer;b=b.replace(/\?/g,"%3f");b=b.replace(/\&/g,"%26");b=b.replace(/\=/g,"%3d");b=b.replace(/\//g,"%2f");var c=[("scr=pzprv3"),("pid="+k.puzzleid),("referer="+b),("pzldata="+this.qdata)].join("&");a.open("POST","./record.cgi");a.onreadystatechange=function(){};a.setRequestHeader("Content-Type","application/x-www-form-urlencoded");a.send(c)}}};PBase=function(){this.floatbgcolor="black";this.resizetimer=null;this.initProcess=true;this.dec=null;this.disinfo=0};PBase.prototype={onload_func:function(){if(location.search.match(/[\?_]test/)){this.includeFile("src/for_test.js");var a=this;setTimeout(function(){if(!!debug.urls){a.onload_func2.call(a)}else{setTimeout(arguments.callee,20)}},20)}else{this.onload_func2()}},onload_func2:function(){if(location.search.match(/[\?_]test/)){this.includeFile("src/for_test.js")}this.dec=new ExtData();this.dec.importURL();this.dec.importFileData();if(!this.dec.id){location.href="./"}Camp("divques");if(Camp.enable.canvas&&!!_doc.createElement("canvas").toDataURL){this.dec.enableSaveImage=true;Camp("divques_sub","canvas")}dbm=new DataBaseManager();this.reload_func(ee.binder(this,this.postload_func))},includeFile:function(a){var b=_doc.createElement("script");b.type="text/javascript";b.src=a;_doc.body.appendChild(b)},init_func:function(a){if(k.puzzleid!=this.dec.id){this.reload_func(a)}else{this.importBoardData()}},reload_func:function(d){this.initProcess=true;var b=this.dec.id;if(!Puzzles[b]){this.includeFile("src/"+b+".js")}if(!!k.puzzleid){if(!!puz.protoOriginal){puz.protoOriginal()}ee.removeAllEvents();menu.menureset();ee("numobj_parent").el.innerHTML="";ee.clean()}var a=this;var c=setInterval(function(){if(!Puzzles[b]||!Camp.isready()){return}clearInterval(c);g=ee("divques").unselectable().el.getContext("2d");k.pzlnameid=k.puzzleid=b;a.initObjects();if(!!d){d()}},10)},postload_func:function(){if(k.PLAYER){this.dec.accesslog()}tm=new Timer()},initObjects:function(){k.initFlags();puz=new Puzzles[k.puzzleid]();puz.setting();if(!!puz.protoChange){puz.protoChange()}enc=new Encode();fio=new FileIO();tc=new TCell();bd=new Board();mv=new MouseEvent();kc=new KeyEvent();kp=new KeyPopup();pc=new Graphic();ans=new AnsCheck();um=new OperationManager();area=new AreaManager();line=new LineManager();menu=new Menu();pp=new Properties();bd.initBoardSize(k.qcols,k.qrows);puz.input_init();puz.graphic_init();puz.encode_init();puz.answer_init();menu.menuinit();this.importBoardData();if(!!puz.finalfix){puz.finalfix()}menu.setEvents();this.initProcess=false},importBoardData:function(){if(!!this.dec.fstr){fio.filedecode_main(this.dec.fstr);this.dec.fstr=""}else{if(!!this.dec.cols){enc.pzlinput()}else{bd.resetInfo();pc.resize_canvas()}}},setFloatbgcolor:function(a){this.floatbgcolor=a},onresize_func:function(){if(this.resizetimer){clearTimeout(this.resizetimer)}this.resizetimer=setTimeout(ee.binder(pc,pc.resize_canvas),250)},onblur_func:function(){kc.keyreset();mv.mousereset()}};base=new PBase();ee.addEvent(window,"load",ee.ebinder(base,base.onload_func));Timer=function(){this.TID;this.timerInterval=100;this.st=0;this.current=0;this.bseconds=0;this.timerEL=ee("timerpanel").el;this.lastAnsCnt=0;this.worstACtime=0;this.nextACtime=0;this.start();this.TIDundo=null;this.undoInterval=25;this.undoWaitTime=300;this.undoWaitCount=0;if(k.br.IE6||k.br.IE7||k.br.IE8){this.timerInterval*=2;this.undoInterval*=2}};Timer.prototype={now:function(){return(new Date()).getTime()},reset:function(){this.worstACtime=0;this.timerEL.innerHTML=this.label()+"00:00";clearInterval(this.TID);this.start()},start:function(){this.st=this.now();this.TID=setInterval(ee.binder(this,this.update),this.timerInterval)},update:function(){this.current=this.now();if(k.PLAYER){this.updatetime()}if(pp.getVal("autocheck")){this.ACcheck()}},updatetime:function(){var c=((this.current-this.st)/1000)|0;if(this.bseconds==c){return}var a=(c/3600)|0;var b=((c/60)|0)-a*60;c=c-b*60-a*3600;if(b<10){b="0"+b}if(c<10){c="0"+c}this.timerEL.innerHTML=[this.label(),(!!a?a+":":""),b,":",c].join("");this.bseconds=c},label:function(){return menu.selectStr("経過時間：","Time: ")},ACcheck:function(){if(this.current>this.nextACtime&&this.lastAnsCnt!=um.anscount&&!ans.inCheck){this.lastAnsCnt=um.anscount;if(!ans.autocheck()){return}this.worstACtime=Math.max(this.worstACtime,(this.now()-this.current));this.nextACtime=this.current+(this.worstACtime<250?this.worstACtime*4+120:this.worstACtime*2+620)}},startUndoTimer:function(){this.undoWaitCount=this.undoWaitTime/this.undoInterval;if(!this.TIDundo){this.TIDundo=setInterval(ee.binder(this,this.procUndo),this.undoInterval)}this.execUndo()},stopUndoTimer:function(){kc.inUNDO=false;kc.inREDO=false;clearInterval(this.TIDundo);this.TIDundo=null},procUndo:function(){if(!kc.inUNDO&&!kc.inREDO){this.stopUndoTimer()}else{if(this.undoWaitCount>0){this.undoWaitCount--}else{this.execUndo()}}},execUndo:function(){if(kc.inUNDO){um.undo(1)}else{if(kc.inREDO){um.redo(1)}}}};Cell=function(){this.bx;this.by;this.px;this.py;this.cpx;this.cpy;this.ques;this.qnum;this.qdir;this.anum;this.qans;this.qsub;this.error};Cell.prototype={defques:0,defqnum:-1,defqdir:0,defanum:-1,defqans:0,defqsub:0,allclear:function(b,a){if(this.ques!==this.defques){if(a){um.addOpe(k.CELL,k.QUES,b,this.ques,this.defques)}this.ques=this.defques}if(this.qnum!==this.defqnum){if(a){um.addOpe(k.CELL,k.QNUM,b,this.qnum,this.defqnum)}this.qnum=this.defqnum}if(this.qdir!==this.defqdir){if(a){um.addOpe(k.CELL,k.QDIR,b,this.qdir,this.defqdir)}this.qdir=this.defqdir}if(this.anum!==this.defanum){if(a){um.addOpe(k.CELL,k.ANUM,b,this.anum,this.defanum)}this.anum=this.defanum}if(this.qans!==this.defqans){if(a){um.addOpe(k.CELL,k.QANS,b,this.qans,this.defqans)}this.qans=this.defqans}if(this.qsub!==this.defqsub){if(a){um.addOpe(k.CELL,k.QSUB,b,this.qsub,this.defqsub)}this.qsub=this.defqsub}this.error=0},ansclear:function(a){if(this.anum!==this.defanum){um.addOpe(k.CELL,k.ANUM,a,this.anum,this.defanum);this.anum=this.defanum}if(this.qans!==this.defqans){um.addOpe(k.CELL,k.QANS,a,this.qans,this.defqans);this.qans=this.defqans}if(this.qsub!==this.defqsub){um.addOpe(k.CELL,k.QSUB,a,this.qsub,this.defqsub);this.qsub=this.defqsub}this.error=0},subclear:function(a){if(this.qsub!==this.defqsub){um.addOpe(k.CELL,k.QSUB,a,this.qsub,this.defqsub);this.qsub=this.defqsub}this.error=0}};Cross=function(){this.bx;this.by;this.px;this.py;this.ques;this.qnum;this.error};Cross.prototype={defques:0,defqnum:-1,allclear:function(b,a){if(this.ques!==this.defques){if(a){um.addOpe(k.CROSS,k.QUES,b,this.ques,this.defques)}this.ques=this.defques}if(this.qnum!==this.defqnum){if(a){um.addOpe(k.CROSS,k.QNUM,b,this.qnum,this.defqnum)}this.qnum=this.defqnum}this.error=0},ansclear:function(a){this.error=0},subclear:function(a){this.error=0}};Border=function(){this.bx;this.by;this.px;this.py;this.ques;this.qnum;this.qans;this.qsub;this.line;this.color;this.error;this.cellcc=[null,null];this.crosscc=[null,null]};Border.prototype={defques:0,defqnum:-1,defqans:0,defline:0,defqsub:0,allclear:function(b,a){if(this.ques!==this.defques){if(a){um.addOpe(k.BORDER,k.QUES,b,this.ques,this.defques)}this.ques=this.defques}if(this.qnum!==this.defqnum){if(a){um.addOpe(k.BORDER,k.QNUM,b,this.qnum,this.defqnum)}this.qnum=this.defqnum}if(this.qans!==this.defqans){if(a){um.addOpe(k.BORDER,k.QANS,b,this.qans,this.defqans)}this.qans=this.defqans}if(this.line!==this.defline){if(a){um.addOpe(k.BORDER,k.LINE,b,this.line,this.defline)}this.line=this.defline}if(this.qsub!==this.defqsub){if(a){um.addOpe(k.BORDER,k.QSUB,b,this.qsub,this.defqsub)}this.qsub=this.defqsub}this.color="";this.error=0},ansclear:function(a){if(this.qans!==this.defqans){um.addOpe(k.BORDER,k.QANS,a,this.qans,this.defqans);this.qans=this.defqans}if(this.line!==this.defline){um.addOpe(k.BORDER,k.LINE,a,this.line,this.defline);this.line=this.defline}if(this.qsub!==this.defqsub){um.addOpe(k.BORDER,k.QSUB,a,this.qsub,this.defqsub);this.qsub=this.defqsub}this.color="";this.error=0},subclear:function(a){if(this.qsub!==this.defqsub){um.addOpe(k.BORDER,k.QSUB,a,this.qsub,this.defqsub);this.qsub=this.defqsub}this.error=0}};EXCell=function(){this.bx;this.by;this.px;this.py;this.qnum;this.qdir};EXCell.prototype={defqnum:-1,defqdir:0,allclear:function(b,a){if(this.qnum!==this.defqnum){if(a){um.addOpe(k.EXCELL,k.QNUM,b,this.qnum,this.defqnum)}this.qnum=this.defqnum}if(this.qdir!==this.defqdir){if(a){um.addOpe(k.EXCELL,k.QDIR,b,this.qdir,this.defqdir)}this.qdir=this.defqdir}this.error=0},ansclear:function(a){this.error=0},subclear:function(a){this.error=0}};Board=function(){this.cell=[];this.cross=[];this.border=[];this.excell=[];this.cellmax=0;this.crossmax=0;this.bdmax=0;this.excellmax=0;this.bdinside=0;this.maxnum=255;this.minbx=0;this.minby=0;this.maxbx=2*k.qcols;this.maxby=2*k.qrows;this.enableLineNG=false;this.enableLineCombined=false;this.isLPobj={};this.isLPobj[k.UP]={11:1,12:1,14:1,15:1};this.isLPobj[k.DN]={11:1,12:1,16:1,17:1};this.isLPobj[k.LT]={11:1,13:1,15:1,16:1};this.isLPobj[k.RT]={11:1,13:1,14:1,17:1};this.noLPobj={};this.noLPobj[k.UP]={1:1,4:1,5:1,13:1,16:1,17:1,21:1};this.noLPobj[k.DN]={1:1,2:1,3:1,13:1,14:1,15:1,21:1};this.noLPobj[k.LT]={1:1,2:1,5:1,12:1,14:1,17:1,22:1};this.noLPobj[k.RT]={1:1,3:1,4:1,12:1,15:1,16:1,22:1}};Board.prototype={initBoardSize:function(a,b){this.allclear(false);this.initGroup(k.CELL,a,b);if(!!k.iscross){this.initGroup(k.CROSS,a,b)}if(!!k.isborder){this.initGroup(k.BORDER,a,b)}if(!!k.isexcell){this.initGroup(k.EXCELL,a,b)}this.initSpecial(a,b);k.qcols=a;k.qrows=b;this.setminmax();this.setposAll()},initSpecial:function(){},initGroup:function(d,c,f){var e=this.getGroup(d);var b=this.estimateSize(d,c,f),a=e.length;if(a>b){for(var h=a-1;h>=b;h--){delete e[h];e.pop()}}else{if(a<b){for(var h=a;h<b;h++){e.push(this.newObject(d));e[h].allclear(h,false)}}}this.setposGroup(d);return(b-a)},getGroup:function(a){if(a===k.CELL){return this.cell}else{if(a===k.CROSS){return this.cross}else{if(a===k.BORDER){return this.border}else{if(a===k.EXCELL){return this.excell}}}}return[]},estimateSize:function(b,a,c){if(b===k.CELL){return a*c}else{if(b===k.CROSS){return(a+1)*(c+1)}else{if(b===k.BORDER){if(k.isborder===1){return 2*a*c-(a+c)}else{if(k.isborder===2){return 2*a*c+(a+c)}}}else{if(b===k.EXCELL){if(k.isexcell===1){return a+c+1}else{if(k.isexcell===2){return 2*a+2*c+4}}}}}}return 0},newObject:function(a){if(a===k.CELL){return(new Cell())}else{if(a===k.CROSS){return(new Cross())}else{if(a===k.BORDER){return(new Border())}else{if(a===k.EXCELL){return(new EXCell())}}}}return(void 0)},getObject:function(a,b){if(a===k.CELL){return bd.cell[b]}else{if(a===k.CROSS){return bd.cross[b]}else{if(a===k.BORDER){return bd.border[b]}else{if(a===k.EXCELL){return bd.excell[b]}}}}return(void 0)},disableInfo:function(){um.disableRecord();line.disableRecord();area.disableRecord()},enableInfo:function(){um.enableRecord();line.enableRecord();area.enableRecord()},resetInfo:function(){area.resetArea();line.resetLcnts()},setposAll:function(){this.setposCells();if(!!k.iscross){this.setposCrosses()}if(!!k.isborder){this.setposBorders()}if(!!k.isexcell){this.setposEXcells()}this.setcacheAll();this.setcoordAll()},setposGroup:function(a){if(a===k.CELL){this.setposCells()}else{if(a===k.CROSS){this.setposCrosses()}else{if(a===k.BORDER){this.setposBorders()}else{if(a===k.EXCELL){this.setposEXcells()}}}}},setposCells:function(){this.cellmax=this.cell.length;for(var b=0;b<this.cellmax;b++){var a=this.cell[b];a.bx=(b%k.qcols)*2+1;a.by=((b/k.qcols)<<1)+1}},setposCrosses:function(){this.crossmax=this.cross.length;for(var b=0;b<this.crossmax;b++){var a=this.cross[b];a.bx=(b%(k.qcols+1))*2;a.by=(b/(k.qcols+1))<<1}},setposBorders:function(){this.bdinside=2*k.qcols*k.qrows-(k.qcols+k.qrows);this.bdmax=this.border.length;for(var c=0;c<this.bdmax;c++){var b=this.border[c],a=c;if(a>=0&&a<(k.qcols-1)*k.qrows){b.bx=(a%(k.qcols-1))*2+2;b.by=((a/(k.qcols-1))<<1)+1}a-=((k.qcols-1)*k.qrows);if(a>=0&&a<k.qcols*(k.qrows-1)){b.bx=(a%k.qcols)*2+1;b.by=((a/k.qcols)<<1)+2}a-=(k.qcols*(k.qrows-1));if(k.isborder===2){if(a>=0&&a<k.qcols){b.bx=a*2+1;b.by=0}a-=k.qcols;if(a>=0&&a<k.qcols){b.bx=a*2+1;b.by=2*k.qrows}a-=k.qcols;if(a>=0&&a<k.qrows){b.bx=0;b.by=a*2+1}a-=k.qrows;if(a>=0&&a<k.qrows){b.bx=2*k.qcols;b.by=a*2+1}a-=k.qrows}}},setposEXcells:function(){this.excellmax=this.excell.length;for(var c=0;c<this.excellmax;c++){var b=this.excell[c],a=c;b.bx=-1;b.by=-1;if(k.isexcell===1){if(a>=0&&a<k.qcols){b.bx=a*2+1;b.by=-1;continue}a-=k.qcols;if(a>=0&&a<k.qrows){b.bx=-1;b.by=a*2+1;continue}a-=k.qrows}else{if(k.isexcell===2){if(a>=0&&a<k.qcols){b.bx=a*2+1;b.by=-1;continue}a-=k.qcols;if(a>=0&&a<k.qcols){b.bx=a*2+1;b.by=2*k.qrows+1;continue}a-=k.qcols;if(a>=0&&a<k.qrows){b.bx=-1;b.by=a*2+1;continue}a-=k.qrows;if(a>=0&&a<k.qrows){b.bx=2*k.qcols+1;b.by=a*2+1;continue}a-=k.qrows;if(a===0){b.bx=-1;b.by=-1;continue}a--;if(a===0){b.bx=2*k.qcols+1;b.by=-1;continue}a--;if(a===0){b.bx=-1;b.by=2*k.qrows+1;continue}a--;if(a===0){b.bx=2*k.qcols+1;b.by=2*k.qrows+1;continue}a--}}}},setcacheAll:function(){for(var b=0;b<this.bdmax;b++){var a=this.border[b];a.cellcc[0]=this.cnum(a.bx-(a.by&1),a.by-(a.bx&1));a.cellcc[1]=this.cnum(a.bx+(a.by&1),a.by+(a.bx&1));a.crosscc[0]=this.xnum(a.bx-(a.bx&1),a.by-(a.by&1));a.crosscc[1]=this.xnum(a.bx+(a.bx&1),a.by+(a.by&1))}},setcoordAll:function(){for(var b=0;b<this.cellmax;b++){var a=this.cell[b];a.px=(a.bx-1)*k.bwidth;a.py=(a.by-1)*k.bheight;a.cpx=a.bx*k.bwidth;a.cpy=a.by*k.bheight}if(!!k.iscross){for(var b=0;b<this.crossmax;b++){var a=this.cross[b];a.px=a.bx*k.bwidth;a.py=a.by*k.bheight}}if(!!k.isborder){for(var b=0;b<this.bdmax;b++){var a=this.border[b];a.px=a.bx*k.bwidth;a.py=a.by*k.bheight}}if(!!k.isexcell){for(var b=0;b<this.excellmax;b++){var a=this.excell[b];a.px=(a.bx-1)*k.bwidth;a.py=(a.by-1)*k.bheight}}},setminmax:function(){var b=(k.isexcell===1||k.isexcell===2);var a=(k.isexcell===2);this.minbx=(!b?0:-2);this.minby=(!b?0:-2);this.maxbx=(!a?2*k.qcols:2*k.qcols+2);this.maxby=(!a?2*k.qrows:2*k.qrows+2);tc.adjust()},isinside:function(b,a){return(b>=this.minbx&&b<=this.maxbx&&a>=this.minby&&a<=this.maxby)},allclear:function(b){for(var a=0;a<this.cellmax;a++){this.cell[a].allclear(a,b)}for(var a=0;a<this.crossmax;a++){this.cross[a].allclear(a,b)}for(var a=0;a<this.bdmax;a++){this.border[a].allclear(a,b)}for(var a=0;a<this.excellmax;a++){this.excell[a].allclear(a,b)}this.allclearSpecial(b)},ansclear:function(){for(var a=0;a<this.cellmax;a++){this.cell[a].ansclear(a)}for(var a=0;a<this.crossmax;a++){this.cross[a].ansclear(a)}for(var a=0;a<this.bdmax;a++){this.border[a].ansclear(a)}for(var a=0;a<this.excellmax;a++){this.excell[a].ansclear(a)}this.ansclearSpecial()},subclear:function(){for(var a=0;a<this.cellmax;a++){this.cell[a].subclear(a)}for(var a=0;a<this.crossmax;a++){this.cross[a].subclear(a)}for(var a=0;a<this.bdmax;a++){this.border[a].subclear(a)}for(var a=0;a<this.excellmax;a++){this.excell[a].subclear(a)}this.subclearSpecial()},errclear:function(b){if(!ans.errDisp){return}for(var a=0;a<this.cellmax;a++){this.cell[a].error=0}for(var a=0;a<this.crossmax;a++){this.cross[a].error=0}for(var a=0;a<this.bdmax;a++){this.border[a].error=0}for(var a=0;a<this.excellmax;a++){this.excell[a].error=0}this.errclearSpecial();ans.errDisp=false;if(b!==false){pc.paintAll()}},allclearSpecial:function(a){},ansclearSpecial:function(){},subclearSpecial:function(){},errclearSpecial:function(a){},idnum:function(c,e,d,b,a){if(c===k.CELL){return this.cnum(e,d,b,a)}else{if(c===k.CROSS){return this.xnum(e,d,b,a)}else{if(c===k.BORDER){return this.bnum(e,d,b,a)}else{if(c===k.EXCELL){return this.exnum(e,d,b,a)}}}}return null},cnum:function(d,c,b,a){if(b===(void 0)){b=k.qcols;a=k.qrows}if((d<0||d>(b<<1)||c<0||c>(a<<1))||(!(d&1))||(!(c&1))){return null}return(d>>1)+(c>>1)*b},xnum:function(d,c,b,a){if(b===(void 0)){b=k.qcols;a=k.qrows}if((d<0||d>(b<<1)||c<0||c>(a<<1))||(!!(d&1))||(!!(c&1))){return null}return(d>>1)+(c>>1)*(b+1)},bnum:function(d,c,b,a){if(b===(void 0)){b=k.qcols;a=k.qrows}if(d>=1&&d<=2*b-1&&c>=1&&c<=2*a-1){if(!(d&1)&&(c&1)){return((d>>1)-1)+(c>>1)*(b-1)}else{if((d&1)&&!(c&1)){return(d>>1)+((c>>1)-1)*b+(b-1)*a}}}else{if(k.isborder==2){if(c===0&&(d&1)&&(d>=1&&d<=2*b-1)){return(b-1)*a+b*(a-1)+(d>>1)}else{if(c===2*a&&(d&1)&&(d>=1&&d<=2*b-1)){return(b-1)*a+b*(a-1)+b+(d>>1)}else{if(d===0&&(c&1)&&(c>=1&&c<=2*a-1)){return(b-1)*a+b*(a-1)+2*b+(c>>1)}else{if(d===2*b&&(c&1)&&(c>=1&&c<=2*a-1)){return(b-1)*a+b*(a-1)+2*b+a+(c>>1)}}}}}}return null},exnum:function(d,c,b,a){if(b===(void 0)){b=k.qcols;a=k.qrows}if(k.isexcell===1){if(d===-1&&c===-1){return b+a}else{if(c===-1&&d>0&&d<2*b){return(d>>1)}else{if(d===-1&&c>0&&c<2*a){return b+(c>>1)}}}}else{if(k.isexcell===2){if(c===-1&&d>0&&d<2*b){return(d>>1)}else{if(c===2*a+1&&d>0&&d<2*b){return b+(d>>1)}else{if(d===-1&&c>0&&c<2*a){return 2*b+(c>>1)}else{if(d===2*b+1&&c>0&&c<2*a){return 2*b+a+(c>>1)}else{if(d===-1&&c===-1){return 2*b+2*a}else{if(d===2*b+1&&c===-1){return 2*b+2*a+1}else{if(d===-1&&c===2*a+1){return 2*b+2*a+2}else{if(d===2*b+1&&c===2*a+1){return 2*b+2*a+3}}}}}}}}}}return null},objectinside:function(e,b,d,a,c){if(e===k.CELL){return this.cellinside(b,d,a,c)}else{if(e===k.CROSS){return this.crossinside(b,d,a,c)}else{if(e===k.BORDER){return this.borderinside(b,d,a,c)}else{if(e===k.EXCELL){return this.excellinside(b,d,a,c)}}}}return[]},cellinside:function(b,e,a,d){var f=[];for(var h=(e|1);h<=d;h+=2){for(var i=(b|1);i<=a;i+=2){var j=this.cnum(i,h);if(j!==null){f.push(j)}}}return f},crossinside:function(b,e,a,d){var f=[];for(var h=e+(e&1);h<=d;h+=2){for(var i=b+(b&1);i<=a;i+=2){var j=this.xnum(i,h);if(j!==null){f.push(j)}}}return f},borderinside:function(b,d,a,c){var h=[];for(var e=d;e<=c;e++){for(var f=b+(((b+e)&1)^1);f<=a;f+=2){var i=this.bnum(f,e);if(i!==null){h.push(i)}}}return h},excellinside:function(d,f,b,e){var a=[];for(var h=(f|1);h<=e;h+=2){for(var i=(d|1);i<=b;i+=2){var j=this.exnum(i,h);if(j!==null){a.push(j)}}}return a},up:function(a){return this.cell[a]?this.cnum(this.cell[a].bx,this.cell[a].by-2):null},dn:function(a){return this.cell[a]?this.cnum(this.cell[a].bx,this.cell[a].by+2):null},lt:function(a){return this.cell[a]?this.cnum(this.cell[a].bx-2,this.cell[a].by):null},rt:function(a){return this.cell[a]?this.cnum(this.cell[a].bx+2,this.cell[a].by):null},ub:function(a){return this.cell[a]?this.bnum(this.cell[a].bx,this.cell[a].by-1):null},db:function(a){return this.cell[a]?this.bnum(this.cell[a].bx,this.cell[a].by+1):null},lb:function(a){return this.cell[a]?this.bnum(this.cell[a].bx-1,this.cell[a].by):null},rb:function(a){return this.cell[a]?this.bnum(this.cell[a].bx+1,this.cell[a].by):null},isLineEX:function(c){var b=bd.border[c].cellcc[0],a=bd.border[c].cellcc[1];return bd.border[c].bx&1?(bd.isLP(b,k.DN)&&bd.isLP(a,k.UP)):(bd.isLP(b,k.RT)&&bd.isLP(a,k.LT))},isLP:function(b,a){return !!this.isLPobj[a][this.cell[b].ques]},isLineNG:function(c){var b=bd.border[c].cellcc[0],a=bd.border[c].cellcc[1];return bd.border[c].bx&1?(bd.noLP(b,k.DN)||bd.noLP(a,k.UP)):(bd.noLP(b,k.RT)||bd.noLP(a,k.LT))},noLP:function(b,a){return !!this.noLPobj[a][this.cell[b].ques]},checkStableLine:function(b,a){if(this.enableLineCombined){return((a!==0&&this.isLineNG(b))||(a===0&&this.isLineEX(b)))}return(a!==0&&this.isLineNG(b))},setCombinedLine:function(f){var d=bd.cell[f].bx,b=bd.cell[f].by;var c=this.borderinside(d-1,b-1,d+1,b+1);for(var a=0;a<c.length;a++){var e=c[a];if(this.border[e].line===0&&this.isLineEX(e)){this.sLiB(e,1)}}},isLineStraight:function(a){if(this.isLine(this.ub(a))&&this.isLine(this.db(a))){return true}else{if(this.isLine(this.lb(a))&&this.isLine(this.rb(a))){return true}}return false},nummaxfunc:function(a){return this.maxnum},sQuC:function(b,a){um.addOpe(k.CELL,k.QUES,b,this.cell[b].ques,a);this.cell[b].ques=a;if(this.enableLineCombined){this.setCombinedLine(b)}},sQnC:function(b,a){if(!k.dispzero&&a===0){return}um.addOpe(k.CELL,k.QNUM,b,this.cell[b].qnum,a);this.cell[b].qnum=a;area.setCell("number",b)},sAnC:function(b,a){if(!k.dispzero&&a===0){return}um.addOpe(k.CELL,k.ANUM,b,this.cell[b].anum,a);this.cell[b].anum=a;area.setCell("number",b)},sQaC:function(b,a){um.addOpe(k.CELL,k.QANS,b,this.cell[b].qans,a);this.cell[b].qans=a;area.setCell("block",b)},sQsC:function(b,a){um.addOpe(k.CELL,k.QSUB,b,this.cell[b].qsub,a);this.cell[b].qsub=a;if(k.NumberWithMB){area.setCell("number",b)}},sDiC:function(b,a){um.addOpe(k.CELL,k.QDIR,b,this.cell[b].qdir,a);this.cell[b].qdir=a},QuC:function(a){return this.cell[a].ques},QnC:function(a){return this.cell[a].qnum},AnC:function(a){return this.cell[a].anum},QaC:function(a){return this.cell[a].qans},QsC:function(a){return this.cell[a].qsub},DiC:function(a){return this.cell[a].qdir},sQnE:function(b,a){um.addOpe(k.EXCELL,k.QNUM,b,this.excell[b].qnum,a);this.excell[b].qnum=a},sDiE:function(b,a){um.addOpe(k.EXCELL,k.QDIR,b,this.excell[b].qdir,a);this.excell[b].qdir=a},QnE:function(a){return this.excell[a].qnum},DiE:function(a){return this.excell[a].qdir},sQuX:function(b,a){um.addOpe(k.CROSS,k.QUES,b,this.cross[b].ques,a);this.cross[b].ques=a},sQnX:function(b,a){um.addOpe(k.CROSS,k.QNUM,b,this.cross[b].qnum,a);this.cross[b].qnum=a},QuX:function(a){return this.cross[a].ques},QnX:function(a){return this.cross[a].qnum},sQuB:function(b,a){um.addOpe(k.BORDER,k.QUES,b,this.border[b].ques,a);this.border[b].ques=a;area.setBorder(b,(a>0))},sQnB:function(b,a){um.addOpe(k.BORDER,k.QNUM,b,this.border[b].qnum,a);this.border[b].qnum=a},sQaB:function(b,a){if(this.border[b].ques!==0){return}um.addOpe(k.BORDER,k.QANS,b,this.border[b].qans,a);this.border[b].qans=a;area.setBorder(b,(a>0))},sQsB:function(b,a){um.addOpe(k.BORDER,k.QSUB,b,this.border[b].qsub,a);this.border[b].qsub=a},sLiB:function(b,a){if(this.enableLineNG&&this.checkStableLine(b,a)){return}um.addOpe(k.BORDER,k.LINE,b,this.border[b].line,a);this.border[b].line=a;line.setLine(b,(a>0))},QuB:function(a){return this.border[a].ques},QnB:function(a){return this.border[a].qnum},QaB:function(a){return this.border[a].qans},QsB:function(a){return this.border[a].qsub},LiB:function(a){return this.border[a].line},sErC:function(c,a){if(!ans.isenableSetError()){return}if(!c.push){c=[c]}for(var b=0;b<c.length;b++){if(!!this.cell[c[b]]){this.cell[c[b]].error=a}}},sErX:function(c,a){if(!ans.isenableSetError()){return}if(!c.push){c=[c]}for(var b=0;b<c.length;b++){if(!!this.cross[c[b]]){this.cross[c[b]].error=a}}},sErB:function(c,a){if(!ans.isenableSetError()){return}if(!c.push){c=[c]}for(var b=0;b<c.length;b++){if(!!this.border[c[b]]){this.border[c[b]].error=a}}},sErE:function(c,a){if(!ans.isenableSetError()){return}if(!c.push){c=[c]}for(var b=0;b<c.length;b++){if(!!this.excell[c[b]]){this.excell[c[b]].error=a}}},sErBAll:function(a){if(!ans.isenableSetError()){return}for(var b=0;b<bd.bdmax;b++){this.border[b].error=a}},isBlack:function(a){return(!!bd.cell[a]&&bd.cell[a].qans===1)},isWhite:function(a){return(!!bd.cell[a]&&bd.cell[a].qans!==1)},setBlack:function(a){this.sQaC(a,1)},setWhite:function(a){this.sQaC(a,0)},isNum:function(a){return(!!bd.cell[a]&&(bd.cell[a].qnum!==-1||bd.cell[a].anum!==-1))},noNum:function(a){return(!bd.cell[a]||(bd.cell[a].qnum===-1&&bd.cell[a].anum===-1))},isValidNum:function(a){return(!!bd.cell[a]&&(bd.cell[a].qnum>=0||(bd.cell[a].anum>=0&&bd.cell[a].qnum===-1)))},sameNumber:function(b,a){return(bd.isValidNum(b)&&(bd.getNum(b)===bd.getNum(a)))},getNum:function(a){return(bd.cell[a].qnum!==-1?bd.cell[a].qnum:bd.cell[a].anum)},setNum:function(e,d){if(!k.dispzero&&d===0){return}if(k.editmode){d=(((k.numberAsObject||d===-2)&&this.cell[e].qnum===d)?-1:d);this.sQnC(e,d);if(k.isAnsNumber){this.sAnC(e,-1)}if(k.NumberIsWhite){this.sQaC(e,0)}if(k.isAnsNumber||pc.bcolor==="white"){this.sQsC(e,0)}}else{if(this.cell[e].qnum===-1){var a=((d>-1&&!(k.numberAsObject&&this.cell[e].anum===d))?d:-1);var b=((d<-1&&!(k.numberAsObject&&this.cell[e].qsub===-d-1))?-d-1:0);this.sAnC(e,a);this.sQsC(e,b);this.sDiC(e,0)}}},isLine:function(a){return(!!bd.border[a]&&bd.border[a].line>0)},setLine:function(a){this.sLiB(a,1);this.sQsB(a,0)},setPeke:function(a){this.sLiB(a,0);this.sQsB(a,2)},removeLine:function(a){this.sLiB(a,0);this.sQsB(a,0)},isBorder:function(a){return(!!bd.border[a]&&(bd.border[a].ques>0||bd.border[a].qans>0))},setBorder:function(a){if(k.editmode){this.sQuB(a,1);this.sQaB(a,0)}else{if(this.border[a].ques!==1){this.sQaB(a,1)}}},removeBorder:function(a){if(k.editmode){this.sQuB(a,0);this.sQaB(a,0)}else{if(this.border[a].ques!==1){this.sQaB(a,0)}}}};AreaInfo=function(){this.max=0;this.id=[];this.room=[]};IDList=function(a){this.data=((a instanceof Array)?a:[])};IDList.prototype={push:function(a){this.data.push(a);return this},reverseData:function(){this.data=this.data.reverse();return this},unique:function(){var b=[],d={};for(var c=0,a=this.data.length;c<a;c++){if(!d[this.data[c]]){b.push(this.data[c]);d[this.data[c]]=true}}this.data=b;return this},sublist:function(d){var c=new IDList();for(var b=0,a=this.data.length;b<a;b++){if(!!d(this.data[b])){c.data.push(this.data[b])}}return c},isnull:function(){return(this.data.length===0)},include:function(c){for(var b=0,a=this.data.length;b<a;b++){if(this.data[b]===c){return true}}return false}};LineManager=function(){this.lcnt=[];this.ltotal=[];this.disableLine=(!k.isCenterLine&&!k.isborderAsLine);this.data={};this.typeA="A";this.typeB="B";this.typeC="C";this.disrec=0;this.init()};LineManager.prototype={init:function(){if(this.disableLine){return}if(k.isCenterLine){for(var d=0;d<bd.cellmax;d++){this.lcnt[d]=0}this.ltotal=[(k.qcols*k.qrows),0,0,0,0]}else{for(var d=0,a=(k.qcols+1)*(k.qrows+1);d<a;d++){this.lcnt[d]=0}this.ltotal=[((k.qcols+1)*(k.qrows+1)),0,0,0,0]}this.data={max:0,id:[]};for(var b=0;b<bd.bdmax;b++){this.data.id[b]=null}},disableRecord:function(){this.disrec++},enableRecord:function(){if(this.disrec>0){this.disrec--}},isenableRecord:function(){return(this.disrec===0)},resetLcnts:function(){if(this.disableLine){return}this.init();var a=[];for(var d=0;d<bd.bdmax;d++){if(bd.isLine(d)){this.data.id[d]=0;a.push(d);var c,b;if(k.isCenterLine){c=bd.border[d].cellcc[0];b=bd.border[d].cellcc[1]}else{c=bd.border[d].crosscc[0];b=bd.border[d].crosscc[1]}if(c!==null){this.ltotal[this.lcnt[c]]--;this.lcnt[c]++;this.ltotal[this.lcnt[c]]++}if(b!==null){this.ltotal[this.lcnt[b]]--;this.lcnt[b]++;this.ltotal[this.lcnt[b]]++}}else{this.data.id[d]=null}}this.lc0main(a);if(k.irowake!==0){this.newIrowake()}},newIrowake:function(){for(var b=1;b<=this.data.max;b++){var c=this.data[b].idlist;if(c.length>0){var a=pc.getNewLineColor();for(var d=0;d<c.length;d++){bd.border[c[d]].color=a}}}},lcntCell:function(a){return(!!this.lcnt[a]?this.lcnt[a]:0)},gettype:function(d,c,b){var a=(b?0:1);if(d===null){return this.typeA}else{if(!this.iscrossing(d)){return((this.lcnt[d]===(1-a))?this.typeA:this.typeB)}else{if(this.lcnt[d]===(1-a)||(this.lcnt[d]===(3-a)&&this.isTpos(d,c))){return this.typeA}else{if(this.lcnt[d]===(2-a)||this.lcnt[d]===(4-a)){return this.typeB}}return this.typeC}}},isTpos:function(b,a){if(k.isCenterLine){return !bd.isLine(bd.bnum(2*bd.cell[b].bx-bd.border[a].bx,2*bd.cell[b].by-bd.border[a].by))}else{return !bd.isLine(bd.bnum(4*(b%(k.qcols+1))-bd.border[a].bx,4*((b/(k.qcols+1))|0)-bd.border[a].by))}},iscrossing:function(a){return k.isLineCross},setLine:function(b,j){if(this.disableLine||!this.isenableRecord()){return}if(j===(this.data.id[b]!==null)){return}var m,l;if(k.isCenterLine){m=bd.border[b].cellcc[0];l=bd.border[b].cellcc[1]}else{m=bd.border[b].crosscc[0];l=bd.border[b].crosscc[1]}if(j){if(m!==null){this.ltotal[this.lcnt[m]]--;this.lcnt[m]++;this.ltotal[this.lcnt[m]]++}if(l!==null){this.ltotal[this.lcnt[l]]--;this.lcnt[l]++;this.ltotal[this.lcnt[l]]++}}else{if(m!==null){this.ltotal[this.lcnt[m]]--;this.lcnt[m]--;this.ltotal[this.lcnt[m]]++}if(l!==null){this.ltotal[this.lcnt[l]]--;this.lcnt[l]--;this.ltotal[this.lcnt[l]]++}}var f=this.gettype(m,b,j),d=this.gettype(l,b,j);if(j){if(f===this.typeA&&d===this.typeA){this.data.max++;this.data[this.data.max]={idlist:[b]};this.data.id[b]=this.data.max;bd.border[b].color=pc.getNewLineColor()}else{if((f===this.typeA&&d===this.typeB)||(f===this.typeB&&d===this.typeA)){var h=(this.getbid(b,1))[0];this.data[this.data.id[h]].idlist.push(b);this.data.id[b]=this.data.id[h];bd.border[b].color=bd.border[h].color}else{if(f===this.typeB&&d===this.typeB){this.combineLineInfo(b)}else{this.remakeLineInfo(b,1)}}}}else{if(f===this.typeA&&d===this.typeA){this.data[this.data.id[b]]={idlist:[]};this.data.id[b]=null;bd.border[b].color=""}else{if((f===this.typeA&&d===this.typeB)||(f===this.typeB&&d===this.typeA)){var c=this.data.id[b],a=this.data[c].idlist;for(var e=0;e<a.length;e++){if(a[e]===b){a.splice(e,1);break}}this.data.id[b]=null;bd.border[b].color=""}else{this.remakeLineInfo(b,0);bd.border[b].color=""}}}},combineLineInfo:function(a){var e=this.data.id;var j=this.getbid(a,1);var p=[e[j[0]],null];for(var h=0;h<j.length;h++){if(p[0]!=e[j[h]]){p[1]=e[j[h]];break}}var o=bd.border[j[0]].color;if(p[1]!=null){var f=p[0],b=p[1];if(this.data[p[0]].idlist.length<this.data[p[1]].idlist.length){f=p[1];b=p[0];o=bd.border[j[1]].color}var l=this.data[f].idlist;var c=this.data[b].idlist;for(var d=0,m=c.length;d<m;d++){l.push(c[d]);e[c[d]]=f}this.data[b].idlist=[];l.push(a);e[a]=f;for(var h=0,m=l.length;h<m;h++){bd.border[l[h]].color=o}if(pp.getVal("irowake")){pc.repaintLines(l,a)}}else{this.data[p[0]].idlist.push(a);e[a]=p[0];bd.border[a].color=o}},remakeLineInfo:function(b,d){var e=this.data.id;var f=this.data.max;var p=this.getbid(b,d);var h=e[p[0]],j=bd.border[p[0]].color;for(var o=0,q=p.length;o<q;o++){var r=e[p[o]];if(r<=0){continue}var a=this.data[r].idlist;if(this.data[h].idlist.length<a.length){h=r;j=bd.border[p[o]].color}for(var c=0,l=a.length;c<l;c++){e[a[c]]=0}this.data[r]={idlist:[]}}if(d>0){e[b]=0;p.unshift(b)}else{e[b]=null}this.lc0main(p);var m=f+1;for(var r=f+1;r<=this.data.max;r++){var a=this.data[r].idlist;if(this.data[m].idlist.length<a.length){m=r}}for(var r=f+1;r<=this.data.max;r++){var s=(r===m?j:pc.getNewLineColor());var a=this.data[r].idlist;for(var c=0,q=a.length;c<q;c++){bd.border[a[c]].color=s}if(pp.getVal("irowake")){pc.repaintLines(a,b)}}},getClistFromIdlist:function(c){var b=new IDList();for(var a=0;a<c.length;a++){b.push(bd.border[c[a]].cellcc[0]);b.push(bd.border[c[a]].cellcc[1])}return b.unique().data},getXlistFromIdlist:function(c){var a=new IDList();for(var b=0;b<c.length;b++){a.push(bd.border[c[b]].crosscc[0]);a.push(bd.border[c[b]].crosscc[1])}return a.unique().data},getbid:function(c,e){var d=(e>0?0:1),l=bd.border[c].bx,j=bd.border[c].by;var q=((k.isCenterLine^(l%2===0))?2:0),o=(2-q);var n=bd.border[c].cellcc[0],m=bd.border[c].cellcc[1];if(!k.isCenterLine){n=bd.border[c].crosscc[0];m=bd.border[c].crosscc[1]}var p=[];if(n!==null){var b=this.iscrossing(n),a=this.lcnt[n];if(b&&a>=(4-d)){p.push(bd.bnum(l-o,j-q))}else{if(a>=(2-d)&&!(b&&a===(3-d)&&this.isTpos(n,c))){p.push(bd.bnum(l-o,j-q));p.push(bd.bnum(l-1,j-1));p.push(bd.bnum(l+q-1,j+o-1))}}}if(m!==null){var b=this.iscrossing(m),a=this.lcnt[m];if(b&&a>=(4-d)){p.push(bd.bnum(l+o,j+q))}else{if(a>=(2-d)&&!(b&&a===(3-d)&&this.isTpos(m,c))){p.push(bd.bnum(l+o,j+q));p.push(bd.bnum(l+1,j+1));p.push(bd.bnum(l-q+1,j-o+1))}}}var h=[];for(var f=0;f<p.length;f++){if(bd.isLine(p[f])){h.push(p[f])}}return h},lc0main:function(b){for(var c=0,a=b.length;c<a;c++){if(this.data.id[b[c]]!=0){continue}var e=bd.border[b[c]].bx,d=bd.border[b[c]].by;this.data.max++;this.data[this.data.max]={idlist:[]};if(!k.isCenterLine^(e&1)){this.lc0(e,d+1,1,this.data.max);this.lc0(e,d,2,this.data.max)}else{this.lc0(e+1,d,3,this.data.max);this.lc0(e,d,4,this.data.max)}}},lc0:function(d,c,b,a){while(1){switch(b){case 1:c--;break;case 2:c++;break;case 3:d--;break;case 4:d++;break}if((d+c)%2===0){var f=(k.isCenterLine?bd.cnum:bd.xnum).call(bd,d,c);if(f===null){break}else{if(this.lcnt[f]>=3){if(!this.iscrossing(f)){if(bd.isLine(bd.bnum(d,c-1))){this.lc0(d,c,1,a)}if(bd.isLine(bd.bnum(d,c+1))){this.lc0(d,c,2,a)}if(bd.isLine(bd.bnum(d-1,c))){this.lc0(d,c,3,a)}if(bd.isLine(bd.bnum(d+1,c))){this.lc0(d,c,4,a)}break}}else{if(b!=1&&bd.isLine(bd.bnum(d,c+1))){b=2}else{if(b!=2&&bd.isLine(bd.bnum(d,c-1))){b=1}else{if(b!=3&&bd.isLine(bd.bnum(d+1,c))){b=4}else{if(b!=4&&bd.isLine(bd.bnum(d-1,c))){b=3}}}}}}}else{var e=bd.bnum(d,c);if(this.data.id[e]!=0){break}this.data.id[e]=a;this.data[a].idlist.push(e)}}},getLineInfo:function(){var b=new AreaInfo();for(var c=0;c<bd.bdmax;c++){b.id[c]=(bd.isLine(c)?0:null)}for(var c=0;c<bd.bdmax;c++){if(b.id[c]!=0){continue}b.max++;b.room[b.max]={idlist:this.data[this.data.id[c]].idlist};for(var a=0;a<b.room[b.max].idlist.length;a++){b.id[b.room[b.max].idlist[a]]=b.max}}return b},getLareaInfo:function(){var a=new AreaInfo();for(var b=0;b<bd.cellmax;b++){a.id[b]=(this.lcnt[b]>0?0:null)}for(var b=0;b<bd.cellmax;b++){if(a.id[b]!=0){continue}a.max++;a.room[a.max]={idlist:[]};this.sr0(a,b,a.max)}return a},sr0:function(c,a,b){c.id[a]=b;c.room[b].idlist.push(a);if(bd.isLine(bd.ub(a))&&c.id[bd.up(a)]===0){this.sr0(c,bd.up(a),b)}if(bd.isLine(bd.db(a))&&c.id[bd.dn(a)]===0){this.sr0(c,bd.dn(a),b)}if(bd.isLine(bd.lb(a))&&c.id[bd.lt(a)]===0){this.sr0(c,bd.lt(a),b)}if(bd.isLine(bd.rb(a))&&c.id[bd.rt(a)]===0){this.sr0(c,bd.rt(a),b)}}};AreaManager=function(){this.lcnt=[];this.isbd=[];this.room={};this.bcell={};this.wcell={};this.disrec=0;this.init()};AreaManager.prototype={init:function(){this.initRarea();this.initBarea();this.initWarea()},disableRecord:function(){this.disrec++},enableRecord:function(){if(this.disrec>0){this.disrec--}},isenableRecord:function(){return(this.disrec===0)},resetArea:function(){if(!!k.isborder&&!k.isborderAsLine){this.resetRarea()}if(k.checkBlackCell||k.linkNumber){this.resetBarea()}if(k.checkWhiteCell){this.resetWarea()}},initRarea:function(){this.room={max:1,id:[],1:{top:0,clist:[]}};for(var e=0;e<bd.cellmax;e++){this.room.id[e]=1;this.room[1].clist[e]=e}this.lcnt=[];for(var e=0;e<(k.qcols+1)*(k.qrows+1);e++){this.lcnt[e]=0}if(k.isborder===1){for(var a=bd.minby;a<=bd.maxby;a+=2){for(var b=bd.minbx;b<=bd.maxbx;b+=2){if(b===bd.minbx||b===bd.maxbx||a===bd.minby||a===bd.maxby){var e=(b>>1)+(a>>1)*(k.qcols+1);this.lcnt[e]=2}}}}this.isbd=[];for(var d=0;d<bd.bdmax;d++){this.isbd[d]=false}if(!k.hasroom){return}for(var d=0;d<bd.bdmax;d++){if(bd.isBorder(d)){this.setRinfo(d,true)}}},resetRarea:function(){if(!k.hasroom){return}this.initRarea();this.room.max=0;for(var j=0;j<bd.cellmax;j++){this.room.id[j]=0}for(var j=0;j<bd.cellmax;j++){if(this.room.id[j]!=0){continue}this.room.max++;this.room[this.room.max]={top:null,clist:[]};this.sr0(j,this.room,bd.isBorder)}if(k.roomNumber){for(var d=1;d<=this.room.max;d++){this.setTopOfRoom(d);var f=-1,e=this.room[d].clist;for(var b=0,a=e.length;b<a;b++){var h=e[b];if(this.room.id[h]===d&&bd.cell[h].qnum!==-1){if(f===-1){f=bd.cell[h].qnum}if(this.room[d].top!==h){bd.sQnC(h,-1)}}}if(f!==-1&&bd.QnC(this.room[d].top)===-1){bd.sQnC(this.room[d].top,f)}}}},lcntCross:function(a){return this.lcnt[a]},getRoomID:function(a){return this.room.id[a]},getTopOfRoomByCell:function(a){return this.room[this.room.id[a]].top},getTopOfRoom:function(a){return this.room[a].top},getCntOfRoomByCell:function(a){return this.room[this.room.id[a]].clist.length},setRinfo:function(d,c){var b=bd.border[d].crosscc[0],a=bd.border[d].crosscc[1];if(c){if(b!==null){this.lcnt[b]++}if(a!==null){this.lcnt[a]++}}else{if(b!==null){this.lcnt[b]--}if(a!==null){this.lcnt[a]--}}this.isbd[d]=c},setBorder:function(l,j){if(!k.hasroom||!this.isenableRecord()){return}if(j===this.isbd[l]){return}this.setRinfo(l,j);var b=bd.border[l].crosscc[0],a=bd.border[l].crosscc[1];var f=bd.border[l].cellcc[0],e=bd.border[l].cellcc[1];var t=this.room,w=t.id;if(j){if(this.lcnt[b]===1||this.lcnt[a]===1){return}if(f===null||e===null||w[f]!==w[e]){return}var h=w[f];t.max++;t[t.max]={top:null,clist:[]};this.sr0(e,t,bd.isBorder);if(w[f]===t.max){for(var o=0,p=t[t.max].clist.length;o<p;o++){w[t[t.max].clist[o]]=h}t.max--;return}var v=t[h].clist.concat();t[h].clist=[];t[t.max].clist=[];for(var o=0,p=v.length;o<p;o++){t[w[v[o]]].clist.push(v[o])}if(k.roomNumber){if(w[t[h].top]===h){this.setTopOfRoom(t.max)}else{t[t.max].top=t[h].top;this.setTopOfRoom(h)}}}else{if(this.lcnt[b]===0||this.lcnt[a]===0){return}if(f===null||e===null||w[f]===w[e]){return}if(k.roomNumber){var u,r;var s=t[w[f]].top,q=t[w[e]].top;var d=bd.cell[s].bx,c=bd.cell[q].bx;if(d>c||(d===c&&s>q)){u=s;r=q}else{u=q;r=s}if(bd.QnC(u)!==-1){if(bd.QnC(r)===-1){bd.sQnC(r,bd.QnC(u));pc.paintCell(r)}bd.sQnC(u,-1);pc.paintCell(u)}}var n=w[f],m=w[e],v=t[m].clist;for(var o=0;o<v.length;o++){w[v[o]]=n;t[n].clist.push(v[o])}t[m]={top:null,clist:[]}}},setTopOfRoom:function(c){var h=null,f=bd.maxbx,e=bd.maxby;var d=this.room[c].clist;for(var b=0;b<d.length;b++){var a=bd.cell[d[b]];if(a.bx>f||(a.bx===f&&a.by>=e)){continue}h=d[b];f=a.bx;e=a.by}this.room[c].top=h},sr0:function(e,d,b){d.id[e]=d.max;d[d.max].clist.push(e);var a;a=bd.up(e);if(a!==null&&d.id[a]!==d.max&&!b(bd.ub(e))){this.sr0(a,d,b)}a=bd.dn(e);if(a!==null&&d.id[a]!==d.max&&!b(bd.db(e))){this.sr0(a,d,b)}a=bd.lt(e);if(a!==null&&d.id[a]!==d.max&&!b(bd.lb(e))){this.sr0(a,d,b)}a=bd.rt(e);if(a!==null&&d.id[a]!==d.max&&!b(bd.rb(e))){this.sr0(a,d,b)}},isBlock:function(a){if(!k.linkNumber){return bd.isBlack(a)}else{return(bd.isNum(a)||(k.NumberWithMB&&(bd.QsC(a)===1)))}return false},initBarea:function(){this.bcell={max:0,id:[]};for(var a=0;a<bd.cellmax;a++){this.bcell.id[a]=null}},resetBarea:function(){this.initBarea();for(var a=0;a<bd.cellmax;a++){this.bcell.id[a]=(this.isBlock(a)?0:null)}for(var a=0;a<bd.cellmax;a++){if(this.bcell.id[a]!==0){continue}this.bcell.max++;this.bcell[this.bcell.max]={clist:[]};this.sc0(a,this.bcell)}},initWarea:function(){this.wcell={max:1,id:[],1:{clist:[]}};for(var a=0;a<bd.cellmax;a++){this.wcell.id[a]=1;this.wcell[1].clist[a]=a}},resetWarea:function(){this.initWarea();this.wcell.max=0;for(var a=0;a<bd.cellmax;a++){this.wcell.id[a]=(bd.isWhite(a)?0:null)}for(var a=0;a<bd.cellmax;a++){if(this.wcell.id[a]!==0){continue}this.wcell.max++;this.wcell[this.wcell.max]={clist:[]};this.sc0(a,this.wcell)}},setCell:function(a,b){if(a==="block"){if(k.checkBlackCell){this.setBWCell(b,bd.isBlack(b),this.bcell)}if(k.checkWhiteCell){this.setBWCell(b,bd.isWhite(b),this.wcell)}}else{if(a==="number"){if(k.linkNumber){this.setBWCell(b,this.isBlock(b),this.bcell)}}}},setBWCell:function(c,o,f){if(!this.isenableRecord()){return}if(o===(f.id[c]!==null)){return}var m=[],b=f.id,e;e=bd.up(c);if(e!==null&&b[e]!==null){m.push(e)}e=bd.dn(c);if(e!==null&&b[e]!==null){m.push(e)}e=bd.lt(c);if(e!==null&&b[e]!==null){m.push(e)}e=bd.rt(c);if(e!==null&&b[e]!==null){m.push(e)}if(o){if(m.length===0){f.max++;f[f.max]={clist:[c]};b[c]=f.max}else{if(m.length===1){f[b[m[0]]].clist.push(c);b[c]=b[m[0]]}else{var j=b[m[0]];for(var h=1;h<m.length;h++){if(f[j].clist.length<f[b[m[h]]].clist.length){j=b[m[h]]}}for(var h=0;h<m.length;h++){if(b[m[h]]===j){continue}var p=f[b[m[h]]].clist;for(var a=0,l=p.length;a<l;a++){b[p[a]]=j;f[j].clist.push(p[a])}p=[]}b[c]=j;f[j].clist.push(c)}}}else{if(m.length===0){f[b[c]].clist=[];b[c]=null}else{if(m.length===1){var d=b[c],p=f[d].clist;for(var h=0;h<p.length;h++){if(p[h]===c){p.splice(h,1);break}}b[c]=null}else{var d=b[c],p=f[d].clist;for(var h=0;h<p.length;h++){b[p[h]]=0}f[d].clist=[];b[c]=null;for(var h=0;h<m.length;h++){if(b[m[h]]!==0){continue}f.max++;f[f.max]={clist:[]};this.sc0(m[h],f)}}}}},sc0:function(d,b){b.id[d]=b.max;b[b.max].clist.push(d);var a;a=bd.up(d);if(a!==null&&b.id[a]===0){this.sc0(a,b)}a=bd.dn(d);if(a!==null&&b.id[a]===0){this.sc0(a,b)}a=bd.lt(d);if(a!==null&&b.id[a]===0){this.sc0(a,b)}a=bd.rt(d);if(a!==null&&b.id[a]===0){this.sc0(a,b)}},getRoomInfo:function(){return this.getAreaInfo(this.room)},getBCellInfo:function(){return this.getAreaInfo(this.bcell)},getWCellInfo:function(){return this.getAreaInfo(this.wcell)},getNumberInfo:function(){return this.getAreaInfo(this.bcell)},getAreaInfo:function(f){var e=new AreaInfo();for(var h=0;h<bd.cellmax;h++){e.id[h]=(f.id[h]>0?0:null)}for(var h=0;h<bd.cellmax;h++){if(e.id[h]!==0){continue}e.max++;var d=f[f.id[h]].clist;e.room[e.max]={idlist:d};for(var b=0,a=d.length;b<a;b++){e.id[d[b]]=e.max}}return e}};Graphic=function(){this.gridcolor="black";this.cellcolor="black";this.errcolor1="rgb(224, 0, 0)";this.errcolor2="rgb(64, 64, 255)";this.errcolor3="rgb(0, 191, 0)";this.circledcolor="white";this.mbcolor="rgb(255, 160, 127)";this.qsubcolor1="rgb(160,255,160)";this.qsubcolor2="rgb(255,255,127)";this.qsubcolor3="rgb(192,192,192)";this.fontcolor="black";this.fontAnscolor="rgb(0, 160, 0)";this.fontErrcolor="rgb(191, 0, 0)";this.fontBCellcolor="rgb(224, 224, 224)";this.borderfontcolor="black";this.bcolor="white";this.dotcolor="black";this.errbcolor1="rgb(255, 160, 160)";this.errbcolor2="rgb(64, 255, 64)";this.icecolor="rgb(192, 224, 255)";this.ttcolor="rgb(127,255,127)";this.borderQuescolor="black";this.borderQanscolor="rgb(0, 191, 0)";this.borderQsubcolor="rgb(255, 0, 255)";this.errborderQanscolor2="rgb(160, 160, 160)";this.bbcolor="rgb(96, 96, 96)";this.linecolor="rgb(0, 160, 0)";this.pekecolor="rgb(32, 32, 255)";this.errlinecolor1="rgb(255, 0, 0)";this.errlinecolor2="rgb(160, 160, 160)";this.targetColor1="rgb(255, 64,  64)";this.targetColor3="rgb(64,  64, 255)";this.bgcolor="";this.gridcolor_BLACK="black";this.gridcolor_LIGHT="rgb(127, 127, 127)";this.gridcolor_DLIGHT="rgb(160, 160, 160)";this.gridcolor_SLIGHT="rgb(191, 191, 191)";this.gridcolor_THIN="rgb(224, 224, 224)";this.bcolor_GREEN="rgb(160, 255, 160)";this.dotcolor_PINK="rgb(255, 96, 191)";this.errbcolor1_DARK="rgb(255, 127, 127)";this.linecolor_LIGHT="rgb(0, 192, 0)";this.fontsizeratio=1;this.crosssize=0.4;this.circleratio=[0.4,0.34];this.range={x1:null,y1:null,x2:null,y2:null,cells:[],crosses:[],borders:[],excells:[]};this.pageX=0;this.pageY=0;this.cw=k.cwidth;this.ch=k.cheight;this.bw=k.bwidth;this.bh=k.bheight;this.lw=1;this.lm=1;this.lwratio=12;this.addlw=0;this.bdheader="b_bd";this.lastHdeg=0;this.lastYdeg=0;this.minYdeg=0.18;this.maxYdeg=0.7;this.zidx=1;this.zidx_array=[];this.cell_arrow_qdir=false;this.EL_NUMOBJ=ee.addTemplate("numobj_parent","div",{className:"divnum",unselectable:"on"},null,null);this.numobj={};this.fillTextEmulate=false;this.outputImage=false;this.isdrawBC=false;this.isdrawBD=false;this.STROKE=0;this.FILL=1;this.FILL_STROKE=2;this.NONE=3;this.vnop_FILL=[false,true,true,false];this.vnop_STROKE=[true,false,true,false]};Graphic.prototype={resize_canvas:function(){var e=ee.windowWidth()-6,d;var j=(bd.maxbx-bd.minbx)/2+2*k.bdmargin;var m=(bd.maxby-bd.minby)/2+2*k.bdmargin;if(k.puzzleid==="box"){j++;m++}var a={0:(19/36),1:0.75,2:1,3:1.5,4:3}[pp.getVal("size")];var f={base:a,limit:0.4},h={base:0.8,limit:0.96},n=[];n[0]=(e*h.base)/(k.cellsize*f.base);n[1]=(e*h.limit)/(k.cellsize*f.limit);if(k.mobile){d=e*0.98;k.cwidth=k.cheight=((d*0.92)/j)|0;if(k.cwidth<k.cellsize){k.cwidth=k.cheight=k.cellsize}}else{if(!pp.getVal("adjsize")||j<n[0]){d=e*h.base-4;k.cwidth=k.cheight=(k.cellsize*f.base)|0}else{if(j<n[1]){var b=h.base+(h.limit-h.base)*((k.qcols-n[0])/(n[1]-n[0]));d=e*b-4;k.cwidth=k.cheight=(d/j)|0}else{d=e*h.limit-4;k.cwidth=k.cheight=(k.cellsize*f.limit)|0}}}k.bwidth=k.cwidth/2;k.bheight=k.cheight/2;ee("main").el.style.width=""+(d|0)+"px";if(k.mobile){ee("menuboard").el.style.width="90%"}var c,l;c=l=(k.cwidth*k.bdmargin)|0;if(!!k.isexcell){c+=k.cwidth;l+=k.cheight}g.changeSize((j*k.cwidth)|0,(m*k.cheight)|0);g.translate(c,l);var i=ee("divques").getRect();this.pageX=(c+i.left);this.pageY=(l+i.top);this.onresize_process()},onresize_process:function(){this.resetVectorFunctions();kp.resize();bd.setcoordAll();this.cw=k.cwidth;this.ch=k.cheight;this.bw=k.bwidth;this.bh=k.bheight;this.lw=Math.max(k.cwidth/this.lwratio,3);this.lm=(this.lw-1)/2;this.fillTextEmulate=(g.use.canvas&&!_doc.createElement("canvas").getContext("2d").fillText);if(g.use.canvas){g.elements=[]}this.flushCanvasAll();this.paintAll()},paint:function(){},prepaint:function(b,d,a,c){this.setRange(b,d,a,c);this.flushCanvas();this.paint()},setRange:function(b,d,a,c){if(g.use.canvas){if(this.isdrawBC||this.isdrawBD){b--;d--;a++;c++}}this.range={x1:b,y1:d,x2:a,y2:c,cells:bd.cellinside(b,d,a,c),crosses:[],borders:[],excells:[]};if(!!k.iscross){this.range.crosses=bd.crossinside(b,d,a,c)}if(!!k.isborder){this.range.borders=bd.borderinside(b,d,a,c)}if(!!k.isexcell){this.range.excells=bd.excellinside(b,d,a,c)}},paintAll:function(){this.prepaint(bd.minbx-1,bd.minby-1,bd.maxbx+1,bd.maxby+1)},paintRange:function(b,d,a,c){this.prepaint(b,d,a,c)},paintPos:function(a){this.prepaint(a.x-1,a.y-1,a.x+1,a.y+1)},paintCell:function(a){if(isNaN(a)||!bd.cell[a]){return}this.prepaint(bd.cell[a].bx-1,bd.cell[a].by-1,bd.cell[a].bx+1,bd.cell[a].by+1)},paintCellAround:function(a){if(isNaN(a)||!bd.cell[a]){return}this.prepaint(bd.cell[a].bx-3,bd.cell[a].by-3,bd.cell[a].bx+3,bd.cell[a].by+3)},paintCross:function(a){if(isNaN(a)||!bd.cross[a]){return}this.prepaint(bd.cross[a].bx-1,bd.cross[a].by-1,bd.cross[a].bx+1,bd.cross[a].by+1)},paintBorder:function(a){if(isNaN(a)||!bd.border[a]){return}if(bd.border[a].bx&1){this.prepaint(bd.border[a].bx-2,bd.border[a].by-1,bd.border[a].bx+2,bd.border[a].by+1)}else{this.prepaint(bd.border[a].bx-1,bd.border[a].by-2,bd.border[a].bx+1,bd.border[a].by+2)}},paintLine:function(a){if(isNaN(a)||!bd.border[a]){return}if(bd.border[a].bx&1){this.prepaint(bd.border[a].bx-1,bd.border[a].by-2,bd.border[a].bx+1,bd.border[a].by+2)}else{this.prepaint(bd.border[a].bx-2,bd.border[a].by-1,bd.border[a].bx+2,bd.border[a].by+1)}},paintEXcell:function(a){if(isNaN(a)||!bd.excell[a]){return}this.prepaint(bd.excell[a].bx-1,bd.excell[a].by-1,bd.excell[a].bx+1,bd.excell[a].by+1)},getNewLineColor:function(){var i=0;while(1){var f=((Math.random()*384)|0)-64;if(f<0){f=0}if(f>255){f=255}var e=((Math.random()*384)|0)-64;if(e<0){e=0}if(e>255){e=255}var j=((Math.random()*384)|0)-64;if(j<0){j=0}if(j>255){j=255}var a=Math.max(f,Math.max(e,j));var l=Math.min(f,Math.min(e,j));var c=0;var b=(a+l)*0.5/255;var d=(a===l?0:(a-l)/((b<=0.5)?(a+l):(2*255-a-l)));if(a==l){c=0}else{if(f>=e&&f>=j){c=(60*(e-j)/(a-l)+360)%360}else{if(e>=f&&e>=j){c=(120+60*(j-f)/(a-l)+360)%360}else{if(j>=e&&j>=f){c=(240+60*(f-e)/(a-l)+360)%360}}}}var h=(0.29891*f+0.58661*e+0.11448*j)/255;if((this.minYdeg<h&&h<this.maxYdeg)&&(Math.abs(this.lastYdeg-h)>0.15)&&(d<0.02||0.4<d)&&(((360+this.lastHdeg-c)%360>=45)&&((360+this.lastHdeg-c)%360<=315))){this.lastHdeg=c;this.lastYdeg=h;return"rgb("+f+","+e+","+j+")"}i++;if(i>100){return"rgb("+f+","+e+","+j+")"}}},drawBlackCells:function(){this.vinc("cell_front","crispEdges");var e="c_fullb_";var b=this.range.cells;for(var a=0;a<b.length;a++){var d=b[a];if(this.setCellColor(d)){if(this.vnop(e+d,this.FILL)){g.fillRect(bd.cell[d].px,bd.cell[d].py,this.cw+1,this.ch+1)}}else{this.vhide(e+d);continue}}this.isdrawBC=true},setCellColor:function(b){var a=bd.cell[b].error;if(bd.cell[b].qans!==1){return false}else{if(a===0){g.fillStyle=this.cellcolor;return true}else{if(a===1){g.fillStyle=this.errcolor1;return true}}}return false},setCellColorFunc:function(a){switch(a){case"qnum":this.setCellColor=function(d){var b=bd.cell[d].error;if(bd.cell[d].qnum===-1){return false}else{if(b===0){g.fillStyle=this.cellcolor;return true}else{if(b===1){g.fillStyle=this.errcolor1;return true}}}return false};break;default:break}},drawBGCells:function(){this.vinc("cell_back","crispEdges");var e="c_full_";var b=this.range.cells;for(var a=0;a<b.length;a++){var d=b[a];if(this.setBGCellColor(d)){if(this.vnop(e+d,this.FILL)){g.fillRect(bd.cell[d].px,bd.cell[d].py,this.cw,this.ch)}}else{this.vhide(e+d);continue}}},setBGCellColor:function(a){if(bd.cell[a].error===1){g.fillStyle=this.errbcolor1;return true}return false},setBGCellColorFunc:function(a){switch(a){case"error2":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.error===2){g.fillStyle=this.errbcolor2;return true}}return false};break;case"qans1":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.qans===1){g.fillStyle=(b.error===1?this.errcolor1:this.cellcolor);return true}if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.qsub===1&&this.bcolor!=="white"){g.fillStyle=this.bcolor;return true}}return false};break;case"qans2":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.qans===1){if(b.error===0){g.fillStyle=this.cellcolor}else{if(b.error===1){g.fillStyle=this.errcolor1}else{if(b.error===2){g.fillStyle=this.errcolor2}}}return true}if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.qsub===1&&this.bcolor!=="white"){g.fillStyle=this.bcolor;return true}}return false};break;case"qsub1":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.qsub===1){g.fillStyle=this.bcolor;return true}}return false};break;case"qsub2":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.qsub===1){g.fillStyle=this.qsubcolor1;return true}else{if(b.qsub===2){g.fillStyle=this.qsubcolor2;return true}}}return false};this.bcolor="silver";break;case"qsub3":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.qsub===1){g.fillStyle=this.qsubcolor1;return true}else{if(b.qsub===2){g.fillStyle=this.qsubcolor2;return true}else{if(b.qsub===3){g.fillStyle=this.qsubcolor3;return true}}}}return false};break;case"icebarn":this.setBGCellColor=function(d){var b=bd.cell[d];if(b.error===1){g.fillStyle=this.errbcolor1;return true}else{if(b.ques===6){g.fillStyle=this.icecolor;return true}}return false};break;default:break}},drawBGEXcells:function(){this.vinc("excell_back","crispEdges");var e="ex_full_";var a=this.range.excells;for(var b=0;b<a.length;b++){var d=a[b];if(this.setBGEXcellColor(d)){if(this.vnop(e+d,this.FILL)){g.fillRect(bd.excell[d].px+1,bd.excell[d].py+1,this.cw-1,this.ch-1)}}else{this.vhide(e+d);continue}}},setBGEXcellColor:function(a){if(bd.excell[a].error===1){g.fillStyle=this.errbcolor1;return true}return false},drawDotCells:function(h){this.vinc("cell_dot",(h?"crispEdges":"auto"));var f=Math.max(this.cw*(h?0.075:0.06),2);var e="c_dot_";g.fillStyle=this.dotcolor;var b=this.range.cells;for(var a=0;a<b.length;a++){var d=b[a];if(bd.cell[d].qsub===1){if(this.vnop(e+d,this.NONE)){if(h){g.fillRect(bd.cell[d].cpx-f,bd.cell[d].cpy-f,f*2,f*2)}else{g.fillCircle(bd.cell[d].cpx,bd.cell[d].cpy,f)}}}else{this.vhide(e+d)}}},drawArrowCells:function(o){this.vinc("cell_arrow","auto");var d=["c_arup_","c_ardn_","c_arlt_","c_arrt_"];var n=this.cw*0.8;var f=Math.max(this.cw/18,2);var l=n*0.5,b=f*0.5;var p=n*0.5-n*0.3;var j=Math.max(n*0.2,5);var r=this.range.cells;for(var h=0;h<r.length;h++){var m=r[h],e=(this.cell_arrow_qdir?bd.cell[m].qdir:bd.getNum(m));this.vhide([d[0]+m,d[1]+m,d[2]+m,d[3]+m]);if(e>=1&&e<=4){g.fillStyle=(bd.cell[m].qnum!==-1?this.fontcolor:this.fontAnscolor);if(this.vnop(d[(e-1)]+m,this.FILL)){var a=px=bd.cell[m].cpx;var q=py=bd.cell[m].cpy;switch(e){case k.UP:g.setOffsetLinePath(a,q,0,-l,-j,-p,-b,-p,-b,l,b,l,b,-p,j,-p,true);break;case k.DN:g.setOffsetLinePath(a,q,0,l,-j,p,-b,p,-b,-l,b,-l,b,p,j,p,true);break;case k.LT:g.setOffsetLinePath(a,q,-l,0,-p,-j,-p,-b,l,-b,l,b,-p,b,-p,j,true);break;case k.RT:g.setOffsetLinePath(a,q,l,0,p,-j,p,-b,-l,-b,-l,b,p,b,p,j,true);break}g.fill()}}}},drawNumbers:function(){this.vinc("cell_number","auto");var b=this.range.cells;for(var a=0;a<b.length;a++){this.drawNumber1(b[a])}},drawNumber1:function(i){var f=bd.cell[i],e=["cell",i].join("_"),d=bd.getNum(i);if(d>0||(k.dispzero&&d===0)||(k.isDispHatena&&d===-2)){var h=(d>=0?""+d:"?");var b=(d<10?0.8:(d<100?0.7:0.55));var a=this.getCellNumberColor(i);this.dispnum(e,1,h,b,a,f.cpx,f.cpy)}else{this.hidenum(e)}},getCellNumberColor:function(d){var b=bd.cell[d],a=this.fontcolor;if(!k.isAnsNumber&&((k.BlackCell&&b.qans===1)||(!k.BlackCell&&b.ques!==0))){a=this.fontBCellcolor}else{if(b.error===1||b.error===4){a=this.fontErrcolor}else{if(k.isAnsNumber&&b.qnum===-1){a=this.fontAnscolor}}}return a},drawArrowNumbers:function(){this.vinc("cell_arrownumber","auto");var d=["c_ar1_","c_dt1_","c_dt2_","c_ar3_","c_dt3_","c_dt4_"];var r=this.cw*0.7;var n=(this.cw-r)/2;var f=Math.max(this.cw/24,1);var q=f/2;var u=this.range.cells;for(var m=0;m<u.length;m++){var p=u[m];if(bd.cell[p].qnum!==-1&&(bd.cell[p].qnum!==-2||k.isDispHatena)){var a=px=bd.cell[p].px,t=py=bd.cell[p].py,e=bd.cell[p].qdir;if(bd.cell[p].qans===1){g.fillStyle=this.fontBCellcolor}else{if(bd.cell[p].error===1){g.fillStyle=this.fontErrcolor}else{g.fillStyle=this.fontcolor}}if(e===k.UP||e===k.DN){a+=(this.cw-n*1.5-q);t+=(n+1);if(this.vnop(d[0]+p,this.FILL)){g.fillRect(a,t,f,r)}a+=f/2;if(e===k.UP){if(this.vnop(d[1]+p,this.FILL)){g.setOffsetLinePath(a,t,0,0,-r/6,r/3,r/6,r/3,true);g.fill()}}else{this.vhide(d[1]+p)}if(e===k.DN){if(this.vnop(d[2]+p,this.FILL)){g.setOffsetLinePath(a,t+r,0,0,-r/6,-r/3,r/6,-r/3,true);g.fill()}}else{this.vhide(d[2]+p)}}else{this.vhide([d[0]+p,d[1]+p,d[2]+p])}if(e===k.LT||e===k.RT){a+=(n+1);t+=(n*1.5-q);if(this.vnop(d[3]+p,this.FILL)){g.fillRect(a,t,r,f)}t+=f/2;if(e===k.LT){if(this.vnop(d[4]+p,this.FILL)){g.setOffsetLinePath(a,t,0,0,r/3,-r/6,r/3,r/6,true);g.fill()}}else{this.vhide(d[4]+p)}if(e===k.RT){if(this.vnop(d[5]+p,this.FILL)){g.setOffsetLinePath(a+r,t,0,0,-r/3,-r/6,-r/3,r/6,true);g.fill()}}else{this.vhide(d[5]+p)}}else{this.vhide([d[3]+p,d[4]+p,d[5]+p])}var o=bd.getNum(p),s=(o>=0?""+o:"?");var b=(o<10?0.8:(o<100?0.7:0.55));var l=g.fillStyle;var j=bd.cell[p].cpx,h=bd.cell[p].cpy;if(e===k.UP||e===k.DN){b*=0.85;j-=this.cw*0.1}else{if(e===k.LT||e===k.RT){b*=0.85;h+=this.ch*0.1}}this.dispnum("cell_"+p,1,s,b,l,j,h)}else{this.vhide([d[0]+p,d[1]+p,d[2]+p,d[3]+p,d[4]+p,d[5]+p]);this.hidenum("cell_"+p)}}},drawHatenas:function(){this.vinc("cell_number","auto");var d=this.range.cells;for(var c=0;c<d.length;c++){var e=bd.cell[d[c]],b="cell_"+d[c];if(e.ques===-2||e.qnum===-2){var a=(e.error===1?this.fontErrcolor:this.fontcolor);this.dispnum(b,1,"?",0.8,a,e.cpx,e.cpy)}else{this.hidenum(b)}}},drawCrosses:function(){this.vinc("cross_base","auto");var d=this.cw*this.crosssize+1;var j="x_cp_";g.lineWidth=1;var e=this.range.crosses;for(var b=0;b<e.length;b++){var h=e[b],f=bd.cross[h],a=["cross",h].join("_");if(f.qnum!==-1){g.fillStyle=(f.error===1?this.errcolor1:"white");g.strokeStyle="black";if(this.vnop(j+h,this.FILL_STROKE)){g.shapeCircle(f.px,f.py,d)}}else{this.vhide([j+h])}if(f.qnum>=0){this.dispnum(a,1,""+f.qnum,0.6,this.fontcolor,f.px,f.py)}else{this.hidenum(a)}}},drawCrossMarks:function(){this.vinc("cross_mark","auto");var b=this.cw*this.crosssize;var f="x_cm_";var d=this.range.crosses;for(var a=0;a<d.length;a++){var e=d[a];if(bd.cross[e].qnum===1){g.fillStyle=(bd.cross[e].error===1?this.errcolor1:this.cellcolor);if(this.vnop(f+e,this.FILL)){g.fillCircle(bd.cross[e].px,bd.cross[e].py,b)}}else{this.vhide(f+e)}}},drawBorders:function(){this.vinc("border","crispEdges");var b=this.range.borders;for(var a=0;a<b.length;a++){this.drawBorder1(b[a])}this.isdrawBD=true},drawBorder1:function(i){var a=[this.bdheader,i].join("_");if(this.setBorderColor(i)){if(this.vnop(a,this.FILL)){var f=this.lw+this.addlw,d=this.lm;var h=bd.border[i].bx,e=bd.border[i].by;var c=bd.border[i].px,b=bd.border[i].py;if(e&1){g.fillRect(c-d,b-this.bh-d,f,this.ch+f)}else{if(h&1){g.fillRect(c-this.bw-d,b-d,this.cw+f,f)}}}}else{this.vhide(a)}},setBorderColor:function(a){if(bd.border[a].ques===1){g.fillStyle=this.borderQuescolor;return true}return false},setBorderColorFunc:function(a){switch(a){case"qans":this.setBorderColor=function(c){var b=bd.border[c].error;if(bd.isBorder(c)){if(b===1){g.fillStyle=this.errcolor1}else{if(b===2){g.fillStyle=this.errborderQanscolor2}else{g.fillStyle=this.borderQanscolor}}return true}return false};break;case"ice":this.setBorderColor=function(d){var c=bd.border[d].cellcc[0],b=bd.border[d].cellcc[1];if(c!==null&&b!==null&&(bd.cell[c].ques===6^bd.cell[b].ques===6)){g.fillStyle=this.cellcolor;return true}return false};break}},drawBorderQsubs:function(){this.vinc("border_qsub","crispEdges");var a=this.cw*0.15;var e="b_qsub1_";g.fillStyle=this.borderQsubcolor;var c=this.range.borders;for(var b=0;b<c.length;b++){var d=c[b];if(bd.border[d].qsub===1){if(this.vnop(e+d,this.NONE)){if(bd.border[d].bx&1){g.fillRect(bd.border[d].px,bd.border[d].py-this.bh+a,1,this.ch-2*a)}else{if(bd.border[d].by&1){g.fillRect(bd.border[d].px-this.bw+a,bd.border[d].py,this.cw-2*a,1)}}}}else{this.vhide(e+d)}}},drawBoxBorders:function(r){this.vinc("boxborder","crispEdges");var h=this.lw,q=this.lm;var e=this.cw;var t=this.ch;var x=["u","d","l","r"];g.fillStyle=this.bbcolor;var J=this.range.cells;for(var E=0;E<J.length;E++){var I=J[E],j=[];for(var z=0;z<12;z++){j[z]=["c_bb",z,I].join("_")}if(bd.cell[I].qans!==1){this.vhide(j);continue}var H=bd.cell[I].bx,G=bd.cell[I].by;var w=bd.cell[I].px,u=bd.cell[I].py;var D=w+q+1,C=w+e-q-1;var d=u+q+1,b=u+t-q-1;var l=(G>2),A=(G<2*k.qrows-2);var f=(H>2),a=(H<2*k.qcols-2);var s=(!l||bd.border[bd.bnum(H,G-1)].ques===1);var B=(!A||bd.border[bd.bnum(H,G+1)].ques===1);var m=(!f||bd.border[bd.bnum(H-1,G)].ques===1);var o=(!a||bd.border[bd.bnum(H+1,G)].ques===1);var v=(!l||!f||bd.border[bd.bnum(H-2,G-1)].ques===1||bd.border[bd.bnum(H-1,G-2)].ques===1);var p=(!l||!a||bd.border[bd.bnum(H+2,G-1)].ques===1||bd.border[bd.bnum(H+1,G-2)].ques===1);var F=(!A||!f||bd.border[bd.bnum(H-2,G+1)].ques===1||bd.border[bd.bnum(H-1,G+2)].ques===1);var y=(!A||!a||bd.border[bd.bnum(H+2,G+1)].ques===1||bd.border[bd.bnum(H+1,G+2)].ques===1);if(s){if(this.vnop(j[0],this.NONE)){g.fillRect(D,d,e-h,1)}}else{this.vhide(j[0])}if(B){if(this.vnop(j[1],this.NONE)){g.fillRect(D,b,e-h,1)}}else{this.vhide(j[1])}if(m){if(this.vnop(j[2],this.NONE)){g.fillRect(D,d,1,t-h)}}else{this.vhide(j[2])}if(o){if(this.vnop(j[3],this.NONE)){g.fillRect(C,d,1,t-h)}}else{this.vhide(j[3])}if(r){if(!s&&(v||m)){if(this.vnop(j[4],this.NONE)){g.fillRect(D,u-q,1,h+1)}}else{this.vhide(j[4])}if(!s&&(p||o)){if(this.vnop(j[5],this.NONE)){g.fillRect(C,u-q,1,h+1)}}else{this.vhide(j[5])}if(!m&&(v||s)){if(this.vnop(j[6],this.NONE)){g.fillRect(w-q,d,h+1,1)}}else{this.vhide(j[6])}if(!m&&(F||B)){if(this.vnop(j[7],this.NONE)){g.fillRect(w-q,b,h+1,1)}}else{this.vhide(j[7])}}else{if(!s&&(v||m)){if(this.vnop(j[4],this.NONE)){g.fillRect(D,u,1,q+1)}}else{this.vhide(j[4])}if(!s&&(p||o)){if(this.vnop(j[5],this.NONE)){g.fillRect(C,u,1,q+1)}}else{this.vhide(j[5])}if(!B&&(F||m)){if(this.vnop(j[6],this.NONE)){g.fillRect(D,b,1,q+1)}}else{this.vhide(j[6])}if(!B&&(y||o)){if(this.vnop(j[7],this.NONE)){g.fillRect(C,b,1,q+1)}}else{this.vhide(j[7])}if(!m&&(v||s)){if(this.vnop(j[8],this.NONE)){g.fillRect(w,d,q+1,1)}}else{this.vhide(j[8])}if(!m&&(F||B)){if(this.vnop(j[9],this.NONE)){g.fillRect(w,b,q+1,1)}}else{this.vhide(j[9])}if(!o&&(p||s)){if(this.vnop(j[10],this.NONE)){g.fillRect(C,d,q+1,1)}}else{this.vhide(j[10])}if(!o&&(y||B)){if(this.vnop(j[11],this.NONE)){g.fillRect(C,b,q+1,1)}}else{this.vhide(j[11])}}}},drawLines:function(){this.vinc("line","crispEdges");var b=this.range.borders;for(var a=0;a<b.length;a++){this.drawLine1(b[a])}this.addlw=0},repaintLines:function(b,c){this.vinc("line","crispEdges");for(var a=0;a<b.length;a++){if(c!==b[a]){this.drawLine1(b[a])}}if(g.use.canvas){this.repaintParts(b)}},repaintParts:function(a){},drawLine1:function(i){var a="b_line_"+i;if(this.setLineColor(i)){if(this.vnop(a,this.FILL)){var f=this.lw+this.addlw,d=this.lm;var h=bd.border[i].bx,e=bd.border[i].by;var c=bd.border[i].px,b=bd.border[i].py;if(k.isCenterLine===!!(h&1)){g.fillRect(c-d,b-this.bh-d,f,this.ch+f)}else{if(k.isCenterLine===!!(e&1)){g.fillRect(c-this.bw-d,b-d,this.cw+f,f)}}}}else{this.vhide(a)}},setLineColor:function(a){this.addlw=0;if(bd.isLine(a)){if(bd.border[a].error===1){g.fillStyle=this.errlinecolor1;if(g.use.canvas){this.addlw=1}}else{if(bd.border[a].error===2){g.fillStyle=this.errlinecolor2}else{if(k.irowake===0||!pp.getVal("irowake")||!bd.border[a].color){g.fillStyle=this.linecolor}else{g.fillStyle=bd.border[a].color}}}return true}return false},drawPekes:function(a){if(!g.use.canvas&&a===2){return}this.vinc("border_peke","auto");var c=this.cw*0.15+1;if(c<4){c=4}var e=["b_peke0_","b_peke1_"];g.fillStyle="white";g.strokeStyle=this.pekecolor;g.lineWidth=1;var d=this.range.borders;for(var b=0;b<d.length;b++){var f=d[b];if(bd.border[f].qsub!==2){this.vhide([e[0]+f,e[1]+f]);continue}if(g.use.canvas){if(a===0||a===2){if(this.vnop(e[0]+f,this.NONE)){g.fillRect(bd.border[f].px-c,bd.border[f].py-c,2*c+1,2*c+1)}}else{this.vhide(e[0]+f)}}if(a===0||a===1){if(this.vnop(e[1]+f,this.NONE)){g.strokeCross(bd.border[f].px,bd.border[f].py,c-1)}}else{this.vhide(e[1]+f)}}},drawBaseMarks:function(){this.vinc("cross_mark","auto");var b=this.range.crosses;for(var a=0;a<b.length;a++){this.drawBaseMark1(b[a])}},drawBaseMark1:function(b){var a="x_cm_"+b;g.fillStyle=this.cellcolor;if(this.vnop(a,this.NONE)){g.fillCircle(bd.cross[b].px,bd.cross[b].py,(this.lw*1.2)/2)}},drawTriangle:function(){this.vinc("cell_triangle","auto");var e=["c_tri2_","c_tri3_","c_tri4_","c_tri5_"];var d=this.range.cells;for(var b=0;b<d.length;b++){var f=d[b];var a=(bd.cell[f].ques!==0?bd.cell[f].ques:bd.cell[f].qans);this.vhide([e[0]+f,e[1]+f,e[2]+f,e[3]+f]);if(a>=2&&a<=5){switch(k.puzzleid){case"reflect":g.fillStyle=((bd.cell[f].error===1||bd.cell[f].error===4)?this.errcolor1:this.cellcolor);break;default:g.fillStyle=this.cellcolor;break}this.drawTriangle1(bd.cell[f].px,bd.cell[f].py,a,e[a-2]+f)}}},drawTriangle1:function(f,e,d,b){if(this.vnop(b,this.FILL)){var c=this.cw,h=this.ch,a=(k.puzzleid==="reflect"?1:0);switch(d){case 2:g.setOffsetLinePath(f,e,a,a,a,h+1,c+1,h+1,true);break;case 3:g.setOffsetLinePath(f,e,c+1,a,a,h+1,c+1,h+1,true);break;case 4:g.setOffsetLinePath(f,e,a,a,c+1,a,c+1,h+1,true);break;case 5:g.setOffsetLinePath(f,e,a,a,c+1,a,a,h+1,true);break}g.fill()}},drawMBs:function(){this.vinc("cell_mb","auto");g.strokeStyle=this.mbcolor;g.lineWidth=1;var b=this.cw*0.35;var e=["c_MB1_","c_MB2a_"];var d=this.range.cells;for(var a=0;a<d.length;a++){var f=d[a];if(bd.cell[f].qsub===0){this.vhide([e[0]+f,e[1]+f]);continue}switch(bd.cell[f].qsub){case 1:if(this.vnop(e[0]+f,this.NONE)){g.strokeCircle(bd.cell[f].cpx,bd.cell[f].cpy,b)}this.vhide(e[1]+f);break;case 2:if(this.vnop(e[1]+f,this.NONE)){g.strokeCross(bd.cell[f].cpx,bd.cell[f].cpy,b)}this.vhide(e[0]+f);break}}},drawQnumCircles:function(){this.vinc("cell_circle","auto");g.lineWidth=Math.max(this.cw*(this.circleratio[0]-this.circleratio[1]),1);var d=this.cw*(this.circleratio[0]+this.circleratio[1])/2;var a=this.cw*this.circleratio[0];var f=["c_cirw_","c_cirb_"];var e=this.range.cells;for(var b=0;b<e.length;b++){var h=e[b];if(bd.cell[h].qnum===1){g.strokeStyle=(bd.cell[h].error===1?this.errcolor1:this.cellcolor);g.fillStyle=(bd.cell[h].error===1?this.errbcolor1:"white");if(this.vnop(f[0]+h,this.FILL_STROKE)){g.shapeCircle(bd.cell[h].cpx,bd.cell[h].cpy,d)}}else{this.vhide(f[0]+h)}if(bd.cell[h].qnum===2){g.fillStyle=(bd.cell[h].error===1?this.errcolor1:this.cellcolor);if(this.vnop(f[1]+h,this.FILL)){g.fillCircle(bd.cell[h].cpx,bd.cell[h].cpy,a)}}else{this.vhide(f[1]+h)}}},drawCirclesAtNumber:function(){this.vinc("cell_circle","auto");var b=this.range.cells;for(var a=0;a<b.length;a++){this.drawCircle1AtNumber(b[a])}},drawCircle1AtNumber:function(e){if(e===null){return}var b=this.cw*this.circleratio[0];var a=this.cw*this.circleratio[1];var d=["c_cira_","c_cirb_"];if(bd.cell[e].qnum!==-1){g.lineWidth=this.cw*0.05;g.fillStyle=(bd.cell[e].error===1?this.errbcolor1:this.circledcolor);if(this.vnop(d[1]+e,this.FILL)){g.fillCircle(bd.cell[e].cpx,bd.cell[e].cpy,a)}g.strokeStyle=(bd.cell[e].error===1?this.errcolor1:this.cellcolor);if(this.vnop(d[0]+e,this.STROKE)){g.strokeCircle(bd.cell[e].cpx,bd.cell[e].cpy,b)}}else{this.vhide([d[0]+e,d[1]+e])}},drawLineParts:function(){this.vinc("cell_lineparts","crispEdges");var b=this.range.cells;for(var a=0;a<b.length;a++){this.drawLineParts1(b[a])}},drawLineParts1:function(a){var c=["c_lp1_"+a,"c_lp2_"+a,"c_lp3_"+a,"c_lp4_"+a];var i=bd.cell[a].ques;if(i>=11&&i<=17){var b=this.lw,l=this.lm;var h=this.bh+this.lm,f=this.bw+this.lm;var n=bd.cell[a].px,m=bd.cell[a].py;var e=bd.cell[a].cpx,d=bd.cell[a].cpy;g.fillStyle=this.borderQuescolor;var j={11:15,12:3,13:12,14:9,15:5,16:6,17:10}[i];if(j&1){if(this.vnop(c[0],this.NONE)){g.fillRect(e-l,m,b,h)}}else{this.vhide(c[0])}if(j&2){if(this.vnop(c[1],this.NONE)){g.fillRect(e-l,d-l,b,h)}}else{this.vhide(c[1])}if(j&4){if(this.vnop(c[2],this.NONE)){g.fillRect(n,d-l,f,b)}}else{this.vhide(c[2])}if(j&8){if(this.vnop(c[3],this.NONE)){g.fillRect(e-l,d-l,f,b)}}else{this.vhide(c[3])}}else{this.vhide(c)}},drawQues51:function(){this.drawEXCellGrid();this.drawSlash51Cells();this.drawSlash51EXcells();this.drawTargetTriangle()},drawSlash51Cells:function(){this.vinc("cell_ques51","crispEdges");var h="c_slash51_";g.strokeStyle=this.cellcolor;g.lineWidth=1;var e=this.range.cells;for(var d=0;d<e.length;d++){var f=e[d],b=bd.cell[f].px,a=bd.cell[f].py;if(bd.cell[f].ques===51){if(this.vnop(h+f,this.NONE)){g.strokeLine(b+1,a+1,b+this.cw,a+this.ch)}}else{this.vhide(h+f)}}},drawSlash51EXcells:function(){this.vinc("excell_ques51","crispEdges");var h="ex_slash51_";g.strokeStyle=this.cellcolor;g.lineWidth=1;var a=this.range.excells;for(var e=0;e<a.length;e++){var f=a[e],d=bd.excell[f].px,b=bd.excell[f].py;if(this.vnop(h+f,this.NONE)){g.strokeLine(d+1,b+1,d+this.cw,b+this.ch)}}},drawEXCellGrid:function(){this.vinc("grid_excell","crispEdges");g.fillStyle=this.cellcolor;var f=["ex_bdx_","ex_bdy_"];var a=this.range.excells;for(var e=0;e<a.length;e++){var h=a[e],d=bd.excell[h].px,b=bd.excell[h].py;if(bd.excell[h].by===-1&&bd.excell[h].bx<bd.maxbx){if(this.vnop(f[0]+h,this.NONE)){g.fillRect(d+this.cw,b,1,this.ch)}}if(bd.excell[h].bx===-1&&bd.excell[h].by<bd.maxby){if(this.vnop(f[1]+h,this.NONE)){g.fillRect(d,b+this.ch,this.cw,1)}}}},drawNumbersOn51:function(){this.vinc("cell_number51","auto");var f=this.range;for(var e=(f.x1|1);e<=f.x2;e+=2){for(var b=(f.y1|1);b<=f.y2;b+=2){if(e!==-1&&b!==-1){var h=bd.cnum(e,b);if(h!==null){this.drawNumbersOn51_1("cell",h)}}else{var a=bd.exnum(e,b);if(a!==null){this.drawNumbersOn51_1("excell",a)}}}}},drawNumbersOn51_1:function(h,m){var a,d,l,j,o,n,f=bd[h][m];var q=[[h,m,"ques51","rt"].join("_"),[h,m,"ques51","dn"].join("_")];if(h==="excell"||bd.cell[m].ques===51){for(var e=0;e<2;e++){if(e===0){a=f.qnum,l=f.by,j=bd.cnum(f.bx+2,f.by),o=4}else{if(e===1){a=f.qdir,l=f.bx,j=bd.cnum(f.bx,f.by+2),o=2}}if(a!==-1&&l!==-1&&j!==null&&bd.cell[j].ques!==51){var b=(f.error===1?this.fontErrcolor:this.fontcolor);var p=(a>=0?""+a:"");this.dispnum(q[e],o,p,0.45,b,f.px+this.bw,f.py+this.bh)}else{this.hidenum(q[e])}}}else{this.hidenum(q[0]);this.hidenum(q[1])}},drawTarget:function(){this.drawCursor(true,k.editmode)},drawCursor:function(b,h){this.vinc("target_cursor","crispEdges");if(h!==false&&pp.getVal("cursor")){var i=this.range;if(tc.cursor.x<i.x1-1||i.x2+1<tc.cursor.x){return}if(tc.cursor.y<i.y1-1||i.y2+1<tc.cursor.y){return}var f=tc.cursor.x*this.bw+0.5;var c=tc.cursor.y*this.bh+0.5;var a,e;if(b!==false){a=(Math.max(this.cw/16,2))|0;e=this.bw-0.5}else{a=(Math.max(this.cw/24,1))|0;e=this.bw*0.56}this.vdel(["ti1_","ti2_","ti3_","ti4_"]);g.fillStyle=(k.editmode?this.targetColor1:this.targetColor3);if(this.vnop("ti1_",this.FILL)){g.fillRect(f-e,c-e,e*2,a)}if(this.vnop("ti2_",this.FILL)){g.fillRect(f-e,c-e,a,e*2)}if(this.vnop("ti3_",this.FILL)){g.fillRect(f-e,c+e-a,e*2,a)}if(this.vnop("ti4_",this.FILL)){g.fillRect(f+e-a,c-e,a,e*2)}}else{this.vhide(["ti1_","ti2_","ti3_","ti4_"])}},drawTargetTriangle:function(){this.vinc("target_triangle","auto");var a="target_triangle";this.vdel([a]);if(k.playmode){return}var e=this.range;if(tc.cursor.x<e.x1||e.x2<tc.cursor.x){return}if(tc.cursor.y<e.y1||e.y2<tc.cursor.y){return}var f=tc.getTCC(),b=null;if(f===null){b=tc.getTEC()}var c=kc.detectTarget(f,b);if(c===0){return}g.fillStyle=this.ttcolor;this.drawTriangle1((tc.cursor.x>>1)*this.cw,(tc.cursor.y>>1)*this.ch,(c===2?4:2),a)},drawDashedCenterLines:function(){this.vinc("centerline","crispEdges");var d=this.range.x1,p=this.range.y1,b=this.range.x2,n=this.range.y2;if(d<bd.minbx+1){d=bd.minbx+1}if(b>bd.maxbx-1){b=bd.maxbx-1}if(p<bd.minby+1){p=bd.minby+1}if(n>bd.maxby-1){n=bd.maxby-1}d|=1,p|=1;if(g.use.canvas){g.fillStyle=this.gridcolor;for(var h=d;h<=b;h+=2){for(var e=(p*this.bh),m=(n*this.bh);e<m;e+=6){g.fillRect(h*this.bw,e,1,3)}}for(var h=p;h<=n;h+=2){for(var e=(d*this.bw),m=(b*this.bw);e<m;e+=6){g.fillRect(e,h*this.bh,3,1)}}}else{g.lineWidth=1;g.strokeStyle=this.gridcolor;for(var h=d;h<=b;h+=2){if(this.vnop("cliney_"+h,this.NONE)){var q=h*this.bw,c=p*this.bh,a=n*this.bh;g.strokeLine(q,c,q,a);g.setDashSize(3)}}for(var h=p;h<=n;h+=2){if(this.vnop("clinex_"+h,this.NONE)){var o=h*this.bh,l=d*this.bw,f=b*this.bw;g.strokeLine(l,o,f,o);g.setDashSize(3)}}}},drawGrid:function(h,o){this.vinc("grid","crispEdges");var c=this.range.x1,l=this.range.y1,b=this.range.x2,j=this.range.y2;if(c<0){c=0}if(b>2*k.qcols){b=2*k.qcols}if(l<0){l=0}if(j>2*k.qrows){j=2*k.qrows}c-=(c&1),l-=(l&1);var m=((k.isborder!==2&&h!==false)?2:0);var a=Math.max(c,0+m),n=Math.min(b,2*k.qcols-m);var f=Math.max(l,0+m),e=Math.min(j,2*k.qrows-m);if(o!==false){g.fillStyle=this.gridcolor;for(var d=a;d<=n;d+=2){if(this.vnop("bdy_"+d,this.NONE)){g.fillRect(d*this.bw,l*this.bh,1,(j-l)*this.bh+1)}}for(var d=f;d<=e;d+=2){if(this.vnop("bdx_"+d,this.NONE)){g.fillRect(c*this.bw,d*this.bh,(b-c)*this.bw+1,1)}}}else{if(!g.use.canvas){for(var d=a;d<=n;d+=2){this.vhide("bdy_"+d)}for(var d=f;d<=e;d+=2){this.vhide("bdx_"+d)}}}},drawDashedGrid:function(m){this.vinc("grid","crispEdges");var y=this.range.x1,l=this.range.y1,w=this.range.x2,f=this.range.y2;if(y<bd.minbx){y=bd.minbx}if(w>bd.maxbx){w=bd.maxbx}if(l<bd.minby){l=bd.minby}if(f>bd.maxby){f=bd.maxby}y-=(y&1),l-=(l&1);var q=this.cw/10+3;var e=Math.max(this.cw/q,1);var b=this.cw/(e*2);var z=((m!==false)?2:0);var x=Math.max(y,bd.minbx+z),t=Math.min(w,bd.maxbx-z);var h=Math.max(l,bd.minby+z),d=Math.min(f,bd.maxby-z);if(g.use.canvas){g.fillStyle=this.gridcolor;for(var u=x;u<=t;u+=2){var o=u*this.bw;for(var r=(l*this.bh),v=(f*this.bh);r<v;r+=(2*b)){g.fillRect(o,r,1,b)}}for(var u=h;u<=d;u+=2){var n=u*this.bh;for(var r=(y*this.bw),v=(w*this.bw);r<v;r+=(2*b)){g.fillRect(r,n,b,1)}}}else{g.lineWidth=1;g.strokeStyle=this.gridcolor;for(var u=x;u<=t;u+=2){if(this.vnop("bdy_"+u,this.NONE)){var o=u*this.bw+0.5,c=l*this.bh,a=f*this.bh;g.strokeLine(o,c,o,a);g.setDashSize(b)}}for(var u=h;u<=d;u+=2){if(this.vnop("bdx_"+u,this.NONE)){var n=u*this.bh+0.5,s=y*this.bw,p=w*this.bw;g.strokeLine(s,n,p,n);g.setDashSize(b)}}}},drawChassis:function(){this.vinc("chassis","crispEdges");var b=this.range.x1,i=this.range.y1,a=this.range.x2,h=this.range.y2;if(b<0){b=0}if(a>2*k.qcols){a=2*k.qcols}if(i<0){i=0}if(h>2*k.qrows){h=2*k.qrows}var d=(k.puzzleid!=="bosanowa"?this.lw:1),f=this.bw,e=this.bh;var c=k.qcols*this.cw,j=k.qrows*this.ch;g.fillStyle="black";if(g.use.canvas){if(b===0){g.fillRect(-d+1,i*e-d+1,d,(h-i)*e+2*d-2)}if(a===2*k.qcols){g.fillRect(c,i*e-d+1,d,(h-i)*e+2*d-2)}if(i===0){g.fillRect(b*f-d+1,-d+1,(a-b)*f+2*d-2,d)}if(h===2*k.qrows){g.fillRect(b*f-d+1,j,(a-b)*f+2*d-2,d)}}else{if(this.vnop("chs1_",this.NONE)){g.fillRect(-d+1,-d+1,d,j+2*d-2)}if(this.vnop("chs2_",this.NONE)){g.fillRect(c,-d+1,d,j+2*d-2)}if(this.vnop("chs3_",this.NONE)){g.fillRect(-d+1,-d+1,c+2*d-2,d)}if(this.vnop("chs4_",this.NONE)){g.fillRect(-d+1,j,c+2*d-2,d)}}},drawChassis_ex1:function(w){this.vinc("chassis_ex1","crispEdges");var s=this.range.x1,d=this.range.y1,q=this.range.x2,b=this.range.y2;if(s<=0){s=bd.minbx}if(q>bd.maxbx){q=bd.maxbx}if(d<=0){d=bd.minby}if(b>bd.maxby){b=bd.maxby}var h=this.lw,j=this.lm,t=this.bw,e=this.bh;var f=k.qcols*this.cw,l=k.qrows*this.ch;g.fillStyle="black";if(g.use.canvas){if(s===bd.minbx){g.fillRect(-this.cw-h+1,d*e-h+1,h,(b-d)*e+2*h-2)}if(q===bd.maxbx){g.fillRect(f,d*e-h+1,h,(b-d)*e+2*h-2)}if(d===bd.minby){g.fillRect(s*t-h+1,-this.ch-h+1,(q-s)*t+2*h-2,h)}if(b===bd.maxby){g.fillRect(s*t-h+1,l,(q-s)*t+2*h-2,h)}}else{if(this.vnop("chsex1_1_",this.NONE)){g.fillRect(-this.cw-h+1,-this.ch-h+1,h,l+this.ch+2*h-2)}if(this.vnop("chsex1_2_",this.NONE)){g.fillRect(f,-this.ch-h+1,h,l+this.ch+2*h-2)}if(this.vnop("chsex1_3_",this.NONE)){g.fillRect(-this.cw-h+1,-this.ch-h+1,f+this.cw+2*h-2,h)}if(this.vnop("chsex1_4_",this.NONE)){g.fillRect(-this.cw-h+1,l,f+this.cw+2*h-2,h)}}if(w){if(g.use.canvas){if(s<=0){g.fillRect(-h+1,d*e-h+1,h,(b-d)*e+h-1)}if(d<=0){g.fillRect(s*t-h+1,-h+1,(q-s)*t+h-1,h)}}else{if(this.vnop("chs1_",this.NONE)){g.fillRect(-h+1,-h+1,h,l+h-1)}if(this.vnop("chs2_",this.NONE)){g.fillRect(-h+1,-h+1,f+h-1,h)}}}else{if(g.use.canvas){if(s<=0){g.fillRect(0,d*e,1,(b-d)*e)}if(d<=0){g.fillRect(s*t,0,(q-s)*t,1)}}else{if(this.vnop("chs1_",this.NONE)){g.fillRect(0,0,1,l)}if(this.vnop("chs2_",this.NONE)){g.fillRect(0,0,f,1)}}var a=["chs1_sub_","chs2_sub_"];var v=this.range.cells;for(var o=0;o<v.length;o++){var u=v[o],r=bd.cell[u].bx,p=bd.cell[u].by;var n=bd.cell[u].px,m=bd.cell[u].py;if(r===1){if(bd.cell[u].ques!==51){if(this.vnop(a[0]+p,this.NONE)){g.fillRect(-j,m-j,h,this.ch+h)}}else{this.vhide([a[0]+p])}}if(p===1){if(bd.cell[u].ques!==51){if(this.vnop(a[1]+r,this.NONE)){g.fillRect(n-j,-j,this.cw+h,h)}}else{this.vhide([a[1]+r])}}}}},resetVectorFunctions:function(){this.flushCanvasAll=Graphic.prototype.flushCanvasAll;this.flushCanvas=Graphic.prototype.flushCanvas;this.vnop=Graphic.prototype.vnop;this.vhide=Graphic.prototype.vhide;this.vdel=Graphic.prototype.vdel;this.vinc=Graphic.prototype.vinc},flushCanvasAll:function(){this.flushCanvasAll=((g.use.canvas)?function(){this.numobj={};ee("numobj_parent").el.innerHTML=""}:function(){g.clear();this.zidx=0;this.zidx_array=[];this.numobj={};ee("numobj_parent").el.innerHTML="";this.vinc("board_base","crispEdges");g.fillStyle=(!this.bgcolor?"rgb(255, 255, 255)":this.bgcolor);if(this.vnop("boardfull",this.NONE)){g.fillRect(0,0,k.qcols*this.cw,k.qrows*this.ch)}});this.flushCanvasAll()},flushCanvas:function(){this.flushCanvas=((g.use.canvas)?function(){var a=this.range;g.fillStyle=(!this.bgcolor?"rgb(255, 255, 255)":this.bgcolor);g.fillRect(a.x1*this.bw,a.y1*this.bh,(a.x2-a.x1)*this.bw,(a.y2-a.y1)*this.bh)}:function(){this.zidx=1});this.flushCanvas()},vnop:function(a,b){this.vnop=((g.use.canvas)?f_true:(g.use.vml)?function(c,d){g.vid=c;var e=g.elements[c];if(!e){return true}e.style.display="inline";if(this.vnop_FILL[d]){e.fillcolor=Camp.parse(g.fillStyle)}if(this.vnop_STROKE[d]){e.strokecolor=Camp.parse(g.strokeStyle)}return false}:(g.use.sl)?function(c,d){g.vid=c;var e=g.elements[c];if(!e){return true}e.Visibility="Visible";if(this.vnop_FILL[d]){e.fill=Camp.parse(g.fillStyle)}if(this.vnop_STROKE[d]){e.stroke=Camp.parse(g.strokeStyle)}return false}:function(c,d){g.vid=c;var e=g.elements[c];if(!e){return true}e.removeAttribute("opacity");if(this.vnop_FILL[d]){e.setAttribute("fill",Camp.parse(g.fillStyle))}if(this.vnop_STROKE[d]){e.setAttribute("stroke",Camp.parse(g.strokeStyle))}return false});return this.vnop(a,b)},vshow:function(a){this.vshow=((g.use.canvas)?f_true:function(b){g.vid=b;if(!g.elements[b]){return}if(g.use.svg){g.elements[b].removeAttribute("opacity")}else{if(g.use.vml){g.elements[b].style.display="inline"}else{g.elements[b].Visibility="Visible"}}});this.vshow(a)},vhide:function(a){this.vhide=((g.use.canvas)?f_true:function(b){if(typeof b==="string"){b=[b]}for(var c=0;c<b.length;c++){if(!g.elements[b[c]]){continue}if(g.use.svg){g.elements[b[c]].setAttribute("opacity",0)}else{if(g.use.vml){g.elements[b[c]].style.display="none"}else{g.elements[b[c]].Visibility="Collapsed"}}}});this.vhide(a)},vdel:function(a){this.vdel=((g.use.canvas)?f_true:function(b){for(var c=0;c<b.length;c++){if(!g.elements[b[c]]){continue}if(!g.use.sl){g.target.removeChild(g.elements[b[c]])}else{g.elements[b[c]].Visibility="Collapsed"}g.elements[b[c]]=null}});this.vdel(a)},vinc:function(b,a){this.vinc=((g.use.canvas)?function(d,c){g.setLayer(d);if(c){g.setRendering(c)}}:function(d,c){g.vid="";g.setLayer(d);if(!this.zidx_array[d]){this.zidx++;this.zidx_array[d]=this.zidx;if(c){g.setRendering(c)}if(!g.use.sl){g.getLayerElement().style.zIndex=this.zidx}else{g.getLayerElement()["Canvas.ZIndex"]=this.zidx}}});this.vinc(b,a)},hideEL:function(a){this.hideEL=this.hidenum;this.hidenum(a)},hidenum:function(a){if(this.fillTextEmulate){if(!!this.numobj[a]){this.numobj[a].style.display="none"}}else{this.vhide(["text_"+a])}},dispnum:function(j,e,l,b,c,i,h){var d=(this.cw*b*this.fontsizeratio)|0;if(this.fillTextEmulate){if(k.br.IE6||k.br.IE7){h+=2}var a=this.numobj[j];if(!a){a=this.numobj[j]=ee.createEL(this.EL_NUMOBJ,"")}a.innerHTML=l;a.style.fontSize=(""+d+"px");a.style.color=c;this.numobj[j].style.display="inline";var m=a.offsetWidth;switch(e){case 1:i-=m/2;i+=2;break;case 2:case 5:i+=-this.bw+3;break;case 3:case 4:i-=m;i+=this.bw-1;break}var f=a.offsetHeight;switch(e){case 1:h-=f/2;break;case 4:case 5:h+=-this.bh+1;break;case 2:case 3:h-=f;h+=this.bh+2;break}a.style.left=(pc.pageX+i)+"px";a.style.top=(pc.pageY+h)+"px"}else{g.font=(""+d+"px 'Serif'");g.fillStyle=c;switch(e){case 1:g.textAlign="center";break;case 2:case 5:g.textAlign="left";i+=-this.bw+3;break;case 3:case 4:g.textAlign="right";i+=this.bw-1;break}switch(e){case 1:g.textBaseline="middle";break;case 4:case 5:g.textBaseline="top";h+=-this.bh+1;break;case 2:case 3:g.textBaseline="alphabetic";h+=this.bh-2;break}if(!g.use.canvas&&(e===1||e===4||e===5)){h++}this.vshow("text_"+j);g.fillText(l,i,h);if(k.br.Opera&&g.use.svg){g.lastElement.setAttribute("unselectable","on")}}}};var MouseEvent=function(){this.enableMouse=true;this.inputPoint=new Point(null,null);this.mouseCell;this.inputData;this.firstCell;this.firstPoint=new Point(null,null);this.prevPos=new Address(null,null);this.btn={};this.bordermode;this.ismousedown;this.mousereset();this.mouseoffset={x:0,y:0};if(k.br.IE6||k.br.IE7||k.br.IE8){this.mouseoffset={x:2,y:2}}else{if(k.br.WebKit){this.mouseoffset={x:1,y:1}}}};MouseEvent.prototype={mousereset:function(){this.mouseCell=null;this.inputData=null;this.firstCell=null;this.firstPoint.reset();this.prevPos.reset();this.btn={Left:false,Middle:false,Right:false};this.bordermode=false;this.ismousedown=false;if(this.previdlist!==(void 0)){this.previdlist=new IDList()}},e_mousedown:function(a){if(this.enableMouse){this.btn=this.getMouseButton(a);if(this.btn.Left||this.btn.Right){if(ans.errDisp){bd.errclear()}um.newOperation(true);this.setposition(a);this.ismousedown=true;this.mousedown()}else{if(this.btn.Middle){this.modeflip();this.btn.Middle=false}}}ee.stopPropagation(a);ee.preventDefault(a);return false},e_mouseup:function(a){if(this.enableMouse&&(this.btn.Left||this.btn.Right)){um.newOperation(false);if(!k.mobile){this.setposition(a)}this.ismousedown=false;this.mouseup();this.mousereset()}ee.stopPropagation(a);ee.preventDefault(a);return false},e_mousemove:function(a){if(!!menu.movingpop){return true}if(this.enableMouse&&(this.btn.Left||this.btn.Right)){um.newOperation(false);this.setposition(a);this.ismousedown=false;this.mousemove()}ee.stopPropagation(a);ee.preventDefault(a);return false},e_mouseout:function(a){um.newOperation(false)},mousedown:function(){},mouseup:function(){},mousemove:function(){},getMouseButton:function(d){var c=false,a=false,b=false;if(!k.mobile){if(k.br.IE6||k.br.IE7||k.br.IE8){c=(d.button===1);a=(d.button===4);b=(d.button===2)}else{c=(!!d.which?d.which===1:d.button===0);a=(!!d.which?d.which===2:d.button===1);b=(!!d.which?d.which===3:d.button===2)}}else{c=(d.touches.length===1);b=(d.touches.length>1)}if(((kc.isSHIFT||kc.isMETA)^pp.getVal("lrcheck"))&&(c!==b)){c=!c;b=!b}return{Left:c,Middle:a,Right:b}},setposition:function(a){this.inputPoint.x=ee.pageX(a)-pc.pageX-this.mouseoffset.x;this.inputPoint.y=ee.pageY(a)-pc.pageY-this.mouseoffset.y},notInputted:function(){return !um.changeflag},modeflip:function(){if(k.EDITOR){pp.setVal("mode",(k.playmode?1:3))}},cellid:function(){var a=this.borderpos(0);if(this.inputPoint.x%k.cwidth===0||this.inputPoint.y%k.cheight===0){return null}return bd.cnum(a.x,a.y)},crossid:function(){var a=this.borderpos(0.5);return bd.xnum(a.x,a.y)},excellid:function(){var a=this.borderpos(0);if(this.inputPoint.x%k.cwidth===0||this.inputPoint.y%k.cheight===0){return null}return bd.exnum(a.x,a.y)},borderpos:function(d){var c=d*k.cwidth,b=(this.inputPoint.x+c+2*k.cwidth),a=(this.inputPoint.y+c+2*k.cheight);var f=((b/k.cwidth)|0)*2+((b%k.cwidth<2*c)?0:1)-4;var e=((a/k.cheight)|0)*2+((a%k.cheight<2*c)?0:1)-4;return new Address(f,e)},borderid:function(e){var h=((this.inputPoint.x/k.cwidth)<<1)+1,f=((this.inputPoint.y/k.cheight)<<1)+1;var c=this.inputPoint.x%k.cwidth,a=this.inputPoint.y%k.cheight;if(k.isLineCross){if(!k.isborderAsLine){var d=e*k.cwidth,b=(1-e)*k.cwidth;if((c<d||b<c)&&(a<d||b<a)){return null}}else{var d=(0.5-e)*k.cwidth,b=(0.5+e)*k.cwidth;if(d<c&&c<b&&d<a&&a<b){return null}}}if(c<k.cwidth-a){if(c>a){return bd.bnum(h,f-1)}else{return bd.bnum(h-1,f)}}else{if(c>a){return bd.bnum(h+1,f)}else{return bd.bnum(h,f+1)}}return null},checkBorderMode:function(){var a=this.borderpos(0.25);this.bordermode=(!((a.x&1)&&(a.y&1)))},inputcell:function(){var c=this.cellid();if(c===null||c===this.mouseCell){return}if(this.inputData===null){this.decIC(c)}this.mouseCell=c;if(k.NumberIsWhite&&bd.QnC(c)!==-1&&(this.inputData===1||(this.inputData===2&&pc.bcolor==="white"))){return}if(k.RBBlackCell&&this.inputData===1){if(this.firstCell===null){this.firstCell=c}var b=bd.cell[this.firstCell],a=bd.cell[c];if(((b.bx&2)^(b.by&2))!==((a.bx&2)^(a.by&2))){return}}(this.inputData==1?bd.setBlack:bd.setWhite).call(bd,c);bd.sQsC(c,(this.inputData===2?1:0));pc.paintCell(c)},decIC:function(a){if(pp.getVal("use")==1){if(this.btn.Left){this.inputData=(bd.isWhite(a)?1:0)}else{if(this.btn.Right){this.inputData=((bd.QsC(a)!==1)?2:0)}}}else{if(pp.getVal("use")==2){if(k.NumberIsWhite&&bd.QnC(a)!==-1){this.inputData=((bd.QsC(a)!==1)?2:0)}else{if(this.btn.Left){if(bd.isBlack(a)){this.inputData=2}else{if(bd.QsC(a)===1){this.inputData=0}else{this.inputData=1}}}else{if(this.btn.Right){if(bd.isBlack(a)){this.inputData=0}else{if(bd.QsC(a)===1){this.inputData=1}else{this.inputData=2}}}}}}}},inputqnum:function(){var c=this.cellid();if(c===null||c===this.mouseCell){return}if(c===tc.getTCC()||k.inputQnumDirect){if(k.editmode&&k.roomNumber){c=area.getTopOfRoomByCell(c)}var a=0;if(k.editmode){a=-1}else{if(k.NumberWithMB){a=2}else{if(k.numberAsObject){a=1}}}if(k.puzzleid==="roma"&&k.playmode){a=0}this.inputqnum_main(c,a)}else{var b=tc.getTCC();tc.setTCC(c);pc.paintCell(b)}this.mouseCell=c;pc.paintCell(c)},inputqnum_main:function(d,h){if(k.playmode&&bd.QnC(d)!==Cell.prototype.defqnum){return}var j=bd.nummaxfunc(d),b=(k.dispzero?0:1);var f=bd.getNum(d),a=(k.editmode?0:bd.QsC(d));var c=-1,i=0,e=(k.editmode&&k.isInputHatena);if(this.btn.Left){if(f===j){if(h>=1){i=1}}else{if(a===1){if(h>=2){i=2}}else{if(a===2){c=-1}else{if(f===-1){c=(e?-2:b)}else{if(f===-2){c=b}else{c=f+1}}}}}}else{if(this.btn.Right){if(a===1){c=j}else{if(a===2){i=1}else{if(f===-1&&h>=1){i=h}else{if(f===-1){c=j}else{if(f===-2){c=-1}else{if(f===b){c=(e?-2:-1)}else{c=f-1}}}}}}}}bd.setNum(d,(c-i))},inputQues:function(f){var e=this.cellid();if(e===null){return}var a=false;if(e!==tc.getTCC()){var c=tc.getTCC();tc.setTCC(e);pc.paintCell(c);a=true}else{var d=bd.QuC(e);if(this.btn.Left){for(var b=0;b<f.length-1;b++){if(!a&&d===f[b]){bd.sQuC(e,f[b+1]);a=true}}if(!a&&d===f[f.length-1]){bd.sQuC(e,f[0]);a=true}}else{if(this.btn.Right){for(var b=f.length;b>0;b--){if(!a&&d===f[b]){bd.sQuC(e,f[b-1]);a=true}}if(!a&&d===f[0]){bd.sQuC(e,f[f.length-1]);a=true}}}}if(a){pc.paintCell(e)}},inputMB:function(){var a=this.cellid();if(a===null){return}bd.sQsC(a,(this.btn.Left?[1,2,0]:[2,0,1])[bd.QsC(a)]);pc.paintCell(a)},inputdirec:function(){var c=this.borderpos(0);if(this.prevPos.equals(c)){return}var b=bd.cnum(this.prevPos.x,this.prevPos.y);if(b!==null){if(bd.QnC(b)!==-1){var a=this.getdir(this.prevPos,c);if(a!==k.NONE){bd.sDiC(b,(bd.DiC(b)!==a?a:0));pc.paintCell(b)}}}this.prevPos=c},inputarrow_cell:function(){var c=this.borderpos(0);if(this.prevPos.equals(c)&&this.inputData===1){return}var a=k.NONE,b=bd.cnum(this.prevPos.x,this.prevPos.y);if(b!==null){var a=this.getdir(this.prevPos,c);if(a!==k.NONE){bd.setNum(b,a);pc.paintCell(b);this.mousereset();return}}this.prevPos=c},getdir:function(a,b){if(b.y-a.y===-2){return k.UP}else{if(b.y-a.y===2){return k.DN}else{if(b.x-a.x===-2){return k.LT}else{if(b.x-a.x===2){return k.RT}}}}return k.NONE},inputtile:function(){var h=this.cellid();if(h===null||h===this.mouseCell||bd.QuC(h)===51){return}if(this.inputData===null){this.decIC(h)}this.mouseCell=h;var b=area.getRoomID(h);for(var a=0;a<area.room[b].clist.length;a++){var f=area.room[b].clist[a];if(this.inputData==1||bd.QsC(f)!=3){(this.inputData==1?bd.setBlack:bd.setWhite).call(bd,f);bd.sQsC(f,(this.inputData==2?1:0))}}var e=ans.getSizeOfClist(area.room[b].clist,f_true);pc.paintRange(e.x1,e.y1,e.x2,e.y2)},input51:function(){var a=this.excellid();if(a!==null){var d=new Address(bd.excell[a].bx,bd.excell[a].by);var b=tc.getTCP();tc.setTCP(d);pc.paintPos(b);pc.paintPos(d);return}var c=this.cellid();if(c===null){return}if(c!==tc.getTCC()){var b=tc.getTCP();tc.setTCC(c);pc.paintPos(b)}else{if(this.btn.Left){if(bd.QuC(c)!=51){this.set51cell(c,true)}else{kc.chtarget("shift")}}else{if(this.btn.Right){this.set51cell(c,false)}}}pc.paintCell(c)},set51cell:function(b,a){if(a===true){bd.sQuC(b,51);bd.sQnC(b,0);bd.sDiC(b,0);bd.sAnC(b,-1)}else{bd.sQuC(b,0);bd.sQnC(b,0);bd.sDiC(b,0);bd.sAnC(b,-1)}},inputcross:function(){var b=this.crossid();if(b===null||b===this.mouseCell){return}if(b===tc.getTXC()){if(this.btn.Left){if(bd.QnX(b)==4){bd.sQnX(b,-2)}else{bd.sQnX(b,bd.QnX(b)+1)}}else{if(this.btn.Right){if(bd.QnX(b)==-2){bd.sQnX(b,4)}else{bd.sQnX(b,bd.QnX(b)-1)}}}}else{var a=tc.getTXC();tc.setTXC(b);pc.paintCross(a)}this.mouseCell=b;pc.paintCross(b)},inputcrossMark:function(){var c=this.borderpos(0.24);if((c.x&1)||(c.y&1)){return}var a=(k.iscross===2?0:2);if(c.x<bd.minbx+a||c.x>bd.maxbx-a||c.y<bd.minby+a||c.y>bd.maxby-a){return}var b=bd.xnum(c.x,c.y);if(b===null){return}um.disCombine=1;bd.sQnX(b,(bd.QnX(b)==1)?-1:1);um.disCombine=0;pc.paintCross(b)},inputborder:function(){this.inputBD(0)},inputborderans:function(){if(this.ismousedown){this.checkBorderMode()}if(this.bordermode){this.inputBD(1)}else{this.inputLine1(1)}},inputBD:function(a){var c=this.borderpos(0.35);if(this.prevPos.equals(c)){return}var b=this.getborderID(this.prevPos,c);if(b!==null){if(a!==2){if(this.inputData===null){this.inputData=(bd.isBorder(b)?0:1)}if(this.inputData===1){bd.setBorder(b)}else{if(this.inputData===0){bd.removeBorder(b)}}}else{if(this.inputData===null){this.inputData=(bd.isLine(b)?0:1)}if(this.inputData===1){bd.setLine(b)}else{if(this.inputData===0){bd.removeLine(b)}}}pc.paintBorder(b)}this.prevPos=c},getborderID:function(a,b){if(((b.x&1)===0&&a.x===b.x&&Math.abs(a.y-b.y)===1)||((b.y&1)===0&&a.y===b.y&&Math.abs(a.x-b.x)===1)){return((((a.x+a.y)&1)===1)?bd.bnum(a.x,a.y):bd.bnum(b.x,b.y))}return null},inputLine:function(){if(!k.isborderAsLine){this.inputLine1(0)}else{this.inputBD(2)}},inputQsubLine:function(){this.inputLine1(1)},inputLine1:function(a){var c=this.borderpos(0);if(this.prevPos.equals(c)){return}var b=this.getnb(this.prevPos,c);if(b!==null){if(a===0){if(this.inputData===null){this.inputData=(bd.isLine(b)?0:1)}if(this.inputData===1){bd.setLine(b)}else{if(this.inputData===0){bd.removeLine(b)}}}else{if(a===1){if(this.inputData===null){this.inputData=(bd.QsB(b)===0?1:0)}if(this.inputData===1){bd.sQsB(b,1)}else{if(this.inputData===0){bd.sQsB(b,0)}}}}pc.paintLine(b)}this.prevPos=c},getnb:function(a,b){if(b.y-a.y===-2){return bd.bnum(a.x,a.y-1)}else{if(b.y-a.y===2){return bd.bnum(a.x,a.y+1)}else{if(b.x-a.x===-2){return bd.bnum(a.x-1,a.y)}else{if(b.x-a.x===2){return bd.bnum(a.x+1,a.y)}}}}return null},inputpeke:function(){var b=this.borderpos(0.22);if(this.prevPos.equals(b)){return}var a=bd.bnum(b.x,b.y);if(a!==null){if(this.inputData===null){this.inputData=(bd.QsB(a)===0?2:3)}if(this.inputData===2){bd.setPeke(a)}else{if(this.inputData===3){bd.removeLine(a)}}pc.paintLine(a)}this.prevPos=b},dispRed:function(){var a=this.cellid();this.mousereset();if(a===null||!bd.isBlack(a)){return}if(!k.RBBlackCell){bd.sErC(area.bcell[area.bcell.id[a]].clist,1)}else{this.db0(function(b){return(bd.isBlack(b)&&bd.cell[b].error===0)},a,1)}ans.errDisp=true;pc.paintAll()},db0:function(d,l,a){if(bd.cell[l].error!==0){return}bd.sErC([l],a);var h=bd.cell[l].bx,f=bd.cell[l].by,e=bd.cellinside(h-2,f-2,h+2,f+2);for(var b=0;b<e.length;b++){var j=e[b];if(j!==l&&d(j)){this.db0(d,j,a)}}},dispRedLine:function(){var d=this.borderid(0.15);this.mousereset();if(d===null){return}if(!bd.isLine(d)){var c=(!k.isborderAsLine?this.cellid():this.crossid());if(c===null||(line.iscrossing(c)&&(line.lcntCell(c)==3||line.lcntCell(c)==4))){return}var b,a;if(k.isbordeAsLine==0){b=(c%k.qcols)<<1,a=(c/k.qcols)<<1}else{b=(c%(k.qcols+1))<<1,a=(c/(k.qcols+1))<<1}d=(function(f,e){if(bd.isLine(bd.bnum(f-1,e))){return bd.bnum(f-1,e)}else{if(bd.isLine(bd.bnum(f+1,e))){return bd.bnum(f+1,e)}else{if(bd.isLine(bd.bnum(f,e-1))){return bd.bnum(f,e-1)}else{if(bd.isLine(bd.bnum(f,e+1))){return bd.bnum(f,e+1)}}}}return null})(b,a)}if(d===null){return}bd.sErBAll(2);bd.sErB(line.data[line.data.id[d]].idlist,1);ans.errDisp=true;pc.paintAll()}};KeyEvent=function(){this.enableKey=true;this.isCTRL;this.isMETA;this.isALT;this.isSHIFT;this.isZ;this.isX;this.inUNDO;this.inREDO;this.tcMoved;this.keyPressed;this.ca;this.prev;this.keyreset()};KeyEvent.prototype={keyreset:function(){this.isCTRL=false;this.isMETA=false;this.isALT=false;this.isSHIFT=false;this.isZ=false;this.isX=false;this.inUNDO=false;this.inREDO=false;this.tcMoved=false;this.keyPressed=false;this.prev=null;this.ca=""},e_keydown:function(a){if(this.enableKey){um.newOperation(true);this.ca=this.getchar(a);this.tcMoved=false;if(!this.isZ){bd.errclear()}if(!this.keydown_common(a)){if(this.ca){this.keyinput(this.ca)}this.keyPressed=true}if(this.tcMoved){ee.preventDefault(a);return false}}},e_keyup:function(a){if(this.enableKey){um.newOperation(false);this.ca=this.getchar(a);this.keyPressed=false;if(!this.keyup_common(a)){if(this.ca){this.keyup(this.ca)}}}},e_keypress:function(a){if(this.enableKey){um.newOperation(false);this.ca=this.getcharp(a);if(this.ca){this.keyinput(this.ca)}}},e_SLkeydown:function(b,c){var a={keyCode:c.platformKeyCode,shiftKey:c.shift,ctrlKey:c.ctrl,altKey:false,returnValue:false,preventDefault:f_true};return kc.e_keydown(a)},e_SLkeyup:function(b,c){var a={keyCode:c.platformKeyCode,shiftKey:c.shift,ctrlKey:c.ctrl,altKey:false,returnValue:false,preventDefault:f_true};return kc.e_keyup(a)},keyinput:function(a){},keyup:function(a){},getchar:function(b){if(b.keyCode==38){return k.KEYUP}else{if(b.keyCode==40){return k.KEYDN}else{if(b.keyCode==37){return k.KEYLT}else{if(b.keyCode==39){return k.KEYRT}}}}var a=(!!b.keyCode?b.keyCode:b.charCode);if(48<=a&&a<=57){return(a-48).toString(36)}else{if(65<=a&&a<=90){return(a-55).toString(36)}else{if(96<=a&&a<=105){return(a-96).toString(36)}else{if(112<=a&&a<=123){return"F"+(a-111).toString(10)}else{if(a==32||a==46){return" "}else{if(a==8){return"BS"}else{if(b.shiftKey){return"shift"}}}}}}}return""},getcharp:function(a){if((!!a.keyCode?a.keyCode:a.charCode)==45){return"-"}return""},keydown_common:function(b){var a=false;if(!this.isSHIFT&&b.shiftKey){this.isSHIFT=true}if(!this.isCTRL&&b.ctrlKey){this.isCTRL=true;a=true}if(!this.isMETA&&b.metaKey){this.isMETA=true;a=true}if(!this.isALT&&b.altKey){this.isALT=true;a=true}if(!this.isZ&&this.ca==="z"){this.isZ=true}if(!this.isX&&this.ca==="x"){this.isX=true}if((this.isCTRL||this.isMETA)&&!this.inUNDO&&this.ca=="z"){this.inUNDO=true;a=true;tm.startUndoTimer()}if((this.isCTRL||this.isMETA)&&!this.inREDO&&this.ca=="y"){this.inREDO=true;a=true;tm.startUndoTimer()}if(this.ca=="F2"&&k.EDITOR){if(k.editmode&&!this.isSHIFT){pp.setVal("mode",3);a=true}else{if(k.playmode&&this.isSHIFT){pp.setVal("mode",1);a=true}}}a=(a||debug.keydown(this.ca));return a},keyup_common:function(b){var a=false;if(this.isSHIFT&&!b.shiftKey){this.isSHIFT=false;a=true}if(this.isCTRL&&!b.ctrlKey){this.isCTRL=false;a=true;this.inUNDO=false;this.inREDO=false}if(this.isMETA&&!b.metaKey){this.isMETA=false;a=true;this.inUNDO=false;this.inREDO=false}if(this.isALT&&!b.altKey){this.isALT=false;a=true}if(this.isZ&&this.ca==="z"){this.isZ=false}if(this.isX&&this.ca==="x"){this.isX=false}if((this.isCTRL||this.isMETA)&&this.inUNDO&&this.ca=="z"){this.inUNDO=false;a=true}if((this.isCTRL||this.isMETA)&&this.inREDO&&this.ca=="y"){this.inREDO=false;a=true}return a},moveTCell:function(a){return this.moveTC(a,2)},moveTCross:function(a){return this.moveTC(a,2)},moveTBorder:function(a){return this.moveTC(a,1)},moveTC:function(c,a){var d=tc.getTCP(),b=false;switch(c){case k.KEYUP:if(d.y-a>=tc.miny){tc.decTCY(a);b=true}break;case k.KEYDN:if(d.y+a<=tc.maxy){tc.incTCY(a);b=true}break;case k.KEYLT:if(d.x-a>=tc.minx){tc.decTCX(a);b=true}break;case k.KEYRT:if(d.x+a<=tc.maxx){tc.incTCX(a);b=true}break}if(b){pc.paintPos(d);pc.paintPos(tc.getTCP());this.tcMoved=true}return b},key_inputcross:function(b){var f=tc.getTXC();var a=bd.nummaxfunc(f),e=-1;if("0"<=b&&b<="9"){var c=parseInt(b),d=bd.QnX(f);if(d<=0||d*10+c>a){d=0}e=d*10+c;if(e>a){return}}else{if(b==="-"){bd.sQnX(f,(bd.QnX(f)!==-2?-2:-1))}else{if(b===" "){bd.sQnX(f,-1)}else{return}}}bd.sQnX(f,e);pc.paintCross(f)},key_inputqnum:function(b){var f=tc.getTCC();if(k.editmode&&k.roomNumber){f=area.getTopOfRoomByCell(f)}var a=bd.nummaxfunc(f),e=-1;if("0"<=b&&b<="9"){var c=parseInt(b),d=bd.getNum(f);if(d<=0||d*10+c>a||this.prev!=f){d=0}e=d*10+c;if(e>a){return}}else{if(b==="-"){e=(k.editmode?-2:-1)}else{if(b===" "){e=-1}else{if(b==="s1"){e=-2}else{if(b==="s2"){e=-3}else{return}}}}}bd.setNum(f,e);this.prev=f;pc.paintCell(f)},key_inputdirec:function(b){if(!this.isSHIFT){return false}var c=tc.getTCC();if(k.puzzleid==="firefly"||k.puzzleid==="snakes"||k.puzzleid==="yajikazu"||k.puzzleid==="yajirin"){if(bd.QnC(c)===-1){return false}}var a=true;switch(b){case k.KEYUP:bd.sDiC(c,(bd.DiC(c)!=k.UP?k.UP:0));break;case k.KEYDN:bd.sDiC(c,(bd.DiC(c)!=k.DN?k.DN:0));break;case k.KEYLT:bd.sDiC(c,(bd.DiC(c)!=k.LT?k.LT:0));break;case k.KEYRT:bd.sDiC(c,(bd.DiC(c)!=k.RT?k.RT:0));break;default:a=false}if(a){pc.paintPos(tc.getTCP());this.tcMoved=true}return a},inputnumber51:function(e,a){if(this.chtarget(e)){return}var d=tc.getTCC(),i=null;if(d===null){i=tc.getTEC()}var h=this.detectTarget(d,i);if(h===0||(d!==null&&bd.QuC(d)===51)){if(e==="q"&&d!==null){mv.set51cell(d,(bd.QuC(d)!==51));pc.paintPos(tc.getTCP());return}}if(h==0){return}var b=(h==2?Cell.prototype.defqnum:Cell.prototype.defqdir);var j=a[h],c=b;if("0"<=e&&e<="9"){var f=parseInt(e),l=this.getnum51(d,i,h);if(l<=0||l*10+f>j||this.prev!=d){l=0}c=l*10+f;if(c>j){return}}else{if(e=="-"||e==" "){c=b}else{return}}this.setnum51(d,i,h,c);this.prev=d;pc.paintPos(tc.getTCP())},setnum51:function(d,a,b,c){if(d!=null){(b==2?bd.sQnC(d,c):bd.sDiC(d,c))}else{(b==2?bd.sQnE(a,c):bd.sDiE(a,c))}},getnum51:function(c,a,b){if(c!=null){return(b==2?bd.QnC(c):bd.DiC(c))}else{return(b==2?bd.QnE(a):bd.DiE(a))}},chtarget:function(a){if(a!="shift"){return false}if(tc.targetdir==2){tc.targetdir=4}else{tc.targetdir=2}pc.paintCell(tc.getTCC());return true},detectTarget:function(b,a){if((b===null&&a===null)||(b!==null&&bd.QuC(b)!==51)){return 0}if(b===bd.cellmax-1||a===k.qcols+k.qrows){return 0}if(b!==null){if((bd.rt(b)===null||bd.QuC(bd.rt(b))===51)&&(bd.dn(b)===null||bd.QuC(bd.dn(b))===51)){return 0}else{if(bd.rt(b)===null||bd.QuC(bd.rt(b))===51){return 4}else{if(bd.dn(b)===null||bd.QuC(bd.dn(b))===51){return 2}}}}else{if(a!==null){if((bd.excell[a].by===-1&&bd.QuC(bd.cnum(bd.excell[a].bx,1))===51)||(bd.excell[a].bx===-1&&bd.QuC(bd.cnum(1,bd.excell[a].by))===51)){return 0}else{if(bd.excell[a].by===-1){return 4}else{if(bd.excell[a].bx===-1){return 2}}}}}return tc.targetdir}};KeyPopup=function(){this.haspanel={1:false,3:false};this.element=null;this.prefix;this.tdcolor="black";this.imgCR=[1,1];this.tds=[];this.imgs=[];this.tbodytmp=null;this.trtmp=null;this.ORIGINAL=99;this.EL_KPNUM=ee.addTemplate("","td",{unselectable:"on",className:"kpnum"},null,null);this.EL_KPEMPTY=ee.addTemplate("","td",{unselectable:"on"},null,null);this.EL_KPIMG=ee.addTemplate("","td",{unselectable:"on",className:"kpimgcell"},null,null);this.EL_KPIMG_DIV=ee.addTemplate("","div",{unselectable:"on",className:"kpimgdiv"},null,null);this.EL_KPIMG_IMG=ee.addTemplate("","img",{unselectable:"on",className:"kpimg",src:"./src/img/"+k.puzzleid+"_kp.gif"},null,null)};KeyPopup.prototype={kpinput:function(a){},display:function(){var a=pp.getVal("mode");if(this.element&&this.haspanel[a]&&pp.getVal("keypopup")){this.element.style.display="block";ee("panelbase1").el.style.display=(a==1?"block":"none");ee("panelbase3").el.style.display=(a==3?"block":"none")}else{this.element.style.display="none"}},inputnumber:function(b,a){this.kpinput(a)},generate:function(b,a,d){if(!this.element){var c=ee("divques").getRect();this.element=ee("keypopup").el;this.element.style.left=(c.left+48)+"px";this.element.style.top=(c.top+48)+"px";this.element.style.zIndex=100;ee("barkeypopup").el.ondblclick=function(){pp.setVal("keypopup",false)}}if(a&&k.EDITOR){this.gentable(1,b)}if(d){this.gentable(3,b)}},gentable:function(d,a){this.haspanel[d]=true;this.prefix=["kp",d,"_"].join("");var c=ee("panelbase"+d).el;c.innerHTML="";var b=_doc.createElement("table");b.cellSpacing="2pt";c.appendChild(b);this.tbodytmp=_doc.createElement("tbody");b.appendChild(this.tbodytmp);this.trtmp=null;if(a===this.ORIGINAL){this.kpgenerate(d)}else{if(a===0){this.gentable10(d)}else{if(a===51){this.gentable51(d)}else{this.gentable4(d,a)}}}},kpgenerate:function(a){},gentable10:function(a){this.inputcol("num","knum0","0","0");this.inputcol("num","knum1","1","1");this.inputcol("num","knum2","2","2");this.inputcol("num","knum3","3","3");this.insertrow();this.inputcol("num","knum4","4","4");this.inputcol("num","knum5","5","5");this.inputcol("num","knum6","6","6");this.inputcol("num","knum7","7","7");this.insertrow();this.inputcol("num","knum8","8","8");this.inputcol("num","knum9","9","9");this.inputcol("num","knum_"," "," ");if(a==1){this.inputcol("num","knum.","-","?")}else{this.inputcol("empty","","","")}this.insertrow()},gentable4:function(b,a){this.inputcol("num","knum0","0","0");this.inputcol("num","knum1","1","1");this.inputcol("num","knum2","2","2");this.inputcol("num","knum3","3","3");this.insertrow();this.inputcol("num","knum4","4","4");this.inputcol("empty","","","");this.inputcol("num","knum_"," "," ");if(a==1){this.inputcol("num","knum.","-","?")}else{if(a==2){this.inputcol("num","knum.","-","■")}else{if(a==4){this.inputcol("num","knum.","-","○")}}}this.insertrow()},gentable51:function(a){if(a===3){this.gentable10(a);return}this.inputcol("image","knumq","q",[0,0]);this.inputcol("num","knum_"," "," ");this.inputcol("num","knum1","1","1");this.inputcol("num","knum2","2","2");this.insertrow();this.inputcol("num","knum3","3","3");this.inputcol("num","knum4","4","4");this.inputcol("num","knum5","5","5");this.inputcol("num","knum6","6","6");this.insertrow();this.inputcol("num","knum7","7","7");this.inputcol("num","knum8","8","8");this.inputcol("num","knum9","9","9");this.inputcol("num","knum0","0","0");this.insertrow()},inputcol:function(f,h,b,c){if(!this.trtmp){this.trtmp=_doc.createElement("tr")}var e=null;if(f==="empty"){e=ee.createEL(this.EL_KPEMPTY,"")}else{if(f==="num"){e=ee.createEL(this.EL_KPNUM,this.prefix+h);e.style.color=this.tdcolor;e.innerHTML=c;e.onclick=ee.ebinder(this,this.inputnumber,[b])}else{if(f==="image"){var d=ee.createEL(this.EL_KPIMG_IMG,this.prefix+h+"_i");var a=ee.createEL(this.EL_KPIMG_DIV,"");a.appendChild(d);e=ee.createEL(this.EL_KPIMG,h);e.onclick=ee.ebinder(this,this.inputnumber,[b]);e.appendChild(a);this.imgs.push({el:d,x:c[0],y:c[1]})}}}if(e){this.tds.push(e);this.trtmp.appendChild(e)}},insertrow:function(){if(this.trtmp){this.tbodytmp.appendChild(this.trtmp);this.trtmp=null}},resize:function(){var e=function(f,h){f.style.width=""+((h*0.9)|0)+"px";f.style.height=""+((h*0.9)|0)+"px";f.style.fontSize=""+((h*0.7)|0)+"px"};var d=function(f,h){f.el.style.width=""+(h*kp.imgCR[0])+"px";f.el.style.height=""+(h*kp.imgCR[1])+"px";f.el.style.clip="rect("+(h*f.y+1)+"px,"+(h*(f.x+1))+"px,"+(h*(f.y+1))+"px,"+(h*f.x+1)+"px)";f.el.style.top="-"+(f.y*h+1)+"px";f.el.style.left="-"+(f.x*h+1)+"px"};var b=Math.min(k.cwidth,120);if(b>=24){for(var c=0,a=this.tds.length;c<a;c++){e(this.tds[c],b)}for(var c=0,a=this.imgs.length;c<a;c++){d(this.imgs[c],(b*0.9)|0)}}else{for(var c=0,a=this.tds.length;c<a;c++){e(this.tds[c],22)}for(var c=0,a=this.imgs.length;c<a;c++){d(this.imgs[c],18)}}}};TCell=function(){this.cursor=new Address(1,1);this.minx=1;this.miny=1;this.maxx=2*k.qcols-1;this.maxy=2*k.qrows-1;this.crosstype=false};TCell.prototype={adjust:function(){if(this.crosstype){this.minx=0;this.miny=0;this.maxx=2*k.qcols;this.maxy=2*k.qrows}else{var b=(k.isexcell===1||k.isexcell===2);var a=(k.isexcell===2);this.minx=(!b?1:-1);this.miny=(!b?1:-1);this.maxx=(!a?2*k.qcols-1:2*k.qcols+1);this.maxy=(!a?2*k.qrows-1:2*k.qrows+1)}if(this.cursor.x<this.minx){this.cursor.x=this.minx}if(this.cursor.y<this.miny){this.cursor.y=this.miny}if(this.cursor.x>this.maxx){this.cursor.x=this.maxx}if(this.cursor.y>this.maxy){this.cursor.y=this.maxy}},setAlign:function(){},setCrossType:function(){this.crosstype=true;this.adjust();this.setTCP(new Address(0,0))},incTCX:function(a){this.cursor.x+=a},incTCY:function(a){this.cursor.y+=a},decTCX:function(a){this.cursor.x-=a},decTCY:function(a){this.cursor.y-=a},getTCP:function(){return this.cursor},setTCP:function(a){if(a.x<this.minx||this.maxx<a.x||a.y<this.miny||this.maxy<a.y){return}this.cursor.set(a)},getTCC:function(){return bd.cnum(this.cursor.x,this.cursor.y)},setTCC:function(a){if(!bd.cell[a]){return}this.cursor=new Address(bd.cell[a].bx,bd.cell[a].by)},getTXC:function(){return bd.xnum(this.cursor.x,this.cursor.y)},setTXC:function(a){if(!bd.cross[a]){return}this.cursor=new Address(bd.cross[a].bx,bd.cross[a].by)},getTBC:function(){return bd.bnum(this.cursor.x,this.cursor.y)},setTBC:function(a){if(!bd.border[a]){return}this.cursor=new Address(bd.border[a].bx,bd.border[a].by)},getTEC:function(){return bd.exnum(this.cursor.x,this.cursor.y)},setTEC:function(a){if(!bd.excell[a]){return}this.cursor=new Address(bd.excell[a].bx,bd.excell[a].by)}};Encode=function(){this.pflag="";this.outpflag="";this.outsize="";this.outbstr="";this.PZPRV3=0;this.PZPRV3E=3;this.PZPRAPP=1;this.KANPEN=2;this.KANPENP=5;this.HEYAAPP=4;var a=_doc.domain;if(!a){a="pzv.jp"}else{if(a=="indi.s58.xrea.com"){a="indi.s58.xrea.com/pzpr/v3"}}this.urlbase={};this.urlbase[this.PZPRV3]=["http://",a,"/p.html?%PID%/"].join("");this.urlbase[this.PZPRV3E]=["http://",a,"/p.html?%PID%_edit/"].join("");this.urlbase[this.PZPRAPP]="http://indi.s58.xrea.com/%PID%/sa/q.html?";this.urlbase[this.KANPEN]="http://www.kanpen.net/%KID%.html?problem=";this.urlbase[this.KANPENP]="http://www.kanpen.net/%KID%.html?pzpr=";this.urlbase[this.HEYAAPP]="http://www.geocities.co.jp/heyawake/?problem="};Encode.prototype={checkpflag:function(a){return(this.pflag.indexOf(a)>=0)},pzlinput:function(){var a=base.dec;if(a.cols&&a.rows){bd.initBoardSize(a.cols,a.rows)}if(a.bstr){this.pflag=a.pflag;switch(a.type){case this.PZPRV3:case this.PZPRAPP:case this.PZPRV3E:this.outbstr=a.bstr;this.pzlimport(a.type);break;case this.KANPEN:fio.lineseek=0;fio.dataarray=a.bstr.replace(/_/g," ").split("/");this.decodeKanpen();break;case this.HEYAAPP:this.outbstr=a.bstr;this.decodeHeyaApp();break}um.allerase()}bd.resetInfo();pc.resize_canvas()},pzloutput:function(b){if(b===this.KANPEN&&k.puzzleid=="lits"){b=this.KANPENP}var a="",d=false;this.outpflag="";this.outsize="";this.outbstr="";switch(b){case this.PZPRV3:case this.PZPRV3E:this.pzlexport(this.PZPRV3);a=(!this.outsize?[k.qcols,k.qrows].join("/"):this.outsize);d=(!!this.outpflag);break;case this.PZPRAPP:case this.KANPENP:this.pzlexport(this.PZPRAPP);a=(!this.outsize?[k.qcols,k.qrows].join("/"):this.outsize);d=true;break;case this.KANPEN:fio.datastr="";this.encodeKanpen();this.outbstr=fio.datastr.replace(/ /g,"_");a=(!this.outsize?[k.qrows,k.qcols].join("/"):this.outsize);break;case this.HEYAAPP:this.encodeHeyaApp();a=[k.qcols,k.qrows].join("x");break;default:return""}var c=(d?[this.outpflag]:[]).concat([a,this.outbstr]).join("/");return this.getURLBase(b)+c},getURLBase:function(a){return this.urlbase[a].replace("%PID%",PZLNAME.toURLID(k.puzzleid)).replace("%KID%",PZLNAME.toKanpen(k.puzzleid))},pzlimport:function(a){},pzlexport:function(a){},decodeKanpen:function(){},encodeKanpen:function(){},decodeHeyaApp:function(){},encodeHeyaApp:function(){},decode4Cell:function(){var f=0,d=0,b=this.outbstr;for(d=0;d<b.length;d++){var e=bd.cell[f],a=b.charAt(d);if(this.include(a,"0","4")){e.qnum=parseInt(a,16)}else{if(this.include(a,"5","9")){e.qnum=parseInt(a,16)-5;f++}else{if(this.include(a,"a","e")){e.qnum=parseInt(a,16)-10;f+=2}else{if(this.include(a,"g","z")){f+=(parseInt(a,36)-16)}else{if(a=="."){e.qnum=-2}}}}}f++;if(f>=bd.cellmax){break}}this.outbstr=b.substr(d+1)},encode4Cell:function(){var e=0,a="";for(var f=0;f<bd.cellmax;f++){var b="",d=bd.cell[f].qnum;if(d>=0){if(!!bd.cell[f+1]&&bd.cell[f+1].qnum!==-1){b=""+d.toString(16)}else{if(!!bd.cell[f+2]&&bd.cell[f+2].qnum!==-1){b=""+(5+d).toString(16);f++}else{b=""+(10+d).toString(16);f+=2}}}else{if(d===-2){b="."}else{e++}}if(e===0){a+=b}else{if(b||e===20){a+=((e+15).toString(36)+b);e=0}}}if(e>0){a+=((e+15).toString(36))}this.outbstr+=a},decode4Cross:function(){var f=0,d=0,b=this.outbstr;for(d=0;d<b.length;d++){var e=bd.cross[f],a=b.charAt(d);if(this.include(a,"0","4")){e.qnum=parseInt(a,16)}else{if(this.include(a,"5","9")){e.qnum=parseInt(a,16)-5;f++}else{if(this.include(a,"a","e")){e.qnum=parseInt(a,16)-10;f+=2}else{if(this.include(a,"g","z")){f+=(parseInt(a,36)-16)}else{if(a=="."){e.qnum=-2}}}}}f++;if(f>=bd.crossmax){break}}this.outbstr=b.substr(d+1)},encode4Cross:function(){var e=0,a="";for(var f=0;f<bd.crossmax;f++){var b="",d=bd.cross[f].qnum;if(d>=0){if(!!bd.cross[f+1]&&bd.cross[f+1].qnum!==-1){b=""+d.toString(16)}else{if(!!bd.cross[f+2]&&bd.cross[f+2].qnum!==-1){b=""+(5+d).toString(16);f++}else{b=""+(10+d).toString(16);f+=2}}}else{if(d===-2){b="."}else{e++}}if(e===0){a+=b}else{if(b||e===20){a+=((e+15).toString(36)+b);e=0}}}if(e>0){a+=((e+15).toString(36))}this.outbstr+=a},decodeNumber10:function(){var f=0,d=0,b=this.outbstr;for(d=0;d<b.length;d++){var e=bd.cell[f],a=b.charAt(d);if(a=="."){e.qnum=-2}else{if(this.include(a,"0","9")){e.qnum=parseInt(a,10)}else{if(this.include(a,"a","z")){f+=(parseInt(a,36)-10)}}}f++;if(f>bd.cellmax){break}}this.outbstr=b.substr(d)},encodeNumber10:function(){var a="",e=0;for(var f=0;f<bd.cellmax;f++){var b="",d=bd.cell[f].qnum;if(d===-2){b="."}else{if(d>=0&&d<10){b=d.toString(10)}else{e++}}if(e==0){a+=b}else{if(b||e==26){a+=((9+e).toString(36)+b);e=0}}}if(e>0){a+=(9+e).toString(36)}this.outbstr+=a},decodeNumber16:function(){var f=0,d=0,b=this.outbstr;for(d=0;d<b.length;d++){var e=bd.cell[f],a=b.charAt(d);if(this.include(a,"0","9")||this.include(a,"a","f")){e.qnum=parseInt(a,16)}else{if(a=="-"){e.qnum=parseInt(b.substr(d+1,2),16);d+=2}else{if(a=="+"){e.qnum=parseInt(b.substr(d+1,3),16);d+=3}else{if(a=="="){e.qnum=parseInt(b.substr(d+1,3),16)+4096;d+=3}else{if(a=="%"){e.qnum=parseInt(b.substr(d+1,3),16)+8192;d+=3}else{if(a=="."){e.qnum=-2}else{if(a>="g"&&a<="z"){f+=(parseInt(a,36)-16)}}}}}}}f++;if(f>bd.cellmax){break}}this.outbstr=b.substr(d)},encodeNumber16:function(){var e=0,a="";for(var f=0;f<bd.cellmax;f++){var b="",d=bd.cell[f].qnum;if(d==-2){b="."}else{if(d>=0&&d<16){b=d.toString(16)}else{if(d>=16&&d<256){b="-"+d.toString(16)}else{if(d>=256&&d<4096){b="+"+d.toString(16)}else{if(d>=4096&&d<8192){b="="+(d-4096).toString(16)}else{if(d>=8192){b="%"+(d-8192).toString(16)}else{e++}}}}}}if(e==0){a+=b}else{if(b||e==20){a+=((15+e).toString(36)+b);e=0}}}if(e>0){a+=(15+e).toString(36)}this.outbstr+=a},decodeRoomNumber16:function(){area.resetRarea();var e=1,d=0,b=this.outbstr;for(d=0;d<b.length;d++){var a=b.charAt(d),h=area.getTopOfRoom(e),f=bd.cell[h];if(this.include(a,"0","9")||this.include(a,"a","f")){f.qnum=parseInt(a,16)}else{if(a=="-"){f.qnum=parseInt(b.substr(d+1,2),16);d+=2}else{if(a=="+"){f.qnum=parseInt(b.substr(d+1,3),16);d+=3}else{if(a=="="){f.qnum=parseInt(b.substr(d+1,3),16)+4096;d+=3}else{if(a=="%"){f.qnum=parseInt(b.substr(d+1,3),16)+8192;d+=3}else{if(a=="*"){f.qnum=parseInt(b.substr(d+1,3),16)+12240;d+=4}else{if(a=="$"){f.qnum=parseInt(b.substr(d+1,3),16)+77776;d+=5}else{if(a>="g"&&a<="z"){e+=(parseInt(a,36)-16)}}}}}}}}e++;if(e>area.room.max){break}}this.outbstr=b.substr(d)},encodeRoomNumber16:function(){area.resetRarea();var e=0,a="";for(var d=1;d<=area.room.max;d++){var b="",c=bd.cell[area.getTopOfRoom(d)].qnum;if(c>=0&&c<16){b=c.toString(16)}else{if(c>=16&&c<256){b="-"+c.toString(16)}else{if(c>=256&&c<4096){b="+"+c.toString(16)}else{if(c>=4096&&c<8192){b="="+(c-4096).toString(16)}else{if(c>=8192&&c<12240){b="%"+(c-8192).toString(16)}else{if(c>=12240&&c<77776){b="*"+(c-12240).toString(16)}else{if(c>=77776){b="$"+(c-77776).toString(16)}else{e++}}}}}}}if(e==0){a+=b}else{if(b||e==20){a+=((15+e).toString(36)+b);e=0}}}if(e>0){a+=(15+e).toString(36)}this.outbstr+=a},decodeArrowNumber16:function(){var h=0,e=0,d=this.outbstr;for(e=0;e<d.length;e++){var b=d.charAt(e),f=bd.cell[h];if(this.include(b,"0","4")){var a=d.charAt(e+1);f.qdir=parseInt(b,16);f.qnum=(a!="."?parseInt(a,16):-2);e++}else{if(this.include(b,"5","9")){f.qdir=parseInt(b,16)-5;f.qnum=parseInt(d.substr(e+1,2),16);e+=2}else{if(b>="a"&&b<="z"){h+=(parseInt(b,36)-10)}}}h++;if(h>bd.cellmax){break}}this.outbstr=d.substr(e)},encodeArrowNumber16:function(){var a="",f=0;for(var h=0;h<bd.cellmax;h++){var d="",b=bd.cell[h].qdir,e=bd.cell[h].qnum;if(e===-2){d=(b)+"."}else{if(e>=0&&e<16){d=(b)+e.toString(16)}else{if(e>=16&&e<256){d=(b+5)+e.toString(16)}else{f++}}}if(f===0){a+=d}else{if(d||f===26){a+=((f+9).toString(36)+d);f=0}}}if(f>0){a+=(f+9).toString(36)}this.outbstr+=a},decodeBorder:function(){var f,e,c=this.outbstr,j,h=[16,8,4,2,1];if(c){f=Math.min(((((k.qcols-1)*k.qrows+4)/5)|0),c.length);e=Math.min((((k.qcols*(k.qrows-1)+4)/5)|0)+f,c.length)}else{f=0;e=0}j=0;for(var d=0;d<f;d++){var b=parseInt(c.charAt(d),32);for(var a=0;a<5;a++){if(j<(k.qcols-1)*k.qrows){bd.border[j].ques=((b&h[a])?1:0);j++}}}j=(k.qcols-1)*k.qrows;for(var d=f;d<e;d++){var b=parseInt(c.charAt(d),32);for(var a=0;a<5;a++){if(j<bd.bdinside){bd.border[j].ques=((b&h[a])?1:0);j++}}}area.resetRarea();this.outbstr=c.substr(e)},encodeBorder:function(){var a="",d=[16,8,4,2,1],b,c;b=0;c=0;for(var e=0;e<(k.qcols-1)*k.qrows;e++){c+=(bd.border[e].ques*d[b]);b++;if(b===5){a+=c.toString(32);b=0;c=0}}if(b>0){a+=c.toString(32)}b=0;c=0;for(var e=(k.qcols-1)*k.qrows;e<bd.bdinside;e++){c+=(bd.border[e].ques*d[b]);b++;if(b===5){a+=c.toString(32);b=0;c=0}}if(b>0){a+=c.toString(32)}this.outbstr+=a},decodeCrossMark:function(){var b=0,e=0,a=this.outbstr,j=(k.iscross===2?1:0),d=(j<<1);var m=(k.qrows-1+d),l=(k.qcols-1+d);for(e=0;e<a.length;e++){var c=a.charAt(e);if(this.include(c,"0","9")||this.include(c,"a","z")){b+=parseInt(c,36);var h=((b%l+(1-j))<<1);var f=((((b/l)|0)+(1-j))<<1);if(f>bd.maxby-2*(1-j)){e++;break}bd.cross[bd.xnum(h,f)].qnum=1}else{if(c=="."){b+=35}}b++;if(b>=l*m){e++;break}}this.outbstr=a.substr(e)},encodeCrossMark:function(){var m="",d=0,i=(k.iscross===2?1:0),a=(i<<1);var n=(k.qrows-1+a),j=(k.qcols-1+a);for(var h=0,l=j*n;h<l;h++){var b="";var f=((h%j+(1-i))<<1);var e=((((h/j)|0)+(1-i))<<1);if(bd.cross[bd.xnum(f,e)].qnum===1){b="."}else{d++}if(b){m+=d.toString(36);d=0}else{if(d==36){m+=".";d=0}}}if(d>0){m+=d.toString(36)}this.outbstr+=m},decodeCircle:function(){var a=this.outbstr,f=0,m=[9,3,1],j=(k.qcols*k.qrows);var h=(a?Math.min(((k.qcols*k.qrows+2)/3)|0,a.length):0);for(var e=0;e<h;e++){var d=parseInt(a.charAt(e),27);for(var l=0;l<3;l++){if(f<j){var b=((d/m[l])|0)%3;if(b>0){bd.cell[f].qnum=b}f++}}}this.outbstr=a.substr(h)},encodeCircle:function(){var a="",b=0,d=0,f=[9,3,1];for(var e=0;e<bd.cellmax;e++){if(bd.cell[e].qnum>0){d+=(bd.cell[e].qnum*f[b])}b++;if(b===3){a+=d.toString(27);b=0;d=0}}if(b>0){a+=d.toString(27)}this.outbstr+=a},decodecross_old:function(){var b=this.outbstr,e=0;for(var d=0;d<b.length;d++){var a=b.charAt(d);if(this.include(a,"0","4")){bd.cross[e].qnum=parseInt(a)}e++;if(e>=bd.crossmax){d++;break}}this.outbstr=b.substr(d)},include:function(b,c,a){return(c<=b&&b<=a)}};FileIO=function(){this.filever=0;this.lineseek=0;this.dataarray=[];this.datastr="";this.history="";this.currentType=1;this.PZPR=1;this.PBOX=2;this.PZPH=3};FileIO.prototype={filedecode:function(b){var a=b.split("/");base.dec.reset();base.dec.id=(a[0].match(/^pzprv3/)?a[1]:k.puzzleid);base.dec.fstr=b;base.init_func(function(){tm.reset()})},filedecode_main:function(b){b=b.replace(/[\r\n]/g,"");this.filever=0;this.lineseek=0;this.dataarray=b.split("/");if(this.readLine().match(/pzprv3\.?(\d+)?/)){if(RegExp.$1){this.filever=parseInt(RegExp.$1)}if(this.readLine()!=k.puzzleid){return"読み込みに失敗しました"}this.currentType=this.PZPR}else{this.lineseek=0;this.currentType=this.PBOX}var c,a;if(k.puzzleid!=="sudoku"){c=parseInt(this.readLine(),10);a=parseInt(this.readLine(),10);if(this.currentType===this.PBOX&&k.puzzleid==="kakuro"){c--;a--}}else{c=a=parseInt(this.readLine(),10)}if(c<=0||a<=0){return""}bd.initBoardSize(a,c);if(this.currentType===this.PZPR){this.decodeData()}else{if(this.currentType===this.PBOX){this.kanpenOpen()}}um.decodeLines();bd.resetInfo();pc.resize_canvas();this.dataarray=null;return""},fileencode:function(b){this.filever=0;this.sizestr="";this.datastr="";this.history="";this.currentType=b;if(this.currentType===this.PZPH){this.currentType=this.PZPR}if(this.currentType===this.PZPR){this.encodeData()}else{if(this.currentType===this.PBOX){this.kanpenSave()}}if(!this.sizestr){this.sizestr=[k.qrows,k.qcols].join("/")}this.datastr=[this.sizestr,this.datastr].join("/");if(this.currentType===this.PZPR){var c=(this.filever===0?"pzprv3":("pzprv3."+this.filever));this.datastr=[c,k.puzzleid,this.datastr].join("/")}var a=this.datastr;if(b===this.PZPH){this.history=um.toString()}return a},readLine:function(){this.lineseek++;return this.dataarray[this.lineseek-1]},readLines:function(a){this.lineseek+=a;return this.dataarray.slice(this.lineseek-a,this.lineseek)},getItemList:function(f){var d=[];var j=this.readLines(f);for(var a=0;a<j.length;a++){var e=j[a].split(" ");var b=[];for(var h=0;h<e.length;h++){if(e[h]!=""){b.push(e[h])}}d=d.concat(b)}return d},decodeObj:function(b,j,h,f,n,l){var e=h,d=f,a=2;var m=this.getItemList((l-f)/a+1);for(var c=0;c<m.length;c++){b(bd.getObject(j,bd.idnum(j,e,d)),m[c]);e+=a;if(e>n){e=h;d+=a}if(d>l){break}}},decodeCell:function(a){this.decodeObj(a,k.CELL,1,1,2*k.qcols-1,2*k.qrows-1)},decodeCross:function(a){this.decodeObj(a,k.CROSS,0,0,2*k.qcols,2*k.qrows)},decodeBorder:function(a){if(k.isborder===1||k.puzzleid==="bosanowa"){this.decodeObj(a,k.BORDER,2,1,2*k.qcols-2,2*k.qrows-1);this.decodeObj(a,k.BORDER,1,2,2*k.qcols-1,2*k.qrows-2)}else{if(k.isborder===2){if(this.currentType===this.PZPR){this.decodeObj(a,k.BORDER,0,1,2*k.qcols,2*k.qrows-1);this.decodeObj(a,k.BORDER,1,0,2*k.qcols-1,2*k.qrows)}else{if(this.currentType===this.PBOX){this.decodeObj(a,k.BORDER,1,0,2*k.qcols-1,2*k.qrows);this.decodeObj(a,k.BORDER,0,1,2*k.qcols,2*k.qrows-1)}}}}},encodeObj:function(b,h,f,e,j,i){var a=2;for(var c=e;c<=i;c+=a){for(var d=f;d<=j;d+=a){this.datastr+=b(bd.getObject(h,bd.idnum(h,d,c)))}this.datastr+="/"}},encodeCell:function(a){this.encodeObj(a,k.CELL,1,1,2*k.qcols-1,2*k.qrows-1)},encodeCross:function(a){this.encodeObj(a,k.CROSS,0,0,2*k.qcols,2*k.qrows)},encodeBorder:function(a){if(k.isborder===1||k.puzzleid==="bosanowa"){this.encodeObj(a,k.BORDER,2,1,2*k.qcols-2,2*k.qrows-1);this.encodeObj(a,k.BORDER,1,2,2*k.qcols-1,2*k.qrows-2)}else{if(k.isborder===2){if(this.currentType===this.PZPR){this.encodeObj(a,k.BORDER,0,1,2*k.qcols,2*k.qrows-1);this.encodeObj(a,k.BORDER,1,0,2*k.qcols-1,2*k.qrows)}else{if(this.currentType===this.PBOX){this.encodeObj(a,k.BORDER,1,0,2*k.qcols-1,2*k.qrows);this.encodeObj(a,k.BORDER,0,1,2*k.qcols,2*k.qrows-1)}}}}},decodeCellQnum:function(){this.decodeCell(function(b,a){if(a==="-"){b.qnum=-2}else{if(a!=="."){b.qnum=parseInt(a)}}})},encodeCellQnum:function(){this.encodeCell(function(a){if(a.qnum>=0){return(a.qnum.toString()+" ")}else{if(a.qnum===-2){return"- "}else{return". "}}})},decodeCellQnumb:function(){this.decodeCell(function(b,a){if(a==="5"){b.qnum=-2}else{if(a!=="."){b.qnum=parseInt(a)}}})},encodeCellQnumb:function(){this.encodeCell(function(a){if(a.qnum>=0){return(a.qnum.toString()+" ")}else{if(a.qnum===-2){return"5 "}else{return". "}}})},decodeCellQnumAns:function(){this.decodeCell(function(b,a){if(a==="#"){b.qans=1}else{if(a==="+"){b.qsub=1}else{if(a==="-"){b.qnum=-2}else{if(a!=="."){b.qnum=parseInt(a)}}}}})},encodeCellQnumAns:function(){this.encodeCell(function(a){if(a.qnum>=0){return(a.qnum.toString()+" ")}else{if(a.qnum===-2){return"- "}else{if(a.qans===1){return"# "}else{if(a.qsub===1){return"+ "}else{return". "}}}}})},decodeCellDirecQnum:function(){this.decodeCell(function(c,a){if(a!=="."){var b=a.split(",");c.qdir=(b[0]!=="0"?parseInt(b[0]):0);c.qnum=(b[1]!=="-"?parseInt(b[1]):-2)}})},encodeCellDirecQnum:function(){this.encodeCell(function(c){if(c.qnum!==-1){var b=(c.qdir!==0?c.qdir.toString():"0");var a=(c.qnum!==-2?c.qnum.toString():"-");return[b,",",a," "].join("")}else{return". "}})},decodeCellAns:function(){this.decodeCell(function(b,a){if(a==="#"){b.qans=1}else{if(a==="+"){b.qsub=1}}})},encodeCellAns:function(){this.encodeCell(function(a){if(a.qans===1){return"# "}else{if(a.qsub===1){return"+ "}else{return". "}}})},decodeCellQanssub:function(){this.decodeCell(function(b,a){if(a==="+"){b.qsub=1}else{if(a==="-"){b.qsub=2}else{if(a==="="){b.qsub=3}else{if(a==="%"){b.qsub=4}else{if(a!=="."){b.qans=parseInt(a)}}}}}})},encodeCellQanssub:function(){this.encodeCell(function(a){if(a.qans!==0){return(a.qans.toString()+" ")}else{if(a.qsub===1){return"+ "}else{if(a.qsub===2){return"- "}else{if(a.qsub===3){return"= "}else{if(a.qsub===4){return"% "}else{return". "}}}}}})},decodeCellAnumsub:function(){this.decodeCell(function(b,a){if(a==="+"){b.qsub=1}else{if(a==="-"){b.qsub=2}else{if(a==="="){b.qsub=3}else{if(a==="%"){b.qsub=4}else{if(a!=="."){b.anum=parseInt(a)}}}}}})},encodeCellAnumsub:function(){this.encodeCell(function(a){if(a.anum!==-1){return(a.anum.toString()+" ")}else{if(a.qsub===1){return"+ "}else{if(a.qsub===2){return"- "}else{if(a.qsub===3){return"= "}else{if(a.qsub===4){return"% "}else{return". "}}}}}})},decodeCellQsub:function(){this.decodeCell(function(b,a){if(a!=="0"){b.qsub=parseInt(a)}})},encodeCellQsub:function(){this.encodeCell(function(a){if(a.qsub>0){return(a.qsub.toString()+" ")}else{return"0 "}})},decodeCrossNum:function(){this.decodeCross(function(b,a){if(a==="-"){b.qnum=-2}else{if(a!=="."){b.qnum=parseInt(a)}}})},encodeCrossNum:function(){this.encodeCross(function(a){if(a.qnum>=0){return(a.qnum.toString()+" ")}else{if(a.qnum===-2){return"- "}else{return". "}}})},decodeBorderQues:function(){this.decodeBorder(function(b,a){if(a==="1"){b.ques=1}})},encodeBorderQues:function(){this.encodeBorder(function(a){return(a.ques===1?"1":"0")+" "})},decodeBorderAns:function(){this.decodeBorder(function(b,a){if(a==="2"){b.qans=1;b.qsub=1}else{if(a==="1"){b.qans=1}else{if(a==="-1"){b.qsub=1}}}})},encodeBorderAns:function(){this.encodeBorder(function(a){if(a.qans===1&&a.qsub===1){return"2 "}else{if(a.qans===1){return"1 "}else{if(a.qsub===1){return"-1 "}else{return"0 "}}}})},decodeBorderLine:function(){this.decodeBorder(function(b,a){if(a==="-1"){b.qsub=2}else{if(a!=="0"){b.line=parseInt(a)}}})},encodeBorderLine:function(){this.encodeBorder(function(a){if(a.line>0){return""+a.line+" "}else{if(a.qsub===2){return"-1 "}else{return"0 "}}})},decodeAreaRoom:function(){this.decodeAreaRoom_com(true)},encodeAreaRoom:function(){this.encodeAreaRoom_com(true)},decodeAnsAreaRoom:function(){this.decodeAreaRoom_com(false)},encodeAnsAreaRoom:function(){this.encodeAreaRoom_com(false)},decodeAreaRoom_com:function(a){this.readLine();this.rdata2Border(a,this.getItemList(k.qrows));area.resetRarea()},encodeAreaRoom_com:function(a){var d=area.getRoomInfo();this.datastr+=(d.max+"/");for(var b=0;b<bd.cellmax;b++){this.datastr+=(""+(d.id[b]-1)+" ");if((b+1)%k.qcols===0){this.datastr+="/"}}},rdata2Border:function(e,d){for(var f=0;f<bd.bdmax;f++){var c=bd.border[f].cellcc[0],b=bd.border[f].cellcc[1];var a=(c!==null&&b!==null&&d[c]!=d[b]);bd.border[f][(e?"ques":"qans")]=(a?1:0)}},decodeCellQnum51:function(){var e=this.getItemList(k.qrows+1);bd.disableInfo();for(var b=0;b<e.length;b++){if(e[b]=="."){continue}var j=(b%(k.qcols+1)-1)*2+1,h=(((b/(k.qcols+1))|0)-1)*2+1;if(j===-1||h===-1){var a=bd.exnum(j,h);var f=((h===-1)?"qdir":"qnum");bd.excell[a][f]=parseInt(e[b])}else{var d=e[b].split(",");var l=bd.cnum(j,h);mv.set51cell(l,true);bd.cell[l].qnum=parseInt(d[0]);bd.cell[l].qdir=parseInt(d[1])}}bd.enableInfo()},encodeCellQnum51:function(){var f="";for(var d=bd.minby+1;d<bd.maxby;d+=2){for(var e=bd.minbx+1;e<bd.maxbx;e+=2){if(e===-1&&d===-1){f+="0 "}else{if(e===-1||d===-1){var a=bd.exnum(e,d);var b=((d===-1)?"qdir":"qnum");f+=(""+bd.excell[a][b].toString()+" ")}else{var h=bd.cnum(e,d);if(bd.cell[h].ques===51){f+=(""+bd.cell[h].qnum.toString()+","+bd.cell[h].qdir.toString()+" ")}else{f+=". "}}}}f+="/"}this.datastr+=f},decodeCellQnum_kanpen:function(){this.decodeCell(function(b,a){if(a!=="."){b.qnum=parseInt(a)}})},encodeCellQnum_kanpen:function(){this.encodeCell(function(a){return((a.qnum>=0)?(a.qnum.toString()+" "):". ")})},decodeCellAnum_kanpen:function(){this.decodeCell(function(b,a){if(a!=="."&&a!=="0"){b.anum=parseInt(a)}})},encodeCellAnum_kanpen:function(){this.encodeCell(function(a){if(a.qnum!==-1){return". "}else{if(a.anum===-1){return"0 "}else{return""+a.anum.toString()+" "}}})},decodeCellQnumAns_kanpen:function(){this.decodeCell(function(b,a){if(a==="#"){b.qans=1}else{if(a==="+"){b.qsub=1}else{if(a!=="."){b.qnum=parseInt(a)}}}})},encodeCellQnumAns_kanpen:function(){this.encodeCell(function(a){if(a.qnum>=0){return(a.qnum.toString()+" ")}else{if(a.qans===1){return"# "}else{if(a.qsub===1){return"+ "}else{return". "}}}})},decodeSquareRoom:function(){this.decodeSquareRoom_com(true)},encodeSquareRoom:function(){this.encodeSquareRoom_com(true)},decodeAnsSquareRoom:function(){this.decodeSquareRoom_com(false)},encodeAnsSquareRoom:function(){this.encodeSquareRoom_com(false)},decodeSquareRoom_com:function(a){var m=parseInt(this.readLine());var l=this.readLines(m);var f=[];for(var e=0;e<l.length;e++){if(l[e]==""){break}var h=l[e].split(" ");for(var d=0;d<4;d++){if(!isNaN(h[d])){h[d]=parseInt(h[d])}}var b={y1:2*h[0]+1,x1:2*h[1]+1,y2:2*h[2]+1,x2:2*h[3]+1};if(a&&h[4]!=""){var j=bd.cnum(b.x1,b.y1);bd.cell[j].qnum=parseInt(h[4],10)}this.setRdataRect(f,e,b)}this.rdata2Border(a,f);area.resetRarea()},setRdataRect:function(e,a,b){for(var d=b.x1;d<=b.x2;d+=2){for(var c=b.y1;c<=b.y2;c+=2){e[bd.cnum(d,c)]=a}}},encodeSquareRoom_com:function(c){var f=area.getRoomInfo();this.datastr+=(f.max+"/");for(var e=1;e<=f.max;e++){var b=ans.getSizeOfClist(f.room[e].idlist,f_true);var a=(c?bd.cell[area.getTopOfRoom(e)].qnum:-1);this.datastr+=(""+(b.y1>>1)+" "+(b.x1>>1)+" "+(b.y2>>1)+" "+(b.x2>>1)+" "+(a>=0?""+a:"")+"/")}}};ProblemData=function(){this.id=null;this.pid="";this.col="";this.row="";this.hard=0;this.pdata="";this.time=0;this.comment=""};ProblemData.prototype={setnewData:function(a){this.id=a;this.pid=k.puzzleid;this.col=k.qcols;this.row=k.qrows;this.hard=0;this.pdata=fio.fileencode(fio.PZPH);this.time=(tm.now()/1000)|0;this.comment=""},toString:function(){var a={id:this.id,pid:this.pid,col:this.col,row:this.row,hard:this.hard,pdata:this.pdata,time:this.time,comment:this.comment};return JSON.stringify(a)},parse:function(c){if(c===(void 0)){this.id=null;return this}var b=JSON.parse(c);for(var a in b){this[a]=b[a]}return this}};DataBaseManager=function(){this.dbh=null;this.DBsid=-1;this.DBlist=[];var a=this;this.update=function(){a.updateDialog.call(a)};this.sync=false};DataBaseManager.prototype={openDialog:function(){if(base.dec.enLocalStorage()){this.dbh=new DataBaseHandler_LS()}else{return}this.sync=false;this.dbh.convert();this.dbh.importDBlist(this,this.update)},closeDialog:function(){this.DBlist=[]},clickHandler:function(a){if(this.sync===false){return}switch(ee.getSrcElement(a).name){case"sorts":this.displayDataTableList();case"datalist":this.selectDataTable();break;case"tableup":this.upDataTable_M();break;case"tabledn":this.downDataTable_M();break;case"open":this.openDataTable_M();break;case"save":this.saveDataTable_M();break;case"comedit":this.editComment_M();break;case"difedit":this.editDifficult_M();break;case"del":this.deleteDataTable_M();break}},getDataID:function(){if(_doc.database.datalist.value!="new"&&_doc.database.datalist.value!=""){for(var a=0;a<this.DBlist.length;a++){if(this.DBlist[a].id==_doc.database.datalist.value){return a}}}return -1},updateDialog:function(){this.dbh.updateManageData(this);this.displayDataTableList();this.selectDataTable();this.sync=true},displayDataTableList:function(){switch(_doc.database.sorts.value){case"idlist":this.DBlist=this.DBlist.sort(function(d,c){return(d.id-c.id)});break;case"newsave":this.DBlist=this.DBlist.sort(function(d,c){return(c.time-d.time||d.id-c.id)});break;case"oldsave":this.DBlist=this.DBlist.sort(function(d,c){return(d.time-c.time||d.id-c.id)});break;case"size":this.DBlist=this.DBlist.sort(function(d,c){return(d.col-c.col||d.row-c.row||d.hard-c.hard||d.id-c.id)});break}_doc.database.datalist.innerHTML="";for(var a=0;a<this.DBlist.length;a++){var b=this.DBlist[a];if(!!b){this.appendNewOption(b.id,this.getRowString(b))}}this.appendNewOption(-1,"&nbsp;&lt;新しく保存する&gt;")},appendNewOption:function(c,b){var a=_doc.createElement("option");a.setAttribute("value",(c!=-1?c:"new"));a.innerHTML=b;if(this.DBsid==c){a.setAttribute("selected","selected")}_doc.database.datalist.appendChild(a)},getRowString:function(c){var b=[{ja:"−",en:"-"},{ja:"らくらく",en:"Easy"},{ja:"おてごろ",en:"Normal"},{ja:"たいへん",en:"Hard"},{ja:"アゼン",en:"Expert"}];var a="";a+=((c.id<10?"&nbsp;":"")+c.id+" :&nbsp;");a+=(PZLNAME.ja[c.pid]+"&nbsp;");a+=(""+c.col+"×"+c.row+" &nbsp;");if(!!c.hard||c.hard=="0"){a+=(b[c.hard][menu.language]+"&nbsp;")}a+=("("+this.dateString(c.time*1000)+")");return a},dateString:function(c){var b=function(e){return(e<10?"0":"")+e};var d="";var a=new Date();a.setTime(c);d+=(b(a.getFullYear()%100)+"/"+b(a.getMonth()+1)+"/"+b(a.getDate())+" ");d+=(b(a.getHours())+":"+b(a.getMinutes()));return d},selectDataTable:function(){var a=this.getDataID();if(a>=0){_doc.database.comtext.value=""+this.DBlist[a].comment;this.DBsid=parseInt(this.DBlist[a].id)}else{_doc.database.comtext.value="";this.DBsid=-1}_doc.database.tableup.disabled=(_doc.database.sorts.value!=="idlist"||this.DBsid===-1||this.DBsid===1);_doc.database.tabledn.disabled=(_doc.database.sorts.value!=="idlist"||this.DBsid===-1||this.DBsid===this.DBlist.length);_doc.database.comedit.disabled=(this.DBsid===-1);_doc.database.difedit.disabled=(this.DBsid===-1);_doc.database.open.disabled=(this.DBsid===-1);_doc.database.del.disabled=(this.DBsid===-1)},upDataTable_M:function(){var a=this.getDataID();if(a===-1||a===0){return}this.convertDataTable_M(a,a-1)},downDataTable_M:function(){var a=this.getDataID();if(a===-1||a===this.DBlist.length-1){return}this.convertDataTable_M(a,a+1)},convertDataTable_M:function(a,b){this.DBsid=this.DBlist[b].id;var d=this.DBlist[a].id;this.DBlist[a].id=this.DBlist[b].id;this.DBlist[b].id=d;var c=this.DBlist[a];this.DBlist[a]=this.DBlist[b];this.DBlist[b]=c;this.sync=false;this.dbh.convertDataTableID(this,a,b,this.update)},openDataTable_M:function(){var a=this.getDataID();if(a===-1){return}if(!confirm("このデータを読み込みますか？ (現在の盤面は破棄されます)")){return}this.dbh.openDataTable(this,a,null)},saveDataTable_M:function(){var c=this.getDataID(),a=false;if(c===-1){c=this.DBlist.length;a=true;this.DBlist[c]=new ProblemData();this.DBlist[c].setnewData(c+1);var b=prompt("コメントがある場合は入力してください。","");this.DBlist[c].comment=(!!b?b:"");this.DBsid=this.DBlist[c].id}else{if(!confirm("このデータに上書きしますか？")){return}}this.sync=false;this.dbh.saveDataTable(this,c,this.update)},editComment_M:function(){var b=this.getDataID();if(b===-1){return}var a=prompt("この問題に対するコメントを入力してください。",this.DBlist[b].comment);if(a==null){return}this.DBlist[b].comment=a;this.sync=false;this.dbh.updateComment(this,b,this.update)},editDifficult_M:function(){var b=this.getDataID();if(b===-1){return}var a=prompt("この問題の難易度を設定してください。\n[0:なし 1:らくらく 2:おてごろ 3:たいへん 4:アゼン]",this.DBlist[b].hard);if(a==null){return}this.DBlist[b].hard=((a=="1"||a=="2"||a=="3"||a=="4")?a:0);this.sync=false;this.dbh.updateDifficult(this,b,this.update)},deleteDataTable_M:function(){var d=this.getDataID();if(d===-1){return}if(!confirm("このデータを完全に削除しますか？")){return}var b=this.DBlist[d].id,a=this.DBlist.length;for(var c=b-1;c<a-1;c++){this.DBlist[c]=this.DBlist[c+1];this.DBlist[c].id--}this.DBlist.pop();this.sync=false;this.dbh.deleteDataTable(this,b,a,this.update)}};DataBaseHandler_LS=function(){this.pheader="pzprv3_storage:data:";this.initialize()};DataBaseHandler_LS.prototype={initialize:function(){this.createManageDataTable();this.createDataBase()},importDBlist:function(b,d){b.DBlist=[];for(var a=1;true;a++){var c=(new ProblemData()).parse(localStorage[this.pheader+a]);if(c.id==null){break}b.DBlist.push(c)}if(!!d){d()}},createManageDataTable:function(){localStorage["pzprv3_storage:version"]="2.0"},updateManageData:function(a){localStorage["pzprv3_storage:count"]=a.DBlist.length;localStorage["pzprv3_storage:time"]=(tm.now()/1000)|0},createDataBase:function(){},convertDataTableID:function(c,a,d,f){var b=c.DBlist[a].id,e=c.DBlist[d].id;localStorage[this.pheader+b]=c.DBlist[a].toString();localStorage[this.pheader+e]=c.DBlist[d].toString();if(!!f){f()}},openDataTable:function(a,d,c){var b=(new ProblemData()).parse(localStorage[this.pheader+a.DBlist[d].id]);fio.filedecode(b.pdata);if(!!c){c()}},saveDataTable:function(a,c,b){a.DBlist[c].pdata=fio.fileencode(fio.PZPH);localStorage[this.pheader+a.DBlist[c].id]=a.DBlist[c].toString();if(!!b){b()}},updateComment:function(a,c,b){localStorage[this.pheader+a.DBlist[c].id]=a.DBlist[c].toString();if(!!b){b()}},updateDifficult:function(a,c,b){localStorage[this.pheader+a.DBlist[c].id]=a.DBlist[c].toString();if(!!b){b()}},deleteDataTable:function(d,b,a,f){for(var c=parseInt(b);c<a;c++){var e=(new ProblemData()).parse(localStorage[this.pheader+(c+1)]);e.id--;localStorage[this.pheader+c]=e.toString()}localStorage.removeItem(this.pheader+a);if(!!f){f()}},convert:function(){var o=["id","col","row","hard","pdata","time","comment"];if(!localStorage.pzprv3_manage){return}var a=0,d=0;delete localStorage.pzprv3_manage;delete localStorage["pzprv3_manage:manage"];var h=[];for(var f in PZLNAME.ja){if(!localStorage["pzprv3_"+f]){continue}var m="pzprv3_manage:manage!"+f+"!";var l=localStorage[m+"count"];var j=localStorage[m+"time"];delete localStorage[m+"count"];delete localStorage[m+"time"];if(j>a){j=a}d+=l;delete localStorage["pzprv3_"+f];delete localStorage["pzprv3_"+f+":puzdata"];for(var e=0;e<l;e++){var b="pzprv3_"+f+":puzdata!"+(e+1)+"!";var p=new ProblemData();p.pid=f;for(var n=0;n<7;n++){p[o[n]]=localStorage[b+o[n]];delete localStorage[b+o[n]]}h.push(p)}}h.sort(function(i,c){return(i.time-c.time||i.id-c.id)});localStorage["pzprv3_storage:version"]="2.0";localStorage["pzprv3_storage:count"]=h.length;localStorage["pzprv3_storage:time"]=(tm.now()/1000)|0;for(var e=0;e<h.length;e++){h[e].id=(e+1);localStorage["pzprv3_storage:data:"+(e+1)]=h[e].toString()}}};AnsCheck=function(){this.performAsLine=false;this.errDisp=false;this.setError=true;this.inCheck=false;this.inAutoCheck=false;this.alstr={jp:"",en:""}};AnsCheck.prototype={check:function(){this.inCheck=true;this.alstr={jp:"",en:""};kc.keyreset();mv.mousereset();if(!this.checkAns()){menu.alertStr(this.alstr.jp,this.alstr.en);this.errDisp=true;pc.paintAll();this.inCheck=false;return false}menu.alertStr("正解です！","Complete!");this.inCheck=false;return true},checkAns:function(){},setAlert:function(b,a){this.alstr.jp=b;this.alstr.en=(!!a?a:b)},autocheck:function(){if(!pp.getVal("autocheck")||k.editmode||this.inCheck){return}var a=false;this.inCheck=this.inAutoCheck=true;this.disableSetError();if(this.autocheck1st()&&this.checkAns()&&this.inCheck){mv.mousereset();menu.alertStr("正解です！","Complete!");a=true;pp.setVal("autocheck",false)}this.enableSetError();this.inCheck=this.inAutoCheck=false;return a},autocheck1st:function(){if(this.check1st){return this.check1st()}else{if((k.isCenterLine&&!ans.checkLcntCell(1))||(k.isborderAsLine&&!ans.checkLcntCross(1,0))){return false}}return true},disableSetError:function(){this.setError=false},enableSetError:function(){this.setError=true},isenableSetError:function(){return this.setError},setErrLareaByCell:function(a,d,b){this.setErrLareaById(a,a.id[d],b)},setErrLareaById:function(e,h,d){var a=[];for(var b=0;b<bd.bdmax;b++){if(!bd.isLine(b)){continue}var j=bd.border[b].cellcc[0],i=bd.border[b].cellcc[1];if(e.id[j]===h&&e.id[j]===e.id[i]){a.push(b)}}bd.sErB(a,d);var l=[];for(var f=0;f<bd.cellmax;f++){if(e.id[f]===h&&bd.isNum(f)){l.push(f)}}bd.sErC(l,4)},checkAllCell:function(b){var a=true;for(var d=0;d<bd.cellmax;d++){if(b(d)){if(this.inAutoCheck){return false}bd.sErC([d],1);a=false}}return a},checkNoNumCell:function(){return this.checkAllCell(bd.noNum)},checkIceLines:function(){return this.checkAllCell(function(a){return(line.lcntCell(a)===2&&bd.QuC(a)===6&&!bd.isLineStraight(a))})},checkDir4Cell:function(b,e){var a=true;for(var h=0;h<bd.cellmax;h++){if(!bd.isValidNum(h)){continue}var d=bd.getNum(h),f=this.countDir4Cell(h,b);if((e!==1&&d<f)||(e!==2&&d>f)){if(this.inAutoCheck){return false}bd.sErC([h],1);a=false}}return a},countDir4Cell:function(e,b){if(e<0||e>=bd.cellmax||e===null){return 0}var a=0,d;d=bd.up(e);if(d!==null&&b(d)){a++}d=bd.dn(e);if(d!==null&&b(d)){a++}d=bd.lt(e);if(d!==null&&b(d)){a++}d=bd.rt(e);if(d!==null&&b(d)){a++}return a},checkSideCell:function(b){var a=true;for(var d=0;d<bd.cellmax;d++){if(bd.cell[d].bx<bd.maxbx-1&&b(d,bd.rt(d))){if(this.inAutoCheck){return false}bd.sErC([d,bd.rt(d)],1);a=false}if(bd.cell[d].by<bd.maxby-1&&b(d,bd.dn(d))){if(this.inAutoCheck){return false}bd.sErC([d,bd.dn(d)],1);a=false}}return a},check2x2Block:function(e){var a=true;for(var l=0;l<bd.cellmax;l++){if(bd.cell[l].bx<bd.maxbx-1&&bd.cell[l].by<bd.maxby-1){var d=0,j=bd.cell[l].bx,h=bd.cell[l].by;var f=bd.cellinside(j,h,j+2,h+2);for(var b=0;b<f.length;b++){if(e(f[b])){d++}}if(d===4){if(this.inAutoCheck){return false}bd.sErC(f,1);a=false}}}return a},checkOneArea:function(a){if(a.max>1){if(this.performAsLine){bd.sErBAll(2);this.setErrLareaByCell(a,1,1)}if(!this.performAsLine||k.puzzleid=="firefly"){bd.sErC(a.room[1].idlist,1)}return false}return true},checkOneLoop:function(){var a=line.getLineInfo();if(a.max>1){bd.sErBAll(2);bd.sErB(a.room[1].idlist,1);return false}return true},checkLcntCell:function(b){var a=true;if(line.ltotal[b]==0){return true}for(var d=0;d<bd.cellmax;d++){if(line.lcnt[d]==b){if(this.inAutoCheck){return false}if(!this.performAsLine){bd.sErC([d],1)}else{if(a){bd.sErBAll(2)}this.setCellLineError(d,true)}a=false}}return a},setCellLineError:function(d,a){if(a){bd.sErC([d],1)}var c=bd.cell[d].bx,b=bd.cell[d].by;bd.sErB(bd.borderinside(c-1,b-1,c+1,b+1),1)},checkenableLineParts:function(b){var a=true;for(var d=0;d<bd.cellmax;d++){if((bd.isLine(bd.ub(d))&&bd.noLP(d,k.UP))||(bd.isLine(bd.db(d))&&bd.noLP(d,k.DN))||(bd.isLine(bd.lb(d))&&bd.noLP(d,k.LT))||(bd.isLine(bd.rb(d))&&bd.noLP(d,k.RT))){if(this.inAutoCheck){return false}bd.sErC([d],1);a=false}}return a},checkAllArea:function(e,b,c){var a=true;for(var j=1;j<=e.max;j++){var i=(k.roomNumber?area.getTopOfRoomByCell(e.room[j].idlist[0]):this.getQnumCellOfClist(e.room[j].idlist));var f=this.getSizeOfClist(e.room[j].idlist,b);var h=(i!==null?bd.QnC(i):-1);if(!c(f.cols,f.rows,f.cnt,h)){if(this.inAutoCheck){return false}if(this.performAsLine){if(a){bd.sErBAll(2)}this.setErrLareaById(e,j,1)}else{bd.sErC(e.room[j].idlist,(k.puzzleid!="tateyoko"?1:4))}a=false}}return a},checkDisconnectLine:function(a){return this.checkAllArea(a,bd.isNum,function(c,d,b,e){return(e!=-1||b>0)})},checkNumberAndSize:function(a){return this.checkAllArea(a,f_true,function(c,d,b,e){return(e<=0||e==b)})},checkNoNumber:function(a){return this.checkAllArea(a,bd.isNum,function(c,d,b,e){return(b!=0)})},checkDoubleNumber:function(a){return this.checkAllArea(a,bd.isNum,function(c,d,b,e){return(b<2)})},checkTripleNumber:function(a){return this.checkAllArea(a,bd.isNum,function(c,d,b,e){return(b<3)})},checkBlackCellCount:function(a){return this.checkAllArea(a,bd.isBlack,function(c,d,b,e){return(e<0||e===b)})},checkBlackCellInArea:function(b,a){return this.checkAllArea(b,bd.isBlack,function(d,e,c,f){return a(c)})},checkAreaRect:function(a){return this.checkAllArea(a,f_true,function(c,d,b,e){return(c*d===b)})},checkLinesInArea:function(b,a){return this.checkAllArea(b,function(d){return line.lcnt[d]>0},a)},checkNoObjectInRoom:function(b,a){return this.checkAllArea(b,function(d){return a(d)!==-1},function(d,e,c,f){return(c!=0)})},getQnumCellOfClist:function(c){for(var b=0,a=c.length;b<a;b++){if(bd.QnC(c[b])!==-1){return c[b]}}return null},getSizeOfClist:function(c,b){var e={x1:bd.maxbx+1,x2:bd.minbx-1,y1:bd.maxby+1,y2:bd.minby-1,cols:0,rows:0,cnt:0};for(var a=0;a<c.length;a++){if(e.x1>bd.cell[c[a]].bx){e.x1=bd.cell[c[a]].bx}if(e.x2<bd.cell[c[a]].bx){e.x2=bd.cell[c[a]].bx}if(e.y1>bd.cell[c[a]].by){e.y1=bd.cell[c[a]].by}if(e.y2<bd.cell[c[a]].by){e.y2=bd.cell[c[a]].by}if(b(c[a])){e.cnt++}}e.cols=(e.x2-e.x1+2)/2;e.rows=(e.y2-e.y1+2)/2;return e},getSideAreaInfo:function(f){var h=[],e=[],i=f.max;for(var a=1;a<=i-1;a++){h[a]=[]}for(var b=0;b<bd.bdmax;b++){var l=bd.border[b].cellcc[0],j=bd.border[b].cellcc[1];if(l===null||j===null){continue}var d=f.id[l],c=f.id[j];if(d===null||c===null){continue}if(d<c){h[d][c]=true}if(d>c){h[c][d]=true}}for(var a=1;a<=i-1;a++){e[a]=[];for(var m=a+1;m<=i;m++){if(!!h[a][m]){e[a].push(m)}}}return e},checkSideAreaSize:function(j,c){var h=this.getSideAreaInfo(j);for(var f=1;f<=j.max-1;f++){for(var d=0;d<h[f].length;d++){var e=h[f][d],b=c(j,f),a=c(j,e);if(b>0&&a>0&&b==a){bd.sErC(j.room[f].idlist,1);bd.sErC(j.room[e].idlist,1);return false}}}return true},checkSideAreaCell:function(f,d,a){for(var e=0;e<bd.bdmax;e++){if(!bd.isBorder(e)){continue}var c=bd.border[e].cellcc[0],b=bd.border[e].cellcc[1];if(c!==null&&b!==null&&d(c,b)){if(!a){bd.sErC([c,b],1)}else{bd.sErC(area.room[area.room.id[c]].clist,1);bd.sErC(area.room[area.room.id[b]].clist,1)}return false}}return true},checkSeqBlocksInRoom:function(){var a=true;for(var e=1;e<=area.room.max;e++){var b={max:0,id:[]};for(var d=0;d<bd.cellmax;d++){b.id[d]=((area.room.id[d]===e&&bd.isBlack(d))?0:null)}for(var d=0;d<bd.cellmax;d++){if(b.id[d]!==0){continue}b.max++;b[b.max]={clist:[]};area.sc0(d,b)}if(b.max>1){if(this.inAutoCheck){return false}bd.sErC(area.room[e].clist,1);a=false}}return a},checkSameObjectInRoom:function(m,e){var a=true,h=[],f=[];for(var l=0;l<bd.cellmax;l++){f[l]=e(l)}for(var b=1;b<=m.max;b++){h[b]=-1}for(var l=0;l<bd.cellmax;l++){if(m.id[l]===null||f[l]===-1){continue}if(h[m.id[l]]===-1&&f[l]!==-1){h[m.id[l]]=f[l]}else{if(h[m.id[l]]!==f[l]){if(this.inAutoCheck){return false}if(this.performAsLine){bd.sErBAll(2);this.setErrLareaByCell(m,l,1)}else{bd.sErC(m.room[m.id[l]].idlist,1)}if(k.puzzleid=="kaero"){for(var j=0;j<bd.cellmax;j++){if(m.id[l]===m.id[j]&&this.getBeforeCell(j)!==null&&m.id[l]!==m.id[this.getBeforeCell(j)]){bd.sErC([this.getBeforeCell(j)],4)}}}a=false}}}return a},checkGatheredObject:function(e,h){var j=[],l=0,a=[];for(var m=0;m<bd.cellmax;m++){a[m]=h(m);if(l<a[m]){l=a[m]}}for(var f=0;f<=l;f++){j[f]=-1}for(var m=0;m<bd.cellmax;m++){if(a[m]===-1){continue}if(j[a[m]]===-1){j[a[m]]=e.id[m]}else{if(j[a[m]]!==e.id[m]){var n=[];for(var b=0;b<bd.cellmax;b++){if(k.puzzleid=="kaero"){if(a[m]===bd.QnC(b)){n.push(b)}}else{if(e.id[m]===e.id[b]||j[a[m]]===e.id[b]){n.push(b)}}}bd.sErC(n,1);return false}}}return true},checkDifferentNumberInRoom:function(d,c){var a=true;for(var b=1;b<=d.max;b++){if(!this.isDifferentNumberInClist(d.room[b].idlist,c)){if(this.inAutoCheck){return false}bd.sErC(d.room[b].idlist,1);a=false}}return a},isDifferentNumberInClist:function(l,e){var m=true,h=[],f=[],a=(k.dispzero?1:0);for(var b=a,j=bd.nummaxfunc(l[0]);b<=j;b++){h[b]=0}for(var c=0;c<l.length;c++){f[l[c]]=e.call(bd,l[c])}for(var c=0;c<l.length;c++){if(f[l[c]]>=a){h[f[l[c]]]++}}for(var c=0;c<l.length;c++){if(f[l[c]]>=a&&h[f[l[c]]]>=2){bd.sErC([l[c]],1);m=false}}return m},checkRowsCols:function(d,f){var a=true;for(var c=1;c<=bd.maxby;c+=2){var b=bd.cellinside(bd.minbx+1,c,bd.maxbx-1,c);if(!d.call(this,b,f)){if(this.inAutoCheck){return false}a=false}}for(var e=1;e<=bd.maxbx;e+=2){var b=bd.cellinside(e,bd.minby+1,e,bd.maxby-1);if(!d.call(this,b,f)){if(this.inAutoCheck){return false}a=false}}return a},checkRowsColsPartly:function(d,a,i,j){var m=true;for(var e=1;e<=bd.maxby;e+=2){var f=1;while(f<=bd.maxbx){for(var c=f;c<=bd.maxbx;c+=2){if(i.call(this,bd.cnum(c,e))){break}}var l=bd.cellinside(f,e,c-2,e);var h=(k.isexcell!==1?0:(f===1?bd.QnE(bd.exnum(-1,e)):bd.QnC(bd.cnum(f-2,e))));if(!d.call(this,h,[f-2,e],l,a)){if(!j||this.inAutoCheck){return false}m=false}f=c+2}}for(var f=1;f<=bd.maxbx;f+=2){var e=1;while(e<=bd.maxby){for(var b=e;b<=bd.maxby;b+=2){if(i.call(this,bd.cnum(f,b))){break}}var l=bd.cellinside(f,e,f,b-2);var h=(k.isexcell!==1?0:(e===1?bd.DiE(bd.exnum(f,-1)):bd.DiC(bd.cnum(f,e-2))));if(!d.call(this,h,[f,e-2],l,a)){if(!j||this.inAutoCheck){return false}m=false}e=b+2}}return m},checkLcntCross:function(h,c){var a=true,f=(k.iscross===1?2:0);for(var d=f;d<=bd.maxby-f;d+=2){for(var e=f;e<=bd.maxbx-f;e+=2){var i=(e>>1)+(d>>1)*(k.qcols+1);var b=(!k.isborderAsLine?area.lcnt[i]:line.lcnt[i]);if(b==h&&(c==0||(c==1&&bd.QnX(bd.xnum(e,d))==1)||(c==2&&bd.QnX(bd.xnum(e,d))!=1))){if(this.inAutoCheck){return false}if(a){bd.sErBAll(2)}this.setCrossBorderError(e,d);a=false}}}return a},setCrossBorderError:function(b,a){if(k.iscross!==0){bd.sErX([bd.xnum(b,a)],1)}bd.sErB(bd.borderinside(b-1,a-1,b+1,a+1),1)}};Operation=function(d,c,e,a,b){this.group=d;this.property=c;this.id=e;this.old=a;this.num=b;if(arguments[0]!==(void 0)&&arguments[1]===(void 0)){this.decode(d)}return this};Operation.prototype={decode:function(b){var a=b.split(/,/);if(!!um.STRGROUP[a[0].charAt(0)]){this.group=um.STRGROUP[a[0].charAt(0)];this.property=um.STRPROP[a[0].charAt(1)];this.id=bd.idnum(this.group,a[1],a[2]);this.old=parseInt(a[3]);this.num=parseInt(a[4])}else{if(a[0]==="AL"){this.group=k.BOARD;this.property=k.BOARD;this.id=0;this.old=parseInt(a[3]);this.num=parseInt(a[4])}else{this.group=k.OTHER;this.decodeSpecial(a)}}},toString:function(){if(this.group!==k.BOARD&&this.group!==k.OTHER){var a=(um.GROUPSTR[this.group]+um.PROPSTR[this.property]);var b=bd.getObject(this.group,this.id);return[a,b.bx,b.by,this.old,this.num].join(",")}else{if(this.group===k.BOARD){return["AL",0,0,this.old,this.num].join(",")}else{return this.toStringSpecial()}}},decodeSpecial:function(a){},toStringSpecial:function(){}};OperationArray=function(){this.items=[]};OperationArray.prototype={push:function(a){this.items.push(a)},last:function(){return(this.items.length>0?this.items[this.items.length-1]:null)},isnull:function(){return(this.items.length===0)}};OperationManager=function(){this.lastope=new OperationArray();this.ope=[this.lastope];this.current=0;this.disrec=0;this.disCombine=0;this.forceRecord=false;this.anscount=0;this.changeflag=false;this.enableUndo=false;this.enableRedo=false;this.undoExec=false;this.redoExec=false;this.reqReset=false;this.range={x1:bd.maxbx+1,y1:bd.maxby+1,x2:bd.minbx-1,y2:bd.minby-1};this.PROPFUNC={};this.PROPFUNC[k.QUES]="sQu";this.PROPFUNC[k.QNUM]="sQn";this.PROPFUNC[k.ANUM]="sAn";this.PROPFUNC[k.QDIR]="sDi";this.PROPFUNC[k.QANS]="sQa";this.PROPFUNC[k.QSUB]="sQs";this.PROPFUNC[k.LINE]="sLi";this.PROPSTR={};this.PROPSTR[k.QUES]="U";this.PROPSTR[k.QNUM]="N";this.PROPSTR[k.ANUM]="M";this.PROPSTR[k.QDIR]="D";this.PROPSTR[k.QANS]="A";this.PROPSTR[k.QSUB]="S";this.PROPSTR[k.LINE]="L";this.STRPROP={};this.STRPROP.U=k.QUES;this.STRPROP.N=k.QNUM;this.STRPROP.M=k.ANUM;this.STRPROP.D=k.QDIR;this.STRPROP.A=k.QANS;this.STRPROP.S=k.QSUB;this.STRPROP.L=k.LINE;this.GROUPSTR={};this.GROUPSTR[k.CELL]="C";this.GROUPSTR[k.CROSS]="X";this.GROUPSTR[k.BORDER]="B";this.GROUPSTR[k.EXCELL]="E";this.STRGROUP={};this.STRGROUP.C=k.CELL;this.STRGROUP.X=k.CROSS;this.STRGROUP.B=k.BORDER;this.STRGROUP.E=k.EXCELL};OperationManager.prototype={disableRecord:function(){this.disrec++},enableRecord:function(){if(this.disrec>0){this.disrec--}},isenableRecord:function(){return(this.forceRecord||this.disrec===0)},enb_btn:function(){this.enableUndo=(this.current>0);this.enableRedo=(this.current<this.ope.length-(this.lastope.isnull()?1:0));ee("btnundo").el.disabled=(!this.enableUndo?"disabled":"");ee("btnredo").el.disabled=(!this.enableRedo?"disabled":"");ee("ms_h_oldest").el.className=(this.enableUndo?"smenu":"smenunull");ee("ms_h_undo").el.className=(this.enableUndo?"smenu":"smenunull");ee("ms_h_redo").el.className=(this.enableRedo?"smenu":"smenunull");ee("ms_h_latest").el.className=(this.enableRedo?"smenu":"smenunull")},allerase:function(){this.lastope=new OperationArray();this.ope=[this.lastope];this.current=0;this.anscount=0;this.enb_btn()},newOperation:function(a){if(!this.lastope.isnull()){this.addOpeArray()}if(a){this.changeflag=false}},addOpeArray:function(){this.lastope=new OperationArray();this.ope.push(this.lastope)},addOpe:function(f,e,h,a,b){if(!this.isenableRecord()||(a===b&&f!==k.BOARD)){return}if(this.enableRedo){for(var c=this.ope.length-1;c>=this.current;c--){this.ope.pop()}this.addOpeArray();this.current=this.ope.length-1}var d=this.lastope.last();if(this.disCombine==0&&!!d&&d.group==f&&d.property==e&&d.id==h&&d.num==a&&((f==k.CELL&&(e==k.QNUM||(e==k.ANUM&&k.isAnsNumber)))||f==k.CROSS)){d.num=b}else{if(!d){this.current++}this.lastope.push(new Operation(f,e,h,a,b))}if(e!=k.QSUB){this.anscount++}this.changeflag=true;this.enb_btn()},decodeLines:function(){this.allerase();var b=fio.lineseek;while(1){var a=fio.readLine();if(a===(void 0)){fio.lineseek=b;break}else{if(a==="__HISTORY__"){this.parse();break}}}this.enb_btn()},parse:function(){if(!window.JSON){return}var f=JSON.parse(fio.readLine());this.ope=[];this.current=f.current;for(var d=0,a=f.datas.length;d<a;d++){this.addOpeArray();var e=f.datas[d];for(var c=0,b=e.length;c<b;c++){this.lastope.push(new Operation(e[c]))}}},toString:function(){if(!window.JSON){return""}var f=this.ope.length-(this.lastope.isnull()?1:0);var e={version:0,history:f,current:this.current,datas:[]};for(var d=0;d<f;d++){var a=this.ope[d].items;e.datas[d]=[];for(var c=0,b=a.length;c<b;c++){e.datas[d][c]=a[c].toString()}}return["__HISTORY__",JSON.stringify(e)].join("/")},undo:function(a){if(!this.enableUndo){return}this.undoExec=true;this.preproc();for(var b=0;b<a;b++){this.undoSingle()}this.postproc();this.undoExec=false;if(!this.enableUndo){kc.inUNDO=false}},redo:function(a){if(!this.enableRedo){return}this.redoExec=true;this.preproc();for(var b=0;b<a;b++){this.redoSingle()}this.postproc();this.redoExec=false;if(!this.enableRedo){kc.inREDO=false}},undoall:function(){this.undo(this.current)},redoall:function(){this.redo(this.ope.length-this.current-1)},undoSingle:function(){var b=this.ope[this.current-1].items;if(!b){return}for(var a=b.length-1;a>=0;a--){this.exec(b[a],b[a].old);if(b[a].property!=k.QSUB){this.anscount--}}this.current--},redoSingle:function(){var c=this.ope[this.current].items;if(!c){return}for(var b=0,a=c.length;b<a;b++){this.exec(c[b],c[b].num);if(c[b].property!=k.QSUB){this.anscount++}}this.current++},preproc:function(){this.reqReset=false;this.range={x1:bd.maxbx+1,y1:bd.maxby+1,x2:bd.minbx-1,y2:bd.minby-1};this.disableRecord()},postproc:function(){if(this.reqReset){this.reqReset=false;bd.setposAll();bd.setminmax();bd.enableInfo();bd.resetInfo();pc.resize_canvas()}else{pc.paintRange(this.range.x1,this.range.y1,this.range.x2,this.range.y2)}this.enableRecord();this.enb_btn()},exec:function(c,b){if(c.group!==k.BOARD&&c.group!==k.OTHER){var a=this.PROPFUNC[c.property]+this.GROUPSTR[c.group];if(!!bd[a]){bd[a].call(bd,c.id,b)}switch(c.group){case k.CELL:this.stackCell(c.id);break;case k.CROSS:this.stackCross(c.id);break;case k.BORDER:this.stackBorder(c.id);break;case k.EXCELL:this.stackEXCell(c.id);break}}else{if(c.group===k.BOARD){var e={x1:0,y1:0,x2:2*k.qcols,y2:2*k.qrows};if(b&menu.ex.TURNFLIP){menu.ex.turnflip(b,e)}else{menu.ex.expandreduce(b,e)}bd.disableInfo();this.stackAll();this.reqReset=true}else{this.execSpecial(c,b)}}},execSpecial:function(b,a){},stackAll:function(){this.range={x1:bd.minbx,y1:bd.minby,x2:bd.maxbx,y2:bd.maxby}},stackCell:function(a){this.paintStack(bd.cell[a].bx-1,bd.cell[a].by-1,bd.cell[a].bx+1,bd.cell[a].by+1)},stackCross:function(a){this.paintStack(bd.cross[a].bx-1,bd.cross[a].by-1,bd.cross[a].bx+1,bd.cross[a].by+1)},stackBorder:function(a){if(isNaN(a)||!bd.border[a]){return}if(bd.border[a].bx&1){this.paintStack(bd.border[a].bx-2,bd.border[a].by-1,bd.border[a].bx+2,bd.border[a].by+1)}else{this.paintStack(bd.border[a].bx-1,bd.border[a].by-2,bd.border[a].bx+1,bd.border[a].by+2)}},stackEXCell:function(a){this.paintStack(bd.excell[a].bx-1,bd.excell[a].by-1,bd.excell[a].bx+1,bd.excell[a].by+1)},paintStack:function(b,d,a,c){if(this.range.x1>b){this.range.x1=b}if(this.range.y1>d){this.range.y1=d}if(this.range.x2<a){this.range.x2=a}if(this.range.y2<c){this.range.y2=c}}};Menu=function(){this.dispfloat=[];this.floatpanel=[];this.pop="";this.movingpop="";this.offset=new Point(0,0);this.btnstack=[];this.labelstack=[];this.ex=new MenuExec();this.ex.init();this.language="ja";this.ispencilbox=(k.isKanpenExist&&(k.puzzleid!=="nanro"&&k.puzzleid!=="ayeheya"&&k.puzzleid!=="kurochute"));var d={mouseover:ee.ebinder(this,this.menuhover),mouseout:ee.ebinder(this,this.menuout)};this.EL_MENU=ee.addTemplate("menupanel","li",{className:"menu"},null,d);var a={mouseout:ee.ebinder(this,this.floatmenuout)};this.EL_FLOAT=ee.addTemplate("float_parent","menu",{className:"floatmenu"},{backgroundColor:base.floatbgcolor},a);var c={mouseover:ee.ebinder(this,this.submenuhover),mouseout:ee.ebinder(this,this.submenuout),click:ee.ebinder(this,this.submenuclick)};var b={mouseover:ee.ebinder(this,this.submenuhover),mouseout:ee.ebinder(this,this.submenuout)};this.EL_SMENU=ee.addTemplate("","li",{className:"smenu"},null,c);this.EL_SPARENT=ee.addTemplate("","li",{className:"smenu"},null,b);this.EL_SELECT=ee.addTemplate("","li",{className:"smenu"},{fontWeight:"900",fontSize:"0.9em"},b);this.EL_CHECK=ee.addTemplate("","li",{className:"smenu"},{paddingLeft:"6pt",fontSize:"0.9em"},c);this.EL_LABEL=ee.addTemplate("","li",{className:"smenulabel"},null,null);this.EL_CHILD=this.EL_CHECK;this.EL_SEPARATE=((!k.br.IE6)?ee.addTemplate("","li",{className:"smenusep",innerHTML:"&nbsp;"},null,null):ee.addTemplate("","li",{className:"smenusep",innerHTML:"&nbsp;"},{lineHeight:"2pt",display:"inline"},null));this.EL_DIVPACK=ee.addTemplate("","div",null,null,null);this.EL_SPAN=ee.addTemplate("","span",{unselectable:"on"},null,null);this.EL_CHECKBOX=ee.addTemplate("","input",{type:"checkbox",check:""},null,{click:ee.ebinder(this,this.checkclick)});this.EL_SELCHILD=ee.addTemplate("","div",{className:"flag",unselectable:"on"},null,{click:ee.ebinder(this,this.selectclick)});this.EL_BUTTON=ee.addTemplate("","input",{type:"button"},null,null);this.EL_UBUTTON=ee.addTemplate("btnarea","input",{type:"button"},null,null)};Menu.prototype={menuinit:function(){this.menuarea();this.managearea();this.poparea();this.displayAll();this.doc_design();this.checkUserLang()},menureset:function(){this.dispfloat=[];this.floatpanel=[];this.pop="";this.btnstack=[];this.labelstack=[];this.managestack=[];this.popclose();this.menuclear();this.floatmenuclose(0);ee("float_parent").el.innerHTML="";if(!!ee("btncolor2")){ee("btncolor2").remove()}ee("btnarea").el.innerHTML="";ee("urlbuttonarea").el.innerHTML="";ee("menupanel").el.innerHTML="";ee("usepanel").el.innerHTML="";ee("checkpanel").el.innerHTML="";pp.reset()},addButtons:function(b,c,d,a){if(!!c){b.onclick=c}ee(b).unselectable();this.btnstack.push({el:b,str:{ja:d,en:a}})},addLabels:function(b,c,a){this.labelstack.push({el:b,str:{ja:c,en:a}})},setEvents:function(){var a=ee("divques").el,c=ee("numobj_parent").el;if(!k.mobile){ee.addEvent(a,"mousedown",ee.ebinder(mv,mv.e_mousedown));ee.addEvent(a,"mousemove",ee.ebinder(mv,mv.e_mousemove));ee.addEvent(a,"mouseup",ee.ebinder(mv,mv.e_mouseup));a.oncontextmenu=function(){return false};ee.addEvent(c,"mousedown",ee.ebinder(mv,mv.e_mousedown));ee.addEvent(c,"mousemove",ee.ebinder(mv,mv.e_mousemove));ee.addEvent(c,"mouseup",ee.ebinder(mv,mv.e_mouseup));c.oncontextmenu=function(){return false}}else{ee.addEvent(a,"touchstart",ee.ebinder(mv,mv.e_mousedown));ee.addEvent(a,"touchmove",ee.ebinder(mv,mv.e_mousemove));ee.addEvent(a,"touchend",ee.ebinder(mv,mv.e_mouseup));ee.addEvent(c,"touchstart",ee.ebinder(mv,mv.e_mousedown));ee.addEvent(c,"touchmove",ee.ebinder(mv,mv.e_mousemove));ee.addEvent(c,"touchend",ee.ebinder(mv,mv.e_mouseup))}ee.addEvent(_doc,"keydown",ee.ebinder(kc,kc.e_keydown));ee.addEvent(_doc,"keyup",ee.ebinder(kc,kc.e_keyup));ee.addEvent(_doc,"keypress",ee.ebinder(kc,kc.e_keypress));if(g.use.sl){var b=g.content.findName(g.canvasid);b.AddEventListener("KeyDown",kc.e_SLkeydown);b.AddEventListener("KeyUp",kc.e_SLkeyup)}if(!!this.ex.reader){var d=function(f){this.ex.reader.readAsText(f.dataTransfer.files[0]);f.preventDefault();f.stopPropagation()};ee.addEvent(window,"dragover",function(f){f.preventDefault()},true);ee.addEvent(window,"drop",d,true)}ee.addEvent(_doc,"blur",ee.ebinder(base,base.onblur_func));ee.addEvent(window,(!k.os.iPhoneOS?"resize":"orientationchange"),ee.ebinder(base,base.onresize_func))},displayAll:function(){for(var b in pp.flags){this.setdisplay(b)}for(var b=0,a=this.btnstack.length;b<a;b++){if(!this.btnstack[b].el){continue}this.btnstack[b].el.value=this.btnstack[b].str[this.language]}for(var b=0,a=this.labelstack.length;b<a;b++){if(!this.labelstack[b].el){continue}this.labelstack[b].el.innerHTML=this.labelstack[b].str[this.language]}um.enb_btn()},setdisplay:function(j){switch(pp.type(j)){case pp.MENU:var e=ee("ms_"+j);if(!!e){e.el.innerHTML="["+pp.getMenuStr(j)+"]"}break;case pp.SMENU:case pp.LABEL:case pp.SPARENT:var c=ee("ms_"+j);if(!!c){c.el.innerHTML=pp.getMenuStr(j)}break;case pp.SELECT:var c=ee("ms_"+j),m=ee("cl_"+j);if(!!c){c.el.innerHTML="&nbsp;"+pp.getMenuStr(j)}if(!!m){m.el.innerHTML=pp.getLabel(j)}for(var f=0,h=pp.flags[j].child.length;f<h;f++){this.setdisplay(""+j+"_"+pp.flags[j].child[f])}break;case pp.CHILD:var c=ee("ms_"+j),d=ee("up_"+j);var a=(pp.getVal(j)==pp.getVal(pp.flags[j].parent));var n=pp.getMenuStr(j);if(!!c){c.el.innerHTML=(a?"+":"&nbsp;")+n}if(!!d){d.el.innerHTML=n;d.el.className=(a?"childsel":"child")}break;case pp.CHECK:var c=ee("ms_"+j),b=ee("ck_"+j),m=ee("cl_"+j);var l=pp.getVal(j);if(!!c){c.el.innerHTML=(l?"+":"&nbsp;")+pp.getMenuStr(j)}if(!!b){b.el.checked=l}if(!!m){m.el.innerHTML=pp.getLabel(j)}break}},doc_design:function(){this.displayTitle();_doc.body.style.backgroundImage="url(./bg/"+k.puzzleid+".gif)";if(k.br.IE6){ee("title2").el.style.marginTop="24px";ee("separator2").el.style.margin="0pt"}},displayTitle:function(){var a;if(k.EDITOR){a=""+this.getPuzzleName()+this.selectStr(" エディタ - ぱずぷれv3"," editor - PUZ-PRE v3")}else{a=""+this.getPuzzleName()+this.selectStr(" player - ぱずぷれv3"," player - PUZ-PRE v3")}_doc.title=a;ee("title2").el.innerHTML=a},getPuzzleName:function(){return this.selectStr(PZLNAME.ja[k.pzlnameid],PZLNAME.en[k.pzlnameid])},menuarea:function(){var h=ee.binder(pp,pp.addMenu),c=ee.binder(pp,pp.addSParent),d=ee.binder(pp,pp.addSmenu),b=ee.binder(pp,pp.addSelect),l=ee.binder(pp,pp.addCheck),a=ee.binder(pp,pp.addCaption),i=ee.binder(pp,pp.addChild),f=ee.binder(pp,pp.addSeparator),j=ee.binder(pp,pp.addFlagOnly),e=ee.binder(pp,pp.setLabel);h("file","ファイル","File");d("newboard","file","新規作成","New Board");d("urlinput","file","URL入力","Import from URL");d("urloutput","file","URL出力","Export URL");f("sep_file","file");d("fileopen","file","ファイルを開く","Open the file");c("filesavep","file","ファイル保存 ->","Save the file as ... ->");if(base.dec.DBaccept!==0){d("database","file","一時保存/戻す","Temporary Stack")}if(base.dec.enableSaveImage){f("sep_image","file");c("imagesavep","file","画像を保存 ->","Save as image file")}d("filesave","filesavep","ぱずぷれv3形式","Puz-Pre v3 format");if(this.ispencilbox){d("filesave2","filesavep","pencilbox形式","Pencilbox format")}if(base.dec.enableSaveImage){d("imagedl","imagesavep","画像をダウンロード","Download the image");d("imagesave","imagesavep","別ウィンドウで開く","Open another window")}h("edit","編集","Edit");c("hist","edit","履歴","History");c("board","edit","盤面","Board");f("sep_edit1","edit");d("adjust","edit","盤面の調整","Adjust the Board");d("turn","edit","反転・回転","Filp/Turn the Board");if(base.dec.enSessionStorage()){f("sep_edit2","edit");d("duplicate","edit","盤面の複製","Duplicate the Board")}a("cap_hist","hist","履歴","Display mode");d("h_oldest","hist","最初にジャンプ","Jump to oldest");d("h_undo","hist","元に戻す/Undo","Undo");d("h_redo","hist","やり直し/Redo","Redo");d("h_latest","hist","最後にジャンプ","Jump to latest");a("cap_board","board","盤面","Display mode");d("check","board","チェック","Check the Answer");d("ansclear","board","回答消去","Erase answer");d("subclear","board","補助記号消去","Erase auxiliary marks");h("disp","表示","Display");d("dispsize","disp","サイズ指定","Cell Size");f("sep_disp0","disp");b("size","disp",2,[0,1,2,3,4],"表示サイズ","Cell Size");b("text","disp",(!k.mobile?0:2),[0,1,2,3],"テキストのサイズ","Text Size");f("sep_disp1","disp");if(!!k.irowake){l("irowake","disp",(k.irowake==2?true:false),"線の色分け","Color coding");e("irowake","線の色分けをする","Color each lines")}l("cursor","disp",true,"カーソルの表示","Display cursor");l("adjsize","disp",true,"自動横幅調節","Auto Size Adjust");f("sep_disp2","disp");d("repaint","disp","盤面の再描画","Repaint whole board");d("manarea","disp","管理領域を隠す","Hide Management Area");a("cap_dispmode","size","表示モード","Display mode");i("size_0","size","サイズ 極小","Ex Small");i("size_1","size","サイズ 小","Small");i("size_2","size","サイズ 標準","Normal");i("size_3","size","サイズ 大","Large");i("size_4","size","サイズ 特大","Ex Large");a("cap_textmode","text","テキストのサイズ","Text Size");i("text_0","text","通常","Normal");i("text_1","text","大きい","Big");i("text_2","text","かなり大きい","Ex Big");i("text_3","text","とても大きい","Ex Big 2");this.textsize(pp.getVal("text"));h("setting","設定","Setting");if(k.EDITOR){b("mode","setting",(k.editmode?1:3),[1,3],"モード","mode");e("mode","モード","mode")}else{j("mode",3)}puz.menufix();l("autocheck","setting",k.playmode,"正答自動判定","Auto Answer Check");l("lrcheck","setting",false,"マウス左右反転","Mouse button inversion");e("lrcheck","マウスの左右ボタンを反転する","Invert button of the mouse");if(kp.haspanel[1]||kp.haspanel[3]){l("keypopup","setting",false,"パネル入力","Panel inputting");e("keypopup","数字・記号をパネルで入力する","Input numbers by panel")}b("language","setting","ja",["ja","en"],"言語","Language");i("mode_1","mode","問題作成モード","Edit mode");i("mode_3","mode","回答モード","Answer mode");i("language_ja","language","日本語","日本語");i("language_en","language","English","English");h("other","その他","Others");d("credit","other","ぱずぷれv3について","About PUZ-PRE v3");d("jumpexp","other","操作説明","How to Input");f("sep_other","other");c("link","other","リンク","Link");c("debug","other","デバッグ","Debug");d("jumpv3","link","ぱずぷれv3のページへ","Jump to PUZ-PRE v3 page");d("jumptop","link","連続発破保管庫TOPへ","Jump to indi.s58.xrea.com");d("jumpblog","link","はっぱ日記(blog)へ","Jump to my blog");d("poptest","debug","pop_testを表示","Show pop_test window");this.createAllFloat()},addUseToFlags:function(){pp.addSelect("use","setting",(!k.mobile?1:2),[1,2],"操作方法","Input Type");pp.setLabel("use","操作方法","Input Type");pp.addChild("use_1","use","左右ボタン","LR Button");pp.addChild("use_2","use","1ボタン","One Button")},addRedLineToFlags:function(){pp.addCheck("dispred","setting",false,"繋がりチェック","Continuous Check");pp.setLabel("dispred","線のつながりをチェックする","Check countinuous lines")},addRedBlockToFlags:function(){pp.addCheck("dispred","setting",false,"繋がりチェック","Continuous Check");pp.setLabel("dispred","黒マスのつながりをチェックする","Check countinuous black cells")},addRedBlockRBToFlags:function(){pp.addCheck("dispred","setting",false,"繋がりチェック","Continuous Check");pp.setLabel("dispred","ナナメ黒マスのつながりをチェックする","Check countinuous black cells with its corner")},createAllFloat:function(){for(var l=0;l<pp.flaglist.length;l++){var b=pp.flaglist[l];if(!pp.flags[b]){continue}var c,a="ms_"+b;switch(pp.type(b)){case pp.MENU:c=ee.createEL(this.EL_MENU,a);continue;break;case pp.SEPARATE:c=ee.createEL(this.EL_SEPARATE,a);break;case pp.LABEL:c=ee.createEL(this.EL_LABEL,a);break;case pp.SELECT:c=ee.createEL(this.EL_SELECT,a);break;case pp.SMENU:c=ee.createEL(this.EL_SMENU,a);break;case pp.CHECK:c=ee.createEL(this.EL_CHECK,a);break;case pp.CHILD:c=ee.createEL(this.EL_CHILD,a);break;case pp.SPARENT:var e=(pp.getMenuStr(b).indexOf("->")>=0);c=ee.createEL((e?this.EL_SPARENT:this.EL_SELECT),a);break;default:continue;break}var h=pp.flags[b].parent;if(!this.floatpanel[h]){this.floatpanel[h]=ee.createEL(this.EL_FLOAT,"float_"+h)}this.floatpanel[h].appendChild(c)}var d=ee("float_setting").el,j=d.firstChild.style.fontWeight;for(var l=1,m=d.childNodes.length;l<m;l++){var f=d.childNodes[l];if(j!=f.style.fontWeight){var c=ee.createEL(this.EL_SEPARATE,"");ee(c).insertBefore(f);l++;m++}j=f.style.fontWeight}if(k.PLAYER){ee("ms_newboard").el.className="smenunull";ee("ms_urloutput").el.className="smenunull";ee("ms_adjust").el.className="smenunull"}ee("ms_jumpv3").el.style.fontSize="0.9em";ee("ms_jumpv3").el.style.paddingLeft="8pt";ee("ms_jumptop").el.style.fontSize="0.9em";ee("ms_jumptop").el.style.paddingLeft="8pt";ee("ms_jumpblog").el.style.fontSize="0.9em";ee("ms_jumpblog").el.style.paddingLeft="8pt"},menuhover:function(b){if(!!this.movingpop){return true}var a=ee.getSrcElement(b).id.substr(3);this.floatmenuopen(b,a,0);ee("menupanel").replaceChildrenClass("menusel","menu");ee.getSrcElement(b).className="menusel"},menuout:function(a){if(!this.insideOfMenu(a)){this.menuclear();this.floatmenuclose(0)}},menuclear:function(){ee("menupanel").replaceChildrenClass("menusel","menu")},submenuhover:function(b){var a=ee.getSrcElement(b).id.substr(3);if(ee.getSrcElement(b).className==="smenu"){ee.getSrcElement(b).className="smenusel"}if(pp.flags[a]&&(pp.type(a)===pp.SELECT||pp.type(a)===pp.SPARENT)){if(ee.getSrcElement(b).className!=="smenunull"){this.floatmenuopen(b,a,this.dispfloat.length)}}},submenuout:function(b){var a=ee.getSrcElement(b).id.substr(3);if(ee.getSrcElement(b).className==="smenusel"){ee.getSrcElement(b).className="smenu"}if(pp.flags[a]&&(pp.type(a)===pp.SELECT||pp.type(a)===pp.SPARENT)){this.floatmenuout(b)}},submenuclick:function(b){var a=ee.getSrcElement(b).id.substr(3);if(ee.getSrcElement(b).className==="smenunull"){return}this.menuclear();this.floatmenuclose(0);switch(pp.type(a)){case pp.SMENU:this.popopen(b,a);break;case pp.CHILD:pp.setVal(pp.flags[a].parent,pp.getVal(a));break;case pp.CHECK:pp.setVal(a,!pp.getVal(a));break}},floatmenuopen:function(d,b,f){if(f===0){this.menuclear()}this.floatmenuclose(f);if(f>0&&!this.dispfloat[f-1]){return}var c=ee(ee.getSrcElement(d).id).getRect();var a=this.floatpanel[b];if(f==0){a.style.left=c.left+1+"px";a.style.top=c.bottom+1+"px"}else{if(!k.br.IE6){a.style.left=c.right-3+"px";a.style.top=c.top-3+"px"}else{a.style.left=ee.pageX(d)+"px";a.style.top=c.top-3+"px"}}a.style.zIndex=101+f;a.style.display="block";this.dispfloat.push(a)},floatmenuclose:function(c){for(var b=this.dispfloat.length-1;b>=c;b--){if(b!==0){var a="ms_"+this.dispfloat[b].id.substr(6);ee(a).el.className="smenu"}this.dispfloat[b].style.display="none";this.dispfloat.pop()}},floatmenuout:function(b){for(var a=this.dispfloat.length-1;a>=0;a--){if(this.insideOf(this.dispfloat[a],b)){this.floatmenuclose(a+1);return}}this.menuclear();this.floatmenuclose(0)},insideOf:function(c,f){var b=ee.pageX(f);var a=ee.pageY(f);var d=ee(c.id).getRect();return(b>=d.left&&b<=d.right&&a>=d.top&&a<=d.bottom)},insideOfMenu:function(d){var b=ee.pageX(d);var a=ee.pageY(d);var c=ee("ms_file").getRect(),f=ee("ms_other").getRect();return(a>=c.bottom||(b>=c.left&&b<=f.right&&a>=c.top))},managearea:function(){for(var f=0;f<pp.flaglist.length;f++){var e=pp.flaglist[f];if(!pp.flags[e]||!pp.getLabel(e)){continue}var a=ee(ee.createEL(this.EL_DIVPACK,"div_"+e));switch(pp.type(e)){case pp.SELECT:a.appendEL(ee.createEL(this.EL_SPAN,"cl_"+e));a.appendHTML("&nbsp;|&nbsp;");for(var c=0;c<pp.flags[e].child.length;c++){var b=pp.flags[e].child[c];a.appendEL(ee.createEL(this.EL_SELCHILD,["up",e,b].join("_")));a.appendHTML("&nbsp;")}a.appendBR();ee("usepanel").appendEL(a.el);break;case pp.CHECK:a.appendEL(ee.createEL(this.EL_CHECKBOX,"ck_"+e));a.appendHTML("&nbsp;");a.appendEL(ee.createEL(this.EL_SPAN,"cl_"+e));a.appendBR();ee("checkpanel").appendEL(a.el);break}}if(k.irowake){var d=ee.createEL(this.EL_BUTTON,"ck_btn_irowake");this.addButtons(d,ee.binder(menu.ex,menu.ex.irowakeRemake),"色分けしなおす","Change the color of Line");ee("ck_btn_irowake").insertAfter(ee("cl_irowake").el);var d=ee("checkpanel").el.removeChild(ee("div_irowake").el);ee("checkpanel").el.appendChild(d)}if(k.EDITOR){ee("timerpanel").el.style.display="none";ee("separator2").el.style.display="none"}if(!!ee("ck_keypopup")){pp.funcs.keypopup()}ee.createEL(this.EL_UBUTTON,"btncheck");ee("btnarea").appendHTML("&nbsp;");ee.createEL(this.EL_UBUTTON,"btnundo");ee.createEL(this.EL_UBUTTON,"btnredo");ee("btnarea").appendHTML("&nbsp;");ee.createEL(this.EL_UBUTTON,"btnclear");ee.createEL(this.EL_UBUTTON,"btnclear2");this.addButtons(ee("btncheck").el,ee.binder(ans,ans.check),"チェック","Check");this.addButtons(ee("btnundo").el,ee.binder(um,um.undo,[1]),"戻","<-");this.addButtons(ee("btnredo").el,ee.binder(um,um.redo,[1]),"進","->");this.addButtons(ee("btnclear").el,ee.binder(menu.ex,menu.ex.ACconfirm),"回答消去","Erase Answer");this.addButtons(ee("btnclear2").el,ee.binder(menu.ex,menu.ex.ASconfirm),"補助消去","Erase Auxiliary Marks");ee("btnundo").el.disabled=true;ee("btnredo").el.disabled=true;ee("btnclear").el.disabled=false;ee("btnclear2").el.disabled=false;if(k.irowake!=0){var d=ee.createEL(this.EL_BUTTON,"btncolor2");this.addButtons(d,ee.binder(menu.ex,menu.ex.irowakeRemake),"色分けしなおす","Change the color of Line");ee("btncolor2").insertAfter(ee("btnclear2").el).el.style.display="none"}},checkclick:function(c){var b=ee.getSrcElement(c);var a=b.id.substr(3);pp.setVal(a,!!b.checked)},selectclick:function(b){var a=ee.getSrcElement(b).id.split("_");pp.setVal(a[1],a[2])},poparea:function(){var pop=ee("popup_parent").el.firstChild;while(!!pop){var _el=pop.firstChild;while(!!_el){if(_el.className==="titlebar"){this.titlebarfunc(_el);break}_el=_el.nextSibling}pop=pop.nextSibling}this.titlebarfunc(ee("credit3_1").el);if(!k.mobile){ee.addEvent(_doc,"mousemove",ee.ebinder(this,this.titlebarmove));ee.addEvent(_doc,"mouseup",ee.ebinder(this,this.titlebarup))}else{ee.addEvent(_doc,"touchmove",ee.ebinder(this,this.titlebarmove));ee.addEvent(_doc,"touchend",ee.ebinder(this,this.titlebarup))}var btn=ee.binder(this,this.addButtons);var lab=ee.binder(this,this.addLabels);var close=ee.ebinder(this,this.popclose);var func=null;func=ee.ebinder(this.ex,this.ex.newboard);lab(ee("bar1_1").el,"盤面の新規作成","Createing New Board");lab(ee("pop1_1_cap0").el,"盤面を新規作成します。","Create New Board.");if(k.puzzleid!=="sudoku"&&k.puzzleid!=="tawa"){lab(ee("pop1_1_cap1").el,"よこ","Cols");lab(ee("pop1_1_cap2").el,"たて","Rows")}btn(_doc.newboard.newboard,func,"新規作成","Create");btn(_doc.newboard.cancel,close,"キャンセル","Cancel");func=ee.ebinder(this.ex,this.ex.urlinput);lab(ee("bar1_2").el,"URL入力","Import from URL");lab(ee("pop1_2_cap0").el,"URLから問題を読み込みます。","Import a question from URL.");btn(_doc.urlinput.urlinput,func,"読み込む","Import");btn(_doc.urlinput.cancel,close,"キャンセル","Cancel");func=ee.ebinder(this.ex,this.ex.urloutput);lab(ee("bar1_3").el,"URL出力","Export URL");var btt=function(name,strJP,strEN,eval){if(eval===false){return}var el=ee.createEL(menu.EL_BUTTON,"");el.name=name;ee("urlbuttonarea").appendEL(el).appendBR();btn(el,func,strJP,strEN)};btt("pzprv3","ぱずぷれv3のURLを出力する","Output PUZ-PRE v3 URL",true);btt("pzprapplet","ぱずぷれ(アプレット)のURLを出力する","Output PUZ-PRE(JavaApplet) URL",!k.ispzprv3ONLY);btt("kanpen","カンペンのURLを出力する","Output Kanpen URL",k.isKanpenExist);btt("heyaapp","へやわけアプレットのURLを出力する","Output Heyawake-Applet URL",(k.puzzleid==="heyawake"));btt("pzprv3edit","ぱずぷれv3の再編集用URLを出力する","Output PUZ-PRE v3 Re-Edit URL",true);ee("urlbuttonarea").appendBR();func=ee.ebinder(this.ex,this.ex.openurl);btn(_doc.urloutput.openurl,func,"このURLを開く","Open this URL on another window/tab");btn(_doc.urloutput.close,close,"閉じる","Close");func=ee.ebinder(this.ex,this.ex.fileopen);lab(ee("bar1_4").el,"ファイルを開く","Open file");lab(ee("pop1_4_cap0").el,"ファイル選択","Choose file");_doc.fileform.filebox.onchange=func;btn(_doc.fileform.close,close,"閉じる","Close");func=ee.ebinder(dbm,dbm.clickHandler);lab(ee("bar1_8").el,"一時保存/戻す","Temporary Stack");_doc.database.sorts.onchange=func;_doc.database.datalist.onchange=func;_doc.database.tableup.onclick=func;_doc.database.tabledn.onclick=func;btn(_doc.database.open,func,"データを読み込む","Load");btn(_doc.database.save,func,"盤面を保存","Save");lab(ee("pop1_8_com").el,"コメント:","Comment:");btn(_doc.database.comedit,func,"コメントを編集する","Edit Comment");btn(_doc.database.difedit,func,"難易度を設定する","Set difficulty");btn(_doc.database.del,func,"削除","Delete");btn(_doc.database.close,close,"閉じる","Close");func=ee.ebinder(this.ex,this.ex.popupadjust);lab(ee("bar2_1").el,"盤面の調整","Board Dimension Resizer");lab(ee("pop2_1_cap0").el,"盤面の調整を行います。","Adjust the board.");lab(ee("pop2_1_cap1").el,"拡大","Expand");btn(_doc.adjust.expandup,func,"上","Top");btn(_doc.adjust.expanddn,func,"下","Bottom");btn(_doc.adjust.expandlt,func,"左","Left");btn(_doc.adjust.expandrt,func,"右","Right");lab(ee("pop2_1_cap2").el,"縮小","Reduce");btn(_doc.adjust.reduceup,func,"上","Top");btn(_doc.adjust.reducedn,func,"下","Bottom");btn(_doc.adjust.reducelt,func,"左","Left");btn(_doc.adjust.reducert,func,"右","Right");btn(_doc.adjust.close,close,"閉じる","Close");lab(ee("bar2_2").el,"反転・回転","Flip/Turn the board");lab(ee("pop2_2_cap0").el,"盤面の回転・反転を行います。","Flip/Turn the board.");btn(_doc.flip.turnl,func,"左90°回転","Turn left by 90 degree");btn(_doc.flip.turnr,func,"右90°回転","Turn right by 90 degree");btn(_doc.flip.flipy,func,"上下反転","Flip upside down");btn(_doc.flip.flipx,func,"左右反転","Flip leftside right");btn(_doc.flip.close,close,"閉じる","Close");lab(ee("bar3_1").el,"credit","credit");lab(ee("credit3_1").el,"ぱずぷれv3 "+pzprversion+"<br>\n<br>\nぱずぷれv3は はっぱ/連続発破が作成しています。<br>\n","PUZ-PRE v3 "+pzprversion+"<br>\n<br>\nPUZ-PRE v3 id made by happa.<br>\n");btn(_doc.credit.close,close,"閉じる","OK");func=ee.ebinder(this,this.ex.dispsize);lab(ee("bar4_1").el,"表示サイズの変更","Change size");lab(ee("pop4_1_cap0").el,"表示サイズを変更します。","Change the display size.");lab(ee("pop4_1_cap1").el,"表示サイズ","Display size");btn(_doc.dispsize.dispsize,func,"変更する","Change");btn(_doc.dispsize.cancel,close,"キャンセル","Cancel");debug.poptest_func();if(ee("pop1_8").el.style.display=="inline"){this.pop=ee("pop1_8")}},popopen:function(c,b){this.popclose();if(pp.funcs[b]){pp.funcs[b]()}if(this.pop){var a=this.pop.el;if(!k.mobile){a.style.left=ee.pageX(c)-8+"px";a.style.top=ee.pageY(c)-8+"px"}else{a.style.left=c.pageX-8+"px";a.style.top=c.pageY-8+"px"}a.style.display="inline"}},popclose:function(){if(this.pop){if(this.pop.el.id=="pop1_8"){dbm.closeDialog()}this.pop.el.style.display="none";this.pop="";this.menuclear();this.movingpop="";kc.enableKey=true}},titlebarfunc:function(a){if(!k.mobile){ee.addEvent(a,"mousedown",ee.ebinder(this,this.titlebardown))}else{ee.addEvent(a,"touchstart",ee.ebinder(this,this.titlebardown))}ee(a).unselectable().el},titlebardown:function(b){var a=ee.getSrcElement(b).parentNode;this.movingpop=a;this.offset.x=ee.pageX(b)-parseInt(a.style.left);this.offset.y=ee.pageY(b)-parseInt(a.style.top)},titlebarup:function(b){var a=this.movingpop;if(!!a){this.movingpop=""}},titlebarmove:function(b){var a=this.movingpop;if(!!a){a.style.left=ee.pageX(b)-this.offset.x+"px";a.style.top=ee.pageY(b)-this.offset.y+"px";ee.preventDefault(b)}},textsize:function(b){var d=_doc.styleSheets[0];var f=(!!d.cssRules?d.cssRules:d.rules);if(!f){return}for(var c=0,a=f.length;c<a;c++){var e=f[c];if(!e.selectorText){continue}switch(e.selectorText.toLowerCase()){case"div#menuboard":case"div#btnarea":case"div#popup_parent":case"div#float_parent":e.style.fontSize=["1.0em","1.5em","2.0em","3.0em"][b];e.style.lineHeight=["1.2","1.1","1.1","1.1"][b];break}}},checkUserLang:function(){var a=(navigator.browserLanguage||navigator.language||navigator.userLanguage);if(a.substr(0,2)!=="ja"){pp.setVal("language","en")}},setLang:function(a){this.language=a;this.displayTitle();this.displayAll();this.ex.dispmanstr();pc.resize_canvas()},selectStr:function(b,a){return(this.language==="ja"?b:a)},alertStr:function(b,a){alert(this.language==="ja"?b:a)},confirmStr:function(b,a){return confirm(this.language==="ja"?b:a)}};Caption=function(){this.menu="";this.label=""};SSData=function(){this.id="";this.type=0;this.val=1;this.parent=1;this.child=[];this.str={ja:new Caption(),en:new Caption()}};Properties=function(){this.flags=[];this.flaglist=[];this.MENU=6;this.SPARENT=7;this.SMENU=0;this.SELECT=1;this.CHECK=2;this.LABEL=3;this.CHILD=4;this.SEPARATE=5};Properties.prototype={reset:function(){this.flags=[];this.flaglist=[]},addMenu:function(b,c,a){this.addFlags(b,"",this.MENU,null,c,a)},addSParent:function(c,b,d,a){this.addFlags(c,b,this.SPARENT,null,d,a)},addSmenu:function(c,b,d,a){this.addFlags(c,b,this.SMENU,null,d,a)},addCaption:function(c,b,d,a){this.addFlags(c,b,this.LABEL,null,d,a)},addSeparator:function(b,a){this.addFlags(b,a,this.SEPARATE,null,"","")},addCheck:function(c,b,e,d,a){this.addFlags(c,b,this.CHECK,e,d,a)},addSelect:function(c,b,e,f,d,a){this.addFlags(c,b,this.SELECT,e,d,a);this.flags[c].child=f},addChild:function(c,b,e,a){var d=c.split("_");this.addFlags(c,d[0],this.CHILD,d[1],e,a)},addFlagOnly:function(a,b){this.addFlags(a,"","",b,"","")},addFlags:function(d,c,b,f,e,a){this.flags[d]={id:d,type:b,val:f,parent:c,str:{ja:{menu:e,label:""},en:{menu:a,label:""}}};this.flaglist.push(d)},setLabel:function(b,c,a){if(!this.flags[b]){return}this.flags[b].str.ja.label=c;this.flags[b].str.en.label=a},getMenuStr:function(a){return this.flags[a].str[menu.language].menu},getLabel:function(a){return this.flags[a].str[menu.language].label},type:function(a){return this.flags[a].type},getVal:function(a){return this.flags[a]?this.flags[a].val:null},setVal:function(a,c,b){if(!!this.flags[a]&&(this.flags[a].type===this.CHECK||this.flags[a].type===this.SELECT)){this.flags[a].val=c;menu.setdisplay(a);if(this.funcs[a]&&b!==false){this.funcs[a](c)}}},setValOnly:function(a,b){this.setVal(a,b,false)},funcs:{urlinput:function(){menu.pop=ee("pop1_2")},urloutput:function(){menu.pop=ee("pop1_3");_doc.urloutput.ta.value=""},fileopen:function(){menu.pop=ee("pop1_4")},filesave:function(){menu.ex.filesave(fio.PZPR)},filesave2:function(){if(!!fio.kanpenSave){menu.ex.filesave(fio.PBOX)}},imagedl:function(){menu.ex.imagesave(true)},imagesave:function(){menu.ex.imagesave(false)},database:function(){menu.pop=ee("pop1_8");dbm.openDialog()},h_oldest:function(){um.undoall()},h_undo:function(){um.undo(1)},h_redo:function(){um.redo(1)},h_latest:function(){um.redoall()},check:function(){ans.check()},ansclear:function(){menu.ex.ACconfirm()},subclear:function(){menu.ex.ASconfirm()},adjust:function(){menu.pop=ee("pop2_1")},turn:function(){menu.pop=ee("pop2_2")},duplicate:function(){base.dec.exportFileData()},credit:function(){menu.pop=ee("pop3_1")},jumpexp:function(){window.open("./faq.html?"+k.puzzleid+(k.EDITOR?"_edit":""),"")},jumpv3:function(){window.open("./","","")},jumptop:function(){window.open("../../","","")},jumpblog:function(){window.open("http://d.hatena.ne.jp/sunanekoroom/","","")},irowake:function(){pc.paintAll()},cursor:function(){pc.paintAll()},manarea:function(){menu.ex.dispman()},poptest:function(){debug.disppoptest()},mode:function(a){menu.ex.modechange(a)},text:function(a){menu.textsize(a);pc.resize_canvas()},size:function(a){pc.resize_canvas()},repaint:function(a){pc.resize_canvas()},adjsize:function(a){pc.resize_canvas()},language:function(a){menu.setLang(a)},newboard:function(){menu.pop=ee("pop1_1");if(k.puzzleid!="sudoku"){_doc.newboard.col.value=k.qcols;_doc.newboard.row.value=k.qrows}kc.enableKey=false},dispsize:function(){menu.pop=ee("pop4_1");_doc.dispsize.cs.value=k.cellsize;kc.enableKey=false},keypopup:function(){var a=kp.haspanel[pp.flags.mode.val];ee("ck_keypopup").el.disabled=(a?"":"true");ee("cl_keypopup").el.style.color=(a?"black":"silver");kp.display()}}};var debug={extend:function(a){for(var b in a){this[b]=a[b]}},poptest_func:function(){menu.titlebarfunc(ee("bartest").el);_doc.testform.t1.onclick=ee.binder(this,this.perfeval);_doc.testform.t2.onclick=ee.binder(this,this.painteval);_doc.testform.t3.onclick=ee.binder(this,this.resizeeval);_doc.testform.perfload.onclick=ee.binder(this,this.loadperf);_doc.testform.filesave.onclick=ee.binder(this,this.filesave);_doc.testform.pbfilesave.onclick=ee.binder(this,this.filesave_pencilbox);_doc.testform.fileopen.onclick=ee.binder(this,this.fileopen);_doc.testform.database.onclick=ee.binder(this,this.dispdatabase);_doc.testform.erasetext.onclick=ee.binder(this,this.erasetext);_doc.testform.close.onclick=function(a){ee("poptest").el.style.display="none"};_doc.testform.testarea.style.fontSize="10pt";_doc.testform.starttest.style.display="none";_doc.testform.perfload.style.display=(k.puzzleid!=="country"?"none":"inline");_doc.testform.pbfilesave.style.display=(!menu.ispencilbox?"none":"inline");_doc.testform.database.style.display=(base.dec.enLocalStorage()?"none":"inline");if(k.scriptcheck){debug.testonly_func()}},disppoptest:function(){var a=ee("poptest").el.style;a.display="inline";a.left="40px";a.top="80px"},keydown:function(a){if(kc.isCTRL&&a=="F8"){this.disppoptest();kc.tcMoved=true;return true}return false},filesave:function(){this.setTA(fio.fileencode(fio.PZPH).replace(/\//g,"\n"));this.addTA(fio.history.replace(/\//g,"\n").replace(/\[\[slash\]\]/g,"/"))},filesave_pencilbox:function(){this.setTA(fio.fileencode(fio.PBOX).replace(/\//g,"\n"))},fileopen:function(){var a=this.getTA().replace(/\//g,"[[slash]]").split("\n");fio.filedecode(a.join("/"))},erasetext:function(){this.setTA("");if(k.scriptcheck){ee("testdiv").el.innerHTML=""}},perfeval:function(){this.timeeval("正答判定測定",ee.binder(ans,ans.checkAns))},painteval:function(){this.timeeval("描画時間測定",ee.binder(pc,pc.paintAll))},resizeeval:function(){this.timeeval("resize描画測定",ee.binder(pc,pc.resize_canvas))},timeeval:function(e,c){this.addTA(e);var b=0,a=tm.now();while(tm.now()-a<3000){b++;c()}var d=tm.now()-a;this.addTA("測定データ "+d+"ms / "+b+"回\n平均時間   "+(d/b)+"ms")},dispdatabase:function(){var c="";for(var b=0;b<localStorage.length;b++){var a=localStorage.key(b);c+=(""+a+" "+localStorage[a]+"\n")}this.setTA(c)},loadperf:function(){fio.filedecode("pzprv3/country/10/18/44/0 0 1 1 1 2 2 2 3 4 4 4 5 5 6 6 7 8 /0 9 1 10 10 10 11 2 3 4 12 4 4 5 6 13 13 8 /0 9 1 1 10 10 11 2 3 12 12 12 4 5 14 13 13 15 /0 9 9 9 10 16 16 16 16 17 12 18 4 5 14 13 15 15 /19 19 19 20 20 20 21 17 17 17 22 18 18 14 14 23 23 24 /19 25 25 26 26 21 21 17 22 22 22 18 27 27 27 24 24 24 /28 28 29 26 30 31 21 32 22 33 33 33 33 34 35 35 35 36 /28 29 29 26 30 31 32 32 32 37 38 39 34 34 40 40 35 36 /41 29 29 42 30 31 31 32 31 37 38 39 34 34 34 40 35 36 /41 43 42 42 30 30 31 31 31 37 38 38 38 40 40 40 36 36 /3 . 6 . . 4 . . 2 . . . . . . . . 1 /. . . 5 . . . . . . . . . . . . . . /. . . . . . . . . 1 . . . . . . . . /. . . . . . . . . . . . . . . . . . /3 . . 2 . . . 4 . . . . . . . . . . /. . . 3 . . . . 4 . . . 2 . . . . . /. . . . 3 6 . . . 4 . . . . . . . . /. 5 . . . . . . . 2 . . 3 . . . . . /. . . . . . . . . . . . . . . . . . /. . . . . . . . . . . . . . . . 5 . /0 0 1 1 0 0 1 0 0 1 1 0 0 0 1 1 0 /1 0 0 0 1 0 0 0 1 0 0 1 0 0 0 0 1 /0 0 1 0 1 0 0 1 0 0 0 0 0 0 0 0 0 /0 1 1 0 0 0 1 0 0 1 1 0 1 0 0 0 1 /1 1 0 0 1 0 0 1 1 0 0 0 0 1 0 1 0 /0 1 0 1 0 1 0 0 1 1 1 0 1 0 0 1 1 /1 0 1 0 0 0 0 1 0 1 1 1 0 0 1 1 0 /0 1 0 0 0 0 1 0 0 0 0 1 1 0 1 0 0 /0 1 1 0 1 1 0 0 1 0 1 0 0 0 0 0 0 /1 1 1 0 0 0 1 1 0 0 1 1 1 1 1 0 1 /0 0 1 0 1 0 1 1 0 1 0 1 0 0 1 0 1 0 /1 1 1 0 0 1 1 1 1 0 0 0 1 0 1 0 0 1 /1 1 0 1 1 0 1 0 0 0 0 0 1 0 1 0 0 1 /1 0 0 0 1 0 0 1 0 1 0 1 0 1 1 0 1 0 /0 0 1 0 0 1 0 0 0 0 0 1 0 0 0 1 0 0 /0 1 0 1 1 0 1 0 1 0 0 0 1 1 0 0 0 1 /1 0 1 0 1 0 1 1 0 1 0 0 0 1 1 0 1 1 /1 1 0 0 1 0 0 0 0 1 0 1 0 0 0 1 1 1 /1 0 0 1 0 0 1 0 1 0 1 0 0 0 0 1 1 1 /2 2 1 1 1 2 0 0 2 0 1 0 0 0 0 0 0 2 /1 1 1 2 1 1 0 0 0 1 2 1 0 0 1 2 0 0 /1 0 1 1 1 1 0 0 1 2 2 2 1 0 1 2 2 0 /1 0 0 1 1 2 1 0 2 1 1 1 1 0 1 2 1 0 /1 1 0 2 1 1 2 0 0 0 2 1 2 1 1 1 0 2 /2 1 0 1 1 1 0 2 0 0 0 0 1 1 2 1 0 0 /1 0 1 1 1 2 1 1 0 0 0 0 0 0 1 0 0 0 /0 1 1 2 1 2 1 1 2 1 2 0 1 0 1 0 0 0 /0 1 1 0 1 1 1 2 0 1 0 1 2 2 2 1 0 0 /0 0 0 1 2 2 1 1 0 2 0 0 1 0 1 0 0 0 /");pp.setVal("mode",3);pp.setVal("irowake",true)},getTA:function(){return _doc.testform.testarea.value},setTA:function(a){_doc.testform.testarea.value=a},addTA:function(a){_doc.testform.testarea.value+=(a+"\n")}};MenuExec=function(){this.displaymanage=true;this.qnumw;this.qnumh;this.qnums;this.reader;this.enableReadText=false;this.fileio=(_doc.domain==="indi.s58.xrea.com"?"fileio.xcg":"fileio.cgi");this.insex={};this.insex[k.CELL]={1:true};this.insex[k.CROSS]=(k.iscross===1?{2:true}:{0:true});this.insex[k.BORDER]={1:true,2:true};this.insex[k.EXCELL]={1:true};this.EXPAND=16;this.REDUCE=32;this.TURN=64;this.FLIP=128;this.TURNFLIP=this.TURN|this.FLIP;this.EXPANDUP=this.EXPAND|k.UP;this.EXPANDDN=this.EXPAND|k.DN;this.EXPANDLT=this.EXPAND|k.LT;this.EXPANDRT=this.EXPAND|k.RT;this.REDUCEUP=this.REDUCE|k.UP;this.REDUCEDN=this.REDUCE|k.DN;this.REDUCELT=this.REDUCE|k.LT;this.REDUCERT=this.REDUCE|k.RT;this.TURNL=this.TURN|1;this.TURNR=this.TURN|2;this.FLIPX=this.FLIP|1;this.FLIPY=this.FLIP|2;this.boardtype={expandup:[this.REDUCEUP,this.EXPANDUP],expanddn:[this.REDUCEDN,this.EXPANDDN],expandlt:[this.REDUCELT,this.EXPANDLT],expandrt:[this.REDUCERT,this.EXPANDRT],reduceup:[this.EXPANDUP,this.REDUCEUP],reducedn:[this.EXPANDDN,this.REDUCEDN],reducelt:[this.EXPANDLT,this.REDUCELT],reducert:[this.EXPANDRT,this.REDUCERT],turnl:[this.TURNR,this.TURNL],turnr:[this.TURNL,this.TURNR],flipy:[this.FLIPY,this.FLIPY],flipx:[this.FLIPX,this.FLIPX]}};MenuExec.prototype={init:function(){if(typeof FileReader=="undefined"){this.reader=null;if(typeof FileList!="undefined"&&typeof File.prototype.getAsText!="undefined"){this.enableGetText=true}}else{this.reader=new FileReader();this.reader.onload=ee.ebinder(this,function(a){this.fileonload(a.target.result.replace(/\//g,"[[slash]]"))})}},modechange:function(a){k.editmode=(a==1);k.playmode=(a==3);kc.prev=null;ans.errDisp=true;bd.errclear();if(kp.haspanel[1]||kp.haspanel[3]){pp.funcs.keypopup()}tc.setAlign();pc.paintAll()},newboard:function(b){if(menu.pop){var a,c;if(k.puzzleid!=="sudoku"){a=(parseInt(_doc.newboard.col.value))|0;c=(parseInt(_doc.newboard.row.value))|0}else{if(_doc.newboard.size[0].checked){a=c=9}else{if(_doc.newboard.size[1].checked){a=c=16}else{if(_doc.newboard.size[2].checked){a=c=25}else{if(_doc.newboard.size[3].checked){a=c=4}}}}}menu.popclose();base.dec.parseURI("?"+k.puzzleid+"/"+a+"/"+c);base.init_func(function(){tm.reset()})}},urlinput:function(a){if(menu.pop){menu.popclose();base.dec.parseURI(_doc.urlinput.ta.value);if(!!base.dec.id){base.init_func(function(){tm.reset()})}}},urloutput:function(a){if(menu.pop){switch(ee.getSrcElement(a).name){case"pzprv3":_doc.urloutput.ta.value=enc.pzloutput(enc.PZPRV3);break;case"pzprapplet":_doc.urloutput.ta.value=enc.pzloutput(enc.PZPRAPP);break;case"kanpen":_doc.urloutput.ta.value=enc.pzloutput(enc.KANPEN);break;case"pzprv3edit":_doc.urloutput.ta.value=enc.pzloutput(enc.PZPRV3E);break;case"heyaapp":_doc.urloutput.ta.value=enc.pzloutput(enc.HEYAAPP);break}}},openurl:function(b){if(menu.pop){if(_doc.urloutput.ta.value!==""){var a=window.open(_doc.urloutput.ta.value,"","")}}},fileopen:function(c){if(menu.pop){menu.popclose()}var b=_doc.fileform.filebox;if(!!this.reader||this.enableGetText){var a=b.files[0];if(!a){return}if(!!this.reader){this.reader.readAsText(a)}else{this.fileonload(a.getAsText(""))}}else{if(!b.value){return}_doc.fileform.action=this.fileio;_doc.fileform.submit()}_doc.fileform.reset()},fileonload:function(d){var e=d.split(/[\t\r\n]+/);var a="",b=["",""];for(var c=0;c<e.length;c++){if(e[c].match(/^http\:\/\//)){break}a+=(e[c]+"/")}fio.filedecode(a);_doc.fileform.reset();tm.reset()},filesave:function(a){var d=prompt("保存するファイル名を入力して下さい。",k.puzzleid+".txt");if(!d){return}var c=["\\","/",":","*","?",'"',"<",">","|"];for(var b=0;b<c.length;b++){if(d.indexOf(c[b])!=-1){alert("ファイル名として使用できない文字が含まれています。");return}}_doc.fileform2.filename.value=d;if(navigator.platform.indexOf("Win")!==-1){_doc.fileform2.platform.value="Win"}else{if(navigator.platform.indexOf("Mac")!==-1){_doc.fileform2.platform.value="Mac"}else{_doc.fileform2.platform.value="Others"}}_doc.fileform2.ques.value=fio.fileencode(a);_doc.fileform2.urlstr.value=fio.history;_doc.fileform2.operation.value="save";_doc.fileform2.action=this.fileio;_doc.fileform2.submit()},imagesave:function(i){var c=pc.fillTextEmulate;var a=k.bdmargin;var b=pp.getVal("cursor");try{pc.outputImage=true;pc.fillTextEmulate=false;k.bdmargin=k.bdmargin_image;pp.setValOnly("cursor",false);g=ee("divques_sub").el.getContext("2d");pc.resize_canvas();var d=g.canvas.toDataURL();if(i){_doc.fileform2.filename.value=k.puzzleid+".png";_doc.fileform2.urlstr.value=d.replace("data:image/png;base64,","");_doc.fileform2.operation.value="imagesave";_doc.fileform2.action=this.fileio;_doc.fileform2.submit()}else{if(!k.br.IE9){window.open(d,"","")}else{var h=window.open("","","").document;h.open();h.writeln('<!DOCTYPE html>\n<HTML LANG="ja">\n<HEAD>');h.writeln('<META CHARSET="utf-8">');h.writeln("<TITLE>ぱずぷれv3</TITLE>\n</HEAD>");h.writeln('<BODY><img src="',d,'"></BODY>\n</HTML>');h.close()}}}catch(f){menu.alertStr("画像の出力に失敗しました..","Fail to Output the Image..")}pc.outputImage=false;pc.fillTextEmulate=c;k.bdmargin=a;pp.setValOnly("cursor",b);g=ee("divques").unselectable().el.getContext("2d");pc.resize_canvas()},dispsize:function(b){if(menu.pop){var a=parseInt(_doc.dispsize.cs.value);if(a>0){k.cellsize=(a|0)}menu.popclose();pc.resize_canvas()}},irowakeRemake:function(){line.newIrowake();if(pp.getVal("irowake")){pc.paintAll()}},dispman:function(c){var d=["usepanel","checkpanel"];var a=k.EDITOR?[]:["separator2"];if(this.displaymanage){for(var b=0;b<d.length;b++){ee(d[b]).el.style.display="none"}for(var b=0;b<a.length;b++){ee(a[b]).el.style.display="none"}if(k.irowake!=0&&pp.getVal("irowake")){ee("btncolor2").el.style.display="inline"}ee("menuboard").el.style.paddingBottom="0pt"}else{for(var b=0;b<d.length;b++){ee(d[b]).el.style.display="block"}for(var b=0;b<a.length;b++){ee(a[b]).el.style.display="block"}if(k.irowake!=0&&pp.getVal("irowake")){ee("btncolor2").el.style.display="none"}ee("menuboard").el.style.paddingBottom="8pt"}this.displaymanage=!this.displaymanage;this.dispmanstr();pc.resize_canvas()},dispmanstr:function(){if(!this.displaymanage){ee("ms_manarea").el.innerHTML=menu.selectStr("管理領域を表示","Show management area")}else{ee("ms_manarea").el.innerHTML=menu.selectStr("管理領域を隠す","Hide management area")}},popupadjust:function(b){if(menu.pop){um.newOperation(true);var a=ee.getSrcElement(b).name;if(a.indexOf("reduce")===0){if(a==="reduceup"||a==="reducedn"){if(k.qrows<=1){return}}else{if(a==="reducelt"||a==="reducert"){if(k.qcols<=1&&(k.puzzleid!=="tawa"||bd.lap!==3)){return}}}}var c={x1:0,y1:0,x2:2*k.qcols,y2:2*k.qrows};if(a.match(/(expand|reduce)/)){this.expandreduce(this.boardtype[a][1],c)}else{if(a.match(/(turn|flip)/)){this.turnflip(this.boardtype[a][1],c)}}um.addOpe(k.BOARD,a,0,this.boardtype[a][0],this.boardtype[a][1]);bd.setminmax();if(!um.undoExec){bd.resetInfo()}pc.resize_canvas()}},expandreduce:function(a,b){bd.disableInfo();this.adjustBoardData(a,b);if(a&this.EXPAND){if(a===this.EXPANDUP||a===this.EXPANDDN){k.qrows++}else{if(a===this.EXPANDLT||a===this.EXPANDRT){k.qcols++}}this.expandGroup(k.CELL,a);if(!!k.iscross){this.expandGroup(k.CROSS,a)}if(!!k.isborder){this.expandGroup(k.BORDER,a)}if(!!k.isexcell){this.expandGroup(k.EXCELL,a)}}else{if(a&this.REDUCE){this.reduceGroup(k.CELL,a);if(!!k.iscross){this.reduceGroup(k.CROSS,a)}if(!!k.isborder){this.reduceGroup(k.BORDER,a)}if(!!k.isexcell){this.reduceGroup(k.EXCELL,a)}if(a===this.REDUCEUP||a===this.REDUCEDN){k.qrows--}else{if(a===this.REDUCELT||a===this.REDUCERT){k.qcols--}}}}bd.setposAll();this.adjustBoardData2(a,b);bd.enableInfo()},expandGroup:function(c,b){var d=bd.initGroup(c,k.qcols,k.qrows);var e=bd.getGroup(c);for(var a=e.length-1;a>=0;a--){if(!!this.insex[c][this.distObj(c,a,b)]){e[a]=bd.newObject(c);e[a].allclear(a,false);d--}else{if(d>0){e[a]=e[a-d]}}}if(c===k.BORDER){this.expandborder(b)}},reduceGroup:function(c,b){if(c===k.BORDER){this.reduceborder(b)}var d=0,f=bd.getGroup(c),e=(!um.undoExec&&!um.redoExec);if(e){um.forceRecord=true}for(var a=0;a<f.length;a++){if(!!this.insex[c][this.distObj(c,a,b)]){f[a].allclear(a,e);d++}else{if(d>0){f[a-d]=f[a]}}}for(var a=0;a<d;a++){f.pop()}if(e){um.forceRecord=false}},turnflip:function(b,e){bd.disableInfo();this.adjustBoardData(b,e);if(b&this.TURN){var a=k.qcols;k.qcols=k.qrows;k.qrows=a;bd.setposAll();e={x1:0,y1:0,x2:2*k.qcols,y2:2*k.qrows}}this.turnflipGroup(k.CELL,b,e);if(!!k.iscross){this.turnflipGroup(k.CROSS,b,e)}if(!!k.isborder){this.turnflipGroup(k.BORDER,b,e)}if(k.isexcell===2){this.turnflipGroup(k.EXCELL,b,e)}else{if(k.isexcell===1&&(b&this.FLIP)){var c={x1:e.x1,y1:e.y1,x2:e.x2,y2:e.y2};if(b===this.FLIPY){c.x1=c.x2=-1}else{if(b===this.FLIPX){c.y1=c.y2=-1}}this.turnflipGroup(k.EXCELL,b,c)}}bd.setposAll();this.adjustBoardData2(b,e);bd.enableInfo()},turnflipGroup:function(n,p,m){var c=[],e=bd.objectinside(n,m.x1,m.y1,m.x2,m.y2);for(var h=0;h<e.length;h++){c[e[h]]=false}var o=bd.getGroup(n);var b=(m.x1+m.x2),l=(m.y1+m.y2);for(var a=0;a<o.length;a++){if(c[a]!==false){continue}var f=o[a],j=a;while(c[j]===false){c[j]=true;switch(p){case this.FLIPY:next=bd.idnum(n,o[j].bx,l-o[j].by);break;case this.FLIPX:next=bd.idnum(n,b-o[j].bx,o[j].by);break;case this.TURNR:next=bd.idnum(n,o[j].by,b-o[j].bx,k.qrows,k.qcols);break;case this.TURNL:next=bd.idnum(n,l-o[j].by,o[j].bx,k.qrows,k.qcols);break}if(c[next]===false){o[j]=o[next];j=next}else{o[j]=f;break}}}},distObj:function(b,d,a){var c=bd.getObject(b,d);if(!c){return -1}a&=15;if(a===k.UP){return c.by}else{if(a===k.DN){return 2*k.qrows-c.by}else{if(a===k.LT){return c.bx}else{if(a===k.RT){return 2*k.qcols-c.bx}}}}return -1},expandborder:function(a){if(k.isborderAsLine||!um.undoExec){bd.setposBorders();var c=(k.isborderAsLine?2:1);for(var d=0;d<bd.bdmax;d++){if(this.distObj(k.BORDER,d,a)!==c){continue}var b=(k.isborderAsLine?this.outerBorder(d,a):this.innerBorder(d,a));this.copyBorder(d,b);if(k.isborderAsLine){bd.border[b].allclear(b,false)}}}},reduceborder:function(a){if(k.isborderAsLine){for(var c=0;c<bd.bdmax;c++){if(this.distObj(k.BORDER,c,a)!==0){continue}var b=this.innerBorder(c,a);this.copyBorder(c,b)}}},copyBorder:function(b,a){bd.border[b].ques=bd.border[a].ques;bd.border[b].qans=bd.border[a].qans;if(k.isborderAsLine){bd.border[b].line=bd.border[a].line;bd.border[b].qsub=bd.border[a].qsub;bd.border[b].color=bd.border[a].color}},innerBorder:function(d,a){var c=bd.border[d].bx,b=bd.border[d].by;a&=15;if(a===k.UP){return bd.bnum(c,b+2)}else{if(a===k.DN){return bd.bnum(c,b-2)}else{if(a===k.LT){return bd.bnum(c+2,b)}else{if(a===k.RT){return bd.bnum(c-2,b)}}}}return null},outerBorder:function(d,a){var c=bd.border[d].bx,b=bd.border[d].by;a&=15;if(a===k.UP){return bd.bnum(c,b-2)}else{if(a===k.DN){return bd.bnum(c,b+2)}else{if(a===k.LT){return bd.bnum(c-2,b)}else{if(a===k.RT){return bd.bnum(c+2,b)}}}}return null},adjustBoardData:function(b,l){this.adjustSpecial.call(this,b,l);if(b&this.TURNFLIP){var h={};switch(b){case this.FLIPY:h={2:5,3:4,4:3,5:2,14:17,15:16,16:15,17:14};break;case this.FLIPX:h={2:3,3:2,4:5,5:4,14:15,15:14,16:17,17:16};break;case this.TURNR:h={2:5,3:2,4:3,5:4,12:13,13:12,14:17,15:14,16:15,17:16,21:22,22:21};break;case this.TURNL:h={2:3,3:4,4:5,5:2,12:13,13:12,14:15,15:16,16:17,17:14,21:22,22:21};break}var f={};switch(b){case this.FLIPY:f={1:2,2:1};break;case this.FLIPX:f={3:4,4:3};break;case this.TURNR:f={1:4,2:3,3:1,4:2};break;case this.TURNL:f={1:3,2:4,3:2,4:1};break}var e=bd.cellinside(l.x1,l.y1,l.x2,l.y2);for(var a=0;a<e.length;a++){var m=e[a];var j=h[bd.QuC(m)];if(!!j){bd.sQuC(m,j)}if(k.isexcell!==1){var j=f[bd.DiC(m)];if(!!j){bd.sDiC(m,j)}}}}if((b&this.REDUCE)&&k.roomNumber){this.qnums=[];for(var a=0;a<bd.cell.length;a++){if(!!this.insex[k.CELL][this.distObj(k.CELL,a,b)]&&bd.cell[a].qnum!==-1){this.qnums.push({areaid:area.getRoomID(a),val:bd.cell[a].qnum})}}}},adjustBoardData2:function(b,e){if((b&this.REDUCE)&&k.roomNumber){area.resetArea();for(var a=0;a<this.qnums.length;a++){var f=area.getTopOfRoom(this.qnums[a].areaid);bd.cell[f].qnum=this.qnums[a].val}}this.adjustSpecial2.call(this,b,e)},adjustSpecial:function(a,b){},adjustSpecial2:function(a,b){},adjustQues51_1:function(a,h){var b=(h.x1|1),f=(h.y1|1);this.qnumw=[];this.qnumh=[];for(var c=f;c<=h.y2;c+=2){this.qnumw[c]=[bd.QnE(bd.exnum(-1,c))];for(var e=b;e<=h.x2;e+=2){var i=bd.cnum(e,c);if(i!==null&&bd.QuC(i)===51){this.qnumw[c].push(bd.QnC(i))}}}for(var e=b;e<=h.x2;e+=2){this.qnumh[e]=[bd.DiE(bd.exnum(e,-1))];for(var c=f;c<=h.y2;c+=2){var i=bd.cnum(e,c);if(i!==null&&bd.QuC(i)===51){this.qnumh[e].push(bd.DiC(i))}}}},adjustQues51_2:function(m,i){var a=(i.x1+i.x2),h=(i.y1+i.y2),e=(i.x1|1),b=(i.y1|1),l;switch(m){case this.FLIPY:for(var j=e;j<=i.x2;j+=2){l=1;this.qnumh[j]=this.qnumh[j].reverse();bd.sDiE(bd.exnum(j,-1),this.qnumh[j][0]);for(var f=b;f<=i.y2;f+=2){var c=bd.cnum(j,f);if(c!==null&&bd.QuC(c)===51){bd.sDiC(c,this.qnumh[j][l]);l++}}}break;case this.FLIPX:for(var f=b;f<=i.y2;f+=2){l=1;this.qnumw[f]=this.qnumw[f].reverse();bd.sQnE(bd.exnum(-1,f),this.qnumw[f][0]);for(var j=e;j<=i.x2;j+=2){var c=bd.cnum(j,f);if(c!==null&&bd.QuC(c)===51){bd.sQnC(c,this.qnumw[f][l]);l++}}}break;case this.TURNR:for(var f=b;f<=i.y2;f+=2){l=1;this.qnumh[f]=this.qnumh[f].reverse();bd.sQnE(bd.exnum(-1,f),this.qnumh[f][0]);for(var j=e;j<=i.x2;j+=2){var c=bd.cnum(j,f);if(c!==null&&bd.QuC(c)===51){bd.sQnC(c,this.qnumh[f][l]);l++}}}for(var j=e;j<=i.x2;j+=2){l=1;bd.sDiE(bd.exnum(j,-1),this.qnumw[a-j][0]);for(var f=b;f<=i.y2;f+=2){var c=bd.cnum(j,f);if(c!==null&&bd.QuC(c)===51){bd.sDiC(c,this.qnumw[a-j][l]);l++}}}break;case this.TURNL:for(var f=b;f<=i.y2;f+=2){l=1;bd.sQnE(bd.exnum(-1,f),this.qnumh[h-f][0]);for(var j=e;j<=i.x2;j+=2){var c=bd.cnum(j,f);if(c!==null&&bd.QuC(c)===51){bd.sQnC(c,this.qnumh[h-f][l]);l++}}}for(var j=e;j<=i.x2;j+=2){l=1;this.qnumw[j]=this.qnumw[j].reverse();bd.sDiE(bd.exnum(j,-1),this.qnumw[j][0]);for(var f=b;f<=i.y2;f+=2){var c=bd.cnum(j,f);if(c!==null&&bd.QuC(c)===51){bd.sDiC(c,this.qnumw[j][l]);l++}}}break}},ACconfirm:function(){if(menu.confirmStr("回答を消去しますか？","Do you want to erase the Answer?")){um.newOperation(true);bd.ansclear();bd.resetInfo();pc.paintAll()}},ASconfirm:function(){if(menu.confirmStr("補助記号を消去しますか？","Do you want to erase the auxiliary marks?")){um.newOperation(true);bd.subclear();pc.paintAll()}}};