/*! @license pzpr.js v3.4.0-pre (c) 2009-2014 sabo2, MIT license
 *   https://bitbucket.org/sabo2/pzprv3 */
!function(){var a=pzpr.consts;pzpr.createCustoms("goishi",{MouseEvent:{initialize:function(){pzpr.common.MouseEvent.prototype.initialize.call(this),this.ut=new this.owner.UndoTimer_goishi},mouseinput:function(){this.owner.playmode&&this.mousestart?this.btn.Left?this.inputqans():this.btn.Right&&this.ut.startMouseUndo():this.owner.editmode&&this.mousestart&&this.inputstone(),this.mouseend&&this.ut.stop()},inputstone:function(){var a=this.getcell();a.isnull||(a!==this.cursor.getTCC()&&this.setcursor(a),a.setStone(),a.draw())},inputqans:function(){var a=this.getcell();if(a.isnull||!a.isStone()||-1!==a.anum)return this.ut.startMouseRedo(),void 0;for(var b=0,c=this.owner.board,d=c.emptycell,e=0;e<c.cellmax;e++){var f=c.cell[e];f.anum>b&&(b=f.anum,d=f)}if(!d.isnull){var g,h={x1:a.bx,y1:a.by,x2:d.bx,y2:d.by};if(h.x1!==h.x2&&h.y1!==h.y2)return;h.x1===h.x2?(h.y1>h.y2&&(g=h.y2,h.y2=h.y1,h.y1=g),h.y1+=2,h.y2-=2):(h.x1>h.x2&&(g=h.x2,h.x2=h.x1,h.x1=g),h.x1+=2,h.x2-=2);for(var i=h.x1;i<=h.x2;i+=2)for(var j=h.y1;j<=h.y2;j+=2){var f=c.getc(i,j);if(!f.isnull&&f.isStone()&&(-1===f.anum||b>=2&&f.anum===b-1))return}}a.setAnum(b+1),a.draw()}},KeyEvent:{enablemake:!0,keyinput:function(a){this.key_inputstone(a)},key_inputstone:function(a){if("q"==a){var b=this.cursor.getTCC();b.setStone(),b.draw()}}},Cell:{ques:7,isStone:function(){return 7!==this.ques},setStone:function(){7===this.ques?this.setQues(0):-1===this.anum&&this.setQues(7)}},Flags:{disable_subclear:!0},Graphic:{initialize:function(){this.Common.prototype.initialize.call(this),this.errcolor1="rgb(208, 0, 0)",this.errbcolor1="rgb(255, 192, 192)"},paint:function(){this.drawCenterLines(),this.drawCircles(),this.drawCellSquare(),this.drawNumbers(),this.drawTarget()},drawCenterLines:function(){var a=this.vinc("centerline","crispEdges"),b=this.owner.board,c=this.range.x1,d=this.range.y1,e=this.range.x2,f=this.range.y2;c<b.minbx+1&&(c=b.minbx+1),e>b.maxbx-1&&(e=b.maxbx-1),d<b.minby+1&&(d=b.minby+1),f>b.maxby-1&&(f=b.maxby-1),c|=1,d|=1,a.fillStyle=this.gridcolor_LIGHT;for(var g=c;e>=g;g+=2)this.vnop("cliney_"+g,this.NONE)&&a.fillRect(g*this.bw,d*this.bh,1,(f-d)*this.bh+1);for(var g=d;f>=g;g+=2)this.vnop("clinex_"+g,this.NONE)&&a.fillRect(c*this.bw,g*this.bh,(e-c)*this.bw+1,1)},getCircleStrokeColor:function(a){return a.isStone()&&-1===a.anum?1===a.error?this.errcolor1:this.cellcolor:null},getCircleFillColor:function(a){return a.isStone()&&-1===a.anum?1===a.error?this.errbcolor1:"white":null},drawCellSquare:function(){for(var a=this.vinc("cell_number_base","crispEdges"),b=.8*this.bw-2,c=.8*this.bh-2,d="c_sq2_",e=this.range.cells,f=0;f<e.length;f++){var g=e[f];if(g.isStone()&&-1!==g.anum){if(a.fillStyle=1===g.error?this.errbcolor1:"white",this.vnop(d+g.id,this.FILL)){var h=g.bx*this.bw,i=g.by*this.bh;a.fillRect(h-b,i-c,2*b+1,2*c+1)}}else this.vhide([d+g.id])}}},Encode:{decodePzpr:function(){this.decodeGoishi()},encodePzpr:function(){this.encodeGoishi()},decodeKanpen:function(){this.owner.fio.decodeGoishi_kanpen()},encodeKanpen:function(){this.owner.fio.encodeGoishi_kanpen()},decodeGoishi:function(){var a=this.outbstr,b=0,c=this.owner.board,d=[16,8,4,2,1];c.disableInfo();for(var e=0;e<a.length;e++){for(var f=parseInt(a.charAt(e),32),g=0;5>g;g++)b<c.cellmax&&(c.cell[b].setQues(f&d[g]?7:0),b++);if(b>=c.qcols*c.qrows)break}c.enableInfo(),this.outbstr=a.substr(e+1)},encodeGoishi:function(){for(var a=this.getSizeOfBoard_goishi(),b="",c=0,d=0,e=[16,8,4,2,1],f=a.y1;f<=a.y2;f+=2)for(var g=a.x1;g<=a.x2;g+=2){var h=this.owner.board.getc(g,f);(h.isnull||!h.isStone())&&(d+=e[c]),c++,5==c&&(b+=d.toString(32),c=0,d=0)}c>0&&(b+=d.toString(32)),this.outbstr+=b,this.outsize=[a.cols,a.rows].join("/")},getSizeOfBoard_goishi:function(){for(var a=9999,b=-1,c=9999,d=-1,e=0,f=this.owner.board,g=0;g<f.cellmax;g++){var h=f.cell[g];h.isStone()&&(a>h.bx&&(a=h.bx),b<h.bx&&(b=h.bx),c>h.by&&(c=h.by),d<h.by&&(d=h.by),e++)}return 0==e?{x1:0,y1:0,x2:1,y2:1,cols:2,rows:2}:this.getConfig("bdpadding")?{x1:a-2,y1:c-2,x2:b+2,y2:d+2,cols:(b-a+6)/2,rows:(d-c+6)/2}:{x1:a,y1:c,x2:b,y2:d,cols:(b-a+2)/2,rows:(d-c+2)/2}}},FileIO:{decodeData:function(){this.decodeGoishiFile()},encodeData:function(){this.encodeGoishiFile()},kanpenOpen:function(){this.decodeGoishi_kanpen(),this.decodeQansPos_kanpen()},kanpenSave:function(){this.encodeGoishi_kanpen(),this.encodeQansPos_kanpen()},decodeGoishiFile:function(){this.decodeCell(function(a,b){"."!==b&&(a.ques=0,"0"!==b&&(a.anum=parseInt(b)))})},encodeGoishiFile:function(){this.encodeCell(function(a){return 0===a.ques?-1!==a.anum?""+a.anum+" ":"0 ":". "})},decodeGoishi_kanpen:function(){this.decodeCell(function(a,b){"1"===b&&(a.ques=0)})},encodeGoishi_kanpen:function(){for(var a=this.owner.board,b=a.minby+1;b<a.maxby;b+=2){for(var c=a.minbx+1;c<a.maxbx;c+=2)this.datastr+=a.getc(c,b).isStone()?"1 ":". ";this.datastr+="\n"}},decodeQansPos_kanpen:function(){for(;;){var a=this.readLine();if(!a)break;var b=a.split(" ");if(b.length<=1)return;var c=this.owner.board.getc(2*parseInt(b[2])+1,2*parseInt(b[1])+1);c.ques=0,c.anum=parseInt(b[0])}},encodeQansPos_kanpen:function(){for(var a=[],b=this.owner.board,c=b.minby+1;c<b.maxby;c+=2)for(var d=b.minbx+1;d<b.maxbx;d+=2){var e=b.getc(d,c);if(0===e.ques&&-1!==e.anum){var f=[(d>>1).toString(),(c>>1).toString()];a[e.anum-1]=f}}for(var g=0,h=a.length;h>g;g++){var i=[g+1,a[g][1],a[g][0]];this.datastr+=i.join(" ")+"\n"}}},AnsCheck:{checkAns:function(){return this.checkPickedStone()?null:"goishiRemains"},checkPickedStone:function(){return this.checkAllCell(function(a){return a.isStone()&&-1===a.anum})}},FailCode:{goishiRemains:["拾われていない碁石があります。","There is remaining Goishi."]},UndoTimer_goishi:{initialize:function(){this.TID=null,this.timerInterval=25;var a=pzpr.env.browser;(a.IE6||a.IE7||a.IE8)&&(this.timerInterval*=2),this.inUNDO=!1,this.inREDO=!1,this.undoWaitTime=300,this.undoWaitCount=0,this.stop()},startMouseUndo:function(){this.inUNDO||(this.inUNDO=!0,this.startProc())},startMouseRedo:function(){this.inREDO||(this.inREDO=!0,this.startProc())},startProc:function(){if(this.undoWaitCount=this.undoWaitTime/this.timerInterval,!this.TID){var a=this;this.TID=setInterval(function(){a.proc()},this.timerInterval)}this.exec()},stop:function(){this.inUNDO=!1,this.inREDO=!1,clearInterval(this.TID),this.TID=null},proc:function(){this.inUNDO||this.inREDO?this.undoWaitCount>0?this.undoWaitCount--:this.exec():this.stop()},exec:function(){var b=this.owner,c=b.opemgr;if(this.inUNDO){var d=c.enableUndo?c.ope[c.position-1].property:"";d!==a.ANUM&&this.stop()}else if(this.inREDO){var d=c.enableRedo?c.ope[c.position].property:"";d!==a.ANUM&&this.stop()}this.TID&&(this.inUNDO?b.undo()||this.stop():this.inREDO&&(b.redo()||this.stop()))}}})}();