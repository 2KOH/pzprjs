/*! @license pzpr.js v3.4.0-pre (c) 2009-2014 sabo2, MIT license
 *   https://bitbucket.org/sabo2/pzprv3 */
!function(){var a=pzpr.consts;pzpr.createCustoms("kinkonkan",{MouseEvent:{mouseinput:function(){this.owner.playmode?this.mousestart?this.inputslash():this.mousemove&&null!==this.inputData&&this.inputslash():this.owner.editmode&&(this.mousestart?this.input_onstart():this.mousemove&&this.btn.Left&&this.inputborder()),this.mouseend&&12==this.inputData&&this.owner.board.lightclear()},inputslash:function(){var a=this.getcell();if(a.isnull)return this.inputflash(),void 0;if(3===this.inputData)a.setQans(0),a.setQsub(1);else if(4===this.inputData)a.setQans(0),a.setQsub(0);else{if(null!==this.inputData)return;this.btn.Left?31===a.getQans()?(a.setQans(32),a.setQsub(0),this.inputData=2):32===a.getQans()?(a.setQans(0),a.setQsub(1),this.inputData=3):1===a.getQsub()?(a.setQans(0),a.setQsub(0),this.inputData=4):(a.setQans(31),a.setQsub(0),this.inputData=1):this.btn.Right&&(31===a.getQans()?(a.setQans(0),a.setQsub(0),this.inputData=4):32===a.getQans()?(a.setQans(31),a.setQsub(0),this.inputData=1):1===a.getQsub()?(a.setQans(32),a.setQsub(0),this.inputData=2):(a.setQans(0),a.setQsub(1),this.inputData=3))}a.drawaround()},inputflash:function(){var a=this.getpos(0).getex();a.isnull||this.mouseCell===a||a.id>=this.owner.board.excellmax-4||(11!=this.inputData&&null!==this.inputData||(null===this.inputData&&1===a.qlight?this.inputData=12:(this.owner.board.flashlight(a.id),this.owner.redraw(),this.inputData=11)),this.mouseCell=a)},input_onstart:function(){var a=this.getcell_excell();if(!a.isnull)if(a.isexcellobj)if(a!==this.cursor.getOBJ())this.setcursor(a),this.mousereset();else{var b=a;1!==b.qlight?this.owner.board.flashlight(b.id):this.owner.board.lightclear(),this.owner.redraw(),this.mousereset()}else this.inputborder()}},KeyEvent:{enablemake:!0,moveTarget:function(b){var c=this.cursor,d=c.getTEC(),e=c.getTCP(),f=!0,g=a.NDIR;return b===this.KEYUP?e.by===c.maxy&&c.minx<e.bx&&e.bx<c.maxx?c.pos.by=c.miny:e.by>c.miny?g=a.UP:f=!1:b===this.KEYDN?e.by===c.miny&&c.minx<e.bx&&e.bx<c.maxx?c.pos.by=c.maxy:e.by<c.maxy?g=a.DN:f=!1:b===this.KEYLT?e.bx===c.maxx&&c.miny<e.by&&e.by<c.maxy?c.pos.bx=c.minx:e.bx>c.minx?g=a.LT:f=!1:b===this.KEYRT?e.bx===c.minx&&c.miny<e.by&&e.by<c.maxy?c.pos.bx=c.maxx:e.bx<c.maxx?g=a.RT:f=!1:f=!1,f&&(g!==a.NDIR&&c.pos.movedir(g,2),d.draw(),c.getTCP().draw(),this.stopEvent()),f},keyinput:function(a){this.key_inputexcell(a)},key_inputexcell:function(a){var b=this.cursor.getTEC(),c=b.getQnum();if(a>="0"&&"9">=a){var d=parseInt(a);0>=c||this.prev!==b?d<=b.maxnum&&b.setQnum(d):10*c+d<=b.maxnum?b.setQnum(10*c+d):d<=b.maxnum&&b.setQnum(d)}else if(1===a.length&&a>="a"&&"z">=a){var d=parseInt(a,36)-10,e=b.getQchar();(e-1)%26==d&&e>0&&79>e?b.setQchar(e+26):(e-1)%26==d?b.setQchar(0):b.setQchar(d+1)}else if("-"==a)-1!==c?b.setQnum(-1):(b.setQnum(-1),b.setQchar(0));else if("F4"==a)1!==b.qlight?this.owner.board.flashlight(b.id):this.owner.board.lightclear(),this.owner.redraw();else{if(" "!=a)return;b.setQnum(-1),b.setQchar(0)}this.prev=b,this.cursor.getTCP().draw()}},TargetCursor:{initCursor:function(){this.setTEC(this.owner.board.excell[0])}},Cell:{qlight:0,allclear:function(a){this.Common.prototype.allclear.call(this,a),this.qlight=0},ansclear:function(){this.Common.prototype.ansclear.call(this),this.qlight=0},subclear:function(){this.Common.prototype.subclear.call(this),this.qlight=0}},EXCell:{qlight:0,allclear:function(a){this.Common.prototype.allclear.call(this,a),this.qlight=0},ansclear:function(){this.Common.prototype.ansclear.call(this),this.qlight=0},subclear:function(){this.Common.prototype.subclear.call(this),this.qlight=0},minnum:0},Board:{qcols:8,qrows:8,isborder:1,isexcell:2,errclear:function(){pzpr.common.Board.prototype.errclear.call(this,!1),this.lightclear(),this.owner.redraw()},haslight:!1,lightclear:function(){if(this.haslight){for(var a=0;a<this.cellmax;a++)this.cell[a].qlight=0;for(var a=0;a<this.excellmax;a++)this.excell[a].qlight=0;this.haslight=!1}},flashlight:function(a){this.lightclear(),this.searchLight(a,!0)},searchLight:function(a,b){for(var c=0,d=[],e=0;e<this.cellmax;e++)d[e]=0;var f=this.excell[a].getaddr(),g=0;for(f.by===this.minby+1?g=2:f.by===this.maxby-1?g=1:f.bx===this.minbx+1?g=4:f.bx===this.maxbx-1&&(g=3);0!==g;){f.movedir(g,2);var h=f.getc();if(h.isnull)break;var i=h.getQans(),j=h.id;if(31===i)1===g?(d[j]=isNaN({4:1,1:1}[d[j]])?2:1,g=3):2===g?(d[j]=isNaN({2:1,1:1}[d[j]])?4:1,g=4):3===g?(d[j]=isNaN({2:1,1:1}[d[j]])?4:1,g=1):4===g&&(d[j]=isNaN({4:1,1:1}[d[j]])?2:1,g=2);else{if(32!==i){d[j]=1;continue}1===g?(d[j]=isNaN({5:1,1:1}[d[j]])?3:1,g=4):2===g?(d[j]=isNaN({3:1,1:1}[d[j]])?5:1,g=3):3===g?(d[j]=isNaN({5:1,1:1}[d[j]])?3:1,g=2):4===g&&(d[j]=isNaN({3:1,1:1}[d[j]])?5:1,g=1)}if(c++,c>this.cellmax)break}var k=f.getex().id;if(b){for(var e=0;e<this.excellmax;e++)this.excell[e].qlight=0;this.excell[a].qlight=1,this.excell[k].qlight=1;for(var e=0;e<this.cellmax;e++)this.cell[e].qlight=d[e];this.haslight=!0}return{cnt:c,dest:k}}},BoardExec:{adjustBoardData:function(b){this.owner.board;if(b&a.TURNFLIP)for(var c=this.owner.board.cell,d=0;d<c.length;d++){var e=c[d];e.setQans({0:0,31:32,32:31}[e.getQans()])}}},AreaRoomManager:{enabled:!0},Graphic:{initialize:function(){this.Common.prototype.initialize.call(this),this.gridcolor=this.gridcolor_LIGHT,this.errcolor1=this.cellcolor,this.errcolor2=this.cellcolor,this.lightcolor="rgb(255, 255, 127)",this.dotcolor=this.dotcolor_PINK},paint:function(){this.drawBGCells_kinkonkan(),this.drawDotCells(!0),this.drawGrid(),this.drawBorders(),this.drawSlashes(),this.drawBGEXcells(),this.drawNumbers_kinkonkan(),this.drawChassis(),this.drawTarget()},drawBGCells_kinkonkan:function(){for(var a=this.vinc("cell_back","crispEdges"),b=["c_full_","c_tri2_","c_tri3_","c_tri4_","c_tri5_"],c=this.range.cells,d=0;d<c.length;d++){var e=c[d],f=e.id,g=e.error,h=e.qlight;if(0!==g||0!==h){1==g?a.fillStyle=this.errbcolor1:h>0&&(a.fillStyle=this.lightcolor);var i=(e.bx-1)*this.bw,j=(e.by-1)*this.bh;1===g||1===h?this.vnop(b[0]+f,this.FILL)&&a.fillRect(i,j,this.cw,this.ch):this.drawTriangle1(i,j,h,b[h-1]+f)}else this.vhide([b[0]+f,b[1]+f,b[2]+f,b[3]+f,b[4]+f,b[5]+f])}},getBGEXcellColor:function(a){return 1===a.qlight?this.lightcolor:null},drawNumbers_kinkonkan:function(){for(var a=(this.vinc("excell_number","auto"),this.range.excells),b=0;b<a.length;b++){var c=a[b],d="excell_"+c.id;if(0!==c.qchar||-1!==c.qnum){var e=c.qnum,f=c.qchar,g=this.fontErrcolor;1!==c.error&&(g=52>=f?this.fontcolor:this.fontAnscolor);var h=.66;f>0&&e>=10&&(h=.55);var i="";f>0&&26>=f?i+=(f+9).toString(36).toUpperCase():f>26&&52>=f?i+=(f-17).toString(36).toLowerCase():f>52&&78>=f?i+=(f-43).toString(36).toUpperCase():f>78&&104>=f&&(i+=(f-69).toString(36).toLowerCase()),e>=0&&(i+=e.toString(10));var j=c.bx*this.bw,k=c.by*this.bh;this.dispnum(d,1,i,h,g,j,k)}else this.hidenum(d)}}},Encode:{decodePzpr:function(){this.decodeBorder(),this.decodeKinkonkan()},encodePzpr:function(){this.encodeBorder(),this.encodeKinkonkan()},decodeKinkonkan:function(){for(var a=[],b=0,c=0,d=this.outbstr,e=this.owner.board,f=0;f<d.length;f++){var g=d.charAt(f),h=e.excell[b];if(this.include(g,"A","Z")?(a.push(b),h.qchar=parseInt(g,36)-9):this.include(g,"0","9")?(a.push(b),h.qchar=parseInt(g,36)-9+26*(parseInt(d.charAt(f+1))+1),f++):this.include(g,"a","z")&&(b+=parseInt(g,36)-10),b++,b>=e.excellmax-4){c=f+1;break}}b=0;for(var f=c;f<d.length;f++){var g=d.charAt(f),h=e.excell[a[b]];if("."===g?h.qnum=-2:"-"===g?(h.qnum=parseInt(d.substr(f+1,2),16),f+=2):h.qnum=parseInt(d.substr(f,1),16),b++,b>=a.length){c=f+1;break}}this.outbstr=d.substr(c)},encodeKinkonkan:function(){for(var a="",b="",c=this.owner.board,d=0,e=0;e<c.excellmax-4;e++){var f="",g=c.excell[e].qchar,h=c.excell[e].qnum;g>0&&104>=g?(f=26>=g?(g+9).toString(36).toUpperCase():((g-1)/26-1|0).toString()+((g-1)%26+10).toString(16).toUpperCase(),b+=-2==h?".":16>h?""+h.toString(16):"-"+h.toString(16)):d++,0===d?a+=f:(f||26===d)&&(a+=(9+d).toString(36)+f,d=0)}d>0&&(a+=(9+d).toString(36)),this.outbstr+=a+b}},FileIO:{decodeData:function(){this.decodeAreaRoom();for(var a=this.owner.board,b=this.getItemList(a.qrows+2),c=0;c<b.length;c++){var d=b[c];if("."!==d){var e=c%(a.qcols+2)*2-1,f=(c/(a.qcols+2)<<1)-1,g=a.getex(e,f);if(g.isnull){if(1==this.filever){var h=a.getc(e,f);h.isnull||("+"===d?h.qsub=1:"1"===d?h.qans=31:"2"===d&&(h.qans=32))}}else{var i=d.split(",");""!==i[0]&&(g.qchar=parseInt(i[0])),""!==i[1]&&(g.qnum=parseInt(i[1]))}}}0==this.filever&&this.decodeCell(function(a,b){"+"===b?a.qsub=1:"1"===b?a.qans=31:"2"===b&&(a.qans=32)})},encodeData:function(){this.filever=1,this.encodeAreaRoom();for(var a=this.owner.board,b=-1;b<a.maxby;b+=2){for(var c=-1;c<a.maxbx;c+=2){var d=a.getex(c,b);if(d.isnull){var e=a.getc(c,b);this.datastr+=e.isnull?". ":31===e.qans?"1 ":32===e.qans?"2 ":1===e.qsub?"+ ":". "}else{var f=d.qchar,g=d.qnum,h=0!==f?f.toString():"",i=-1!==g?g.toString():"";this.datastr+=""==h&&""==i?". ":""+h+","+i+" "}}this.datastr+="\n"}}},AnsCheck:{checkAns:function(){var a=this.owner.board.getRoomInfo();return this.checkNoPluralMirrorsInRoom(a)?this.checkMirrors(1)?this.checkMirrors(2)?this.checkExistMirrorInRoom(a)?null:"bkNoObj":"pairedNumberNe":"pairedLetterNe":"bkObjGe2"},checkNoPluralMirrorsInRoom:function(a){return this.checkAllBlock(a,function(a){return 0!==a.getQans()},function(a,b,c){return 1>=c})},checkExistMirrorInRoom:function(a){return this.checkAllBlock(a,function(a){return 0!==a.getQans()},function(a,b,c){return 0!=c})},checkMirrors:function(a){for(var b=[],c=this.owner.board,d=0;d<c.excellmax-4;d++){var e=c.excell[d];if(isNaN(b[d])&&-1!==e.getQnum()&&0!==e.getQchar()){var f=c.searchLight(e.id,!this.checkOnly),g=c.excell[f.dest];if(1==a&&e.getQchar()!==g.getQchar()||2==a&&(e.getQnum()!==g.getQnum()||e.getQnum()!==f.cnt))return!1;b[d]=1,b[f.dest]=1}}return!0}},FailCode:{bkNoObj:["斜線の引かれていない部屋があります。","A room has no mirrors."],bkObjGe2:["斜線が複数引かれた部屋があります。","A room has plural mirrors."],pairedLetterNe:["光が同じ文字の場所へ到達しません。","Beam from a light doesn't reach one's pair."],pairedNumberNe:["光の反射回数が正しくありません。","The count of refrection is wrong."]}})}();